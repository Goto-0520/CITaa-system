# 第61回スポーツフェスティバル 申込管理システム

スポーツフェスティバルの参加申込を自動管理するGoogle Apps Scriptシステムです。

## システム概要

本システムは2つのスクリプトで構成されています。

| スクリプト | 設置場所 | 主な機能 |
|-----------|----------|----------|
| フォーム管理スクリプト | Googleフォーム | 定員管理・選択肢の自動更新・セクション分岐 |
| メール送信スクリプト | スプレッドシート | 確認メール自動送信・重複チェック・色付け |

## 対応競技一覧

| 競技 | 定員 |
|------|------|
| ⚽ フットサル | 15チーム |
| 🏀 バスケットボール | 10チーム |
| 🏸 バドミントン | 16チーム |
| 🏓 卓球 | 20チーム |
| 🥎 ソフトボール | 10チーム |
| 🎾 ソフトテニス | 12チーム |
| 🏐 ビーチバレー | 8チーム |
| 🔴 ドッジボール | 12チーム |
| 🎮 eスポーツ | 50チーム |

---

## セットアップ手順

### 1. Googleフォームの準備

#### 1.1 フォームの作成

1. Googleフォームを新規作成
2. 「競技」という文字を含む**複数選択式（ラジオボタン）の質問**を作成
3. 各競技について、以下の2種類のセクション（ページ区切り）を作成

#### 1.2 セクションの命名規則（重要）

各競技につき**2つのセクション**が必要です。タイトルは以下のキーワードを必ず含めてください。

**通常用セクション（申込受付中）**
```
〇〇に参加する方への質問です
```
例：「フットサルに参加する方への質問です」

**満員用セクション（定員到達時）**
```
〇〇の参加者が定員に達しました
```
例：「フットサルの参加者が定員に達しました」

#### 1.3 フォームとスプレッドシートの連携

1. フォームの「回答」タブを開く
2. スプレッドシートアイコンをクリック
3. 「新しいスプレッドシートを作成」を選択
4. シート名が「フォームの回答 1」になっていることを確認

---

### 2. フォーム管理スクリプトの設定

#### 2.1 スクリプトエディタを開く

1. Googleフォームの編集画面を開く
2. 右上の「︙」→「スクリプトエディタ」をクリック

#### 2.2 コードの貼り付け

1. デフォルトの `myFunction` を削除
2. `form_management.gs` の内容を全て貼り付け
3. 「保存」をクリック（Ctrl+S）

#### 2.3 トリガーの設定

1. スクリプトエディタで `createTrigger` 関数を実行
2. 初回実行時は権限の承認が必要
   - 「権限を確認」→ アカウント選択 → 「詳細」→「〇〇（安全ではないページ）に移動」→「許可」

#### 2.4 動作確認

1. `debugStatus` 関数を実行
2. 実行ログ（表示 → ログ）で以下を確認：
   - ✓ スプレッドシートが接続されている
   - ✓ 全競技のセクション（通常用・満員用）が検出されている

```
// 正常な場合の出力例
⚽フットサル: 通常=✓ 満員=✓
🏀バスケットボール: 通常=✓ 満員=✓
...
```

#### 2.5 セクション不足の確認

セクションが見つからない場合は `checkMissingSections` を実行して不足を特定できます。

---

### 3. メール送信スクリプトの設定

#### 3.1 スクリプトエディタを開く

1. フォーム回答が記録されるスプレッドシートを開く
2. 「拡張機能」→「Apps Script」をクリック

#### 3.2 コードの貼り付け

1. デフォルトの `myFunction` を削除
2. `email_notification.gs` の内容を全て貼り付け
3. 「保存」をクリック

#### 3.3 LINEオープンチャットURLの設定

`getSportUrls()` 関数内のURLを実際のオープンチャットURLに更新してください。

```javascript
function getSportUrls() {
  return {
    'フットサル': 'https://line.me/ti/g2/xxxxx',  // ← 実際のURLに変更
    'バスケットボール': 'https://line.me/ti/g2/xxxxx',
    // ...
  };
}
```

#### 3.4 トリガーの設定

1. `setupTriggers` 関数を実行
2. 権限の承認を行う（Gmail送信権限が必要）

#### 3.5 テスト送信

実際にメールを送信してテストする場合：

```javascript
// スクリプトエディタで実行
testEmailForRow(2);  // 2行目のデータでテスト送信
```

---

## スプレッドシートの列構成

メール送信スクリプトは以下の列構成を前提としています。

| 列 | 内容 |
|----|------|
| A列 | タイムスタンプ |
| B列 | メールアドレス |
| C列 | （任意） |
| D列 | 競技選択 |
| E列 | チーム名 |

列の順番が異なる場合は、スクリプト内の `rowData[1]`、`rowData[3]` などのインデックスを修正してください。

---

## 運用方法

### 定員状況の手動更新

申込状況を即座に反映したい場合：

1. フォームのスクリプトエディタを開く
2. `manualUpdate` 関数を実行

### 重複確認

スプレッドシート上で同じメールアドレス・チーム名の行が自動で色分けされます。

---

## トラブルシューティング

### セクションが検出されない

**原因**: セクションタイトルにキーワードが含まれていない

**解決策**:
1. `checkMissingSections` を実行して不足を確認
2. フォームのセクションタイトルを修正
   - 通常用：「〇〇に参加する方への質問」を含める
   - 満員用：「〇〇の参加者が定員に達しました」を含める

### メールが送信されない

**原因1**: トリガーが設定されていない
- `setupTriggers` を再実行

**原因2**: Gmail送信権限がない
- スクリプトを手動実行して権限を再承認

**原因3**: 列のインデックスがずれている
- スプレッドシートの列構成を確認し、スクリプトを修正

### 「フォームの回答 1」シートが見つからない

**原因**: シート名が異なる

**解決策**: `getTeamCounts` 関数内のシート名を実際の名前に変更

```javascript
const formSheet = ss.getSheetByName('実際のシート名');
```

---

## 関数一覧

### フォーム管理スクリプト

| 関数名 | 用途 |
|--------|------|
| `onFormSubmit` | フォーム送信時に自動実行 |
| `manualUpdate` | 手動でフォームを更新 |
| `debugStatus` | 現在の状態を確認 |
| `createTrigger` | トリガーを設定 |
| `checkMissingSections` | 不足セクションを確認 |

### メール送信スクリプト

| 関数名 | 用途 |
|--------|------|
| `onFormSubmit` | フォーム送信時にメール送信 |
| `onEdit` | セル編集時にメール送信 |
| `setupTriggers` | トリガーを設定 |
| `testEmailForRow(行番号)` | 指定行でテスト送信 |
| `applyColorCoding` | 重複を色付け |

---

## 注意事項

- 両スクリプトとも `onFormSubmit` 関数がありますが、**設置場所が異なります**（フォーム側・スプレッドシート側）
- 定員数を変更する場合は `SPORT_DATA` 配列の `limit` 値を修正してください
- メール送信には1日あたりの制限があります（無料アカウント: 100通/日）

---

## 連絡先

千葉工業大学 体育会本部 スポーツフェスティバル担当  
TEL: 047-478-0251  
e-mail: cit.taiiku.event@gmail.com