// ===== ã‚¹ãƒãƒ¼ãƒ„ãƒ•ã‚§ã‚¹ãƒ†ã‚£ãƒãƒ«ç”³è¾¼ãƒ•ã‚©ãƒ¼ãƒ ç®¡ç†ã‚¹ã‚¯ãƒªãƒ—ãƒˆ =====
// æ—¢å­˜ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã€Œã€‡ã€‡ã®å‚åŠ è€…ãŒå®šå“¡ã«é”ã—ã¾ã—ãŸã€ã€Œã€‡ã€‡ã«å‚åŠ ã™ã‚‹æ–¹ã¸ã®è³ªå•ã§ã™ã€ã«å¯¾å¿œ

// ===== ç«¶æŠ€ãƒ‡ãƒ¼ã‚¿å®šç¾© =====
const SPORT_DATA = [
  { name: 'ãƒ•ãƒƒãƒˆã‚µãƒ«', key: 'futsal', limit: 15, icon: 'âš½' },
  { name: 'ãƒã‚¹ã‚±ãƒƒãƒˆãƒœãƒ¼ãƒ«', key: 'basketball', limit: 10, icon: 'ğŸ€' },
  { name: 'ãƒãƒ‰ãƒŸãƒ³ãƒˆãƒ³', key: 'badminton', limit: 16, icon: 'ğŸ¸' },
  { name: 'å“çƒ', key: 'tabletennis', limit: 20, icon: 'ğŸ“' },
  { name: 'ã‚½ãƒ•ãƒˆãƒœãƒ¼ãƒ«', key: 'softball', limit: 10, icon: 'ğŸ¥' },
  { name: 'ã‚½ãƒ•ãƒˆãƒ†ãƒ‹ã‚¹', key: 'softtennis', limit: 12, icon: 'ğŸ¾' },
  { name: 'ãƒ“ãƒ¼ãƒãƒãƒ¬ãƒ¼', key: 'beachvolley', limit: 8, icon: 'ğŸ' },
  { name: 'ãƒ‰ãƒƒã‚¸ãƒœãƒ¼ãƒ«', key: 'dodgeball', limit: 12, icon: 'ğŸ”´' },
  { name: 'eã‚¹ãƒãƒ¼ãƒ„', key: 'esports', limit: 50, icon: 'ğŸ®' }
];

// ã‚»ã‚¯ã‚·ãƒ§ãƒ³è­˜åˆ¥ç”¨ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆæ—¢å­˜ã®ã‚¿ã‚¤ãƒˆãƒ«å½¢å¼ã«åˆã‚ã›ã‚‹ï¼‰
const SECTION_KEYWORD = {
  FULL: 'å®šå“¡ã«é”ã—ã¾ã—ãŸ',      // æº€å“¡ç”¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³
  OPEN: 'å‚åŠ ã™ã‚‹æ–¹ã¸ã®è³ªå•'     // é€šå¸¸ç”¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³
};

// ===== ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æ™‚ã«è‡ªå‹•å®Ÿè¡Œ =====
function onFormSubmit(e) {
  updateFormQuestions();
}

// ===== æ‰‹å‹•å®Ÿè¡Œç”¨ï¼šãƒ•ã‚©ãƒ¼ãƒ æ›´æ–° =====
function manualUpdate() {
  updateFormQuestions();
}

// ===== ãƒ¡ã‚¤ãƒ³å‡¦ç†ï¼šãƒ•ã‚©ãƒ¼ãƒ ã®è³ªå•ã¨åˆ†å²ã‚’æ›´æ–° =====
function updateFormQuestions() {
  const form = FormApp.getActiveForm();
  const counts = getTeamCounts();
  
  Logger.log('===== ãƒ•ã‚©ãƒ¼ãƒ æ›´æ–°é–‹å§‹ =====');
  Logger.log('ç¾åœ¨ã®ãƒãƒ¼ãƒ æ•°: ' + JSON.stringify(counts));
  
  // ç«¶æŠ€é¸æŠã®è³ªå•ã‚’å–å¾—
  const sportItem = findSportSelectionItem(form);
  if (!sportItem) {
    Logger.log('ã‚¨ãƒ©ãƒ¼: ç«¶æŠ€é¸æŠè³ªå•ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
    return;
  }
  
  // å„ç«¶æŠ€ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å–å¾—
  const sections = getAllSportSections(form);
  Logger.log('å–å¾—ã—ãŸã‚»ã‚¯ã‚·ãƒ§ãƒ³: ' + JSON.stringify(Object.keys(sections)));
  
  // é¸æŠè‚¢ã¨åˆ†å²ã‚’æ›´æ–°
  const newChoices = [];
  const fullSports = [];
  
  SPORT_DATA.forEach(sport => {
    const count = counts[sport.key];
    const isFull = count >= sport.limit;
    
    // é¸æŠè‚¢ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ä½œæˆ
    let choiceText;
    if (isFull) {
      choiceText = sport.icon + sport.name + 'ï¼ˆå®šå“¡ã«é”ã—ã¾ã—ãŸï¼‰';
      fullSports.push(sport.name);
    } else {
      choiceText = sport.icon + sport.name + 'ï¼ˆç”³è¾¼ä»¶æ•°ï¼š' + count + '/' + sport.limit + 'ï¼‰';
    }
    
    // åˆ†å²å…ˆã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ±ºå®š
    const targetSectionKey = sport.key + (isFull ? '_FULL' : '_OPEN');
    const targetSection = sections[targetSectionKey];
    
    if (targetSection) {
      // åˆ†å²ä»˜ãã®é¸æŠè‚¢ã‚’ä½œæˆ
      const choice = sportItem.createChoice(choiceText, targetSection);
      newChoices.push(choice);
      Logger.log(sport.name + ': ' + count + '/' + sport.limit + (isFull ? ' ã€æº€å“¡ã€‘' : '') + ' â†’ ' + targetSectionKey);
    } else {
      // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯åˆ†å²ãªã—ã§è¿½åŠ 
      Logger.log('è­¦å‘Š: ' + sport.name + 'ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆ' + targetSectionKey + 'ï¼‰');
      newChoices.push(sportItem.createChoice(choiceText));
    }
  });
  
  // é¸æŠè‚¢ã‚’æ›´æ–°
  sportItem.setChoices(newChoices);
  
  Logger.log('===== ãƒ•ã‚©ãƒ¼ãƒ æ›´æ–°å®Œäº† =====');
  Logger.log('æº€å“¡ã®ç«¶æŠ€: ' + (fullSports.length > 0 ? fullSports.join(', ') : 'ãªã—'));
}

// ===== ç«¶æŠ€é¸æŠã®è³ªå•ã‚’æ¢ã™ =====
function findSportSelectionItem(form) {
  const items = form.getItems();
  
  for (let i = 0; i < items.length; i++) {
    const item = items[i];
    if (item.getType() === FormApp.ItemType.MULTIPLE_CHOICE) {
      const title = item.getTitle();
      if (title.includes('ç«¶æŠ€')) {
        return item.asMultipleChoiceItem();
      }
    }
  }
  
  return null;
}

// ===== å…¨ç«¶æŠ€ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å–å¾— =====
function getAllSportSections(form) {
  const items = form.getItems();
  const sections = {};
  
  items.forEach(item => {
    if (item.getType() === FormApp.ItemType.PAGE_BREAK) {
      const pageBreak = item.asPageBreakItem();
      const title = pageBreak.getTitle();
      
      SPORT_DATA.forEach(sport => {
        // ã“ã®ç«¶æŠ€ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‹ãƒã‚§ãƒƒã‚¯
        if (title.includes(sport.name) || title.includes(sport.icon + sport.name)) {
          // æº€å“¡ç”¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³
          if (title.includes(SECTION_KEYWORD.FULL)) {
            sections[sport.key + '_FULL'] = pageBreak;
            Logger.log('ç™ºè¦‹ [æº€å“¡ç”¨]: ' + title);
          }
          // é€šå¸¸ç”¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³
          else if (title.includes(SECTION_KEYWORD.OPEN)) {
            sections[sport.key + '_OPEN'] = pageBreak;
            Logger.log('ç™ºè¦‹ [é€šå¸¸ç”¨]: ' + title);
          }
        }
      });
    }
  });
  
  return sections;
}

// ===== ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰ãƒãƒ¼ãƒ æ•°ã‚’å–å¾— =====
function getTeamCounts() {
  try {
    const form = FormApp.getActiveForm();
    const destinationId = form.getDestinationId();
    
    if (!destinationId) {
      Logger.log('è­¦å‘Š: ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãŒãƒªãƒ³ã‚¯ã•ã‚Œã¦ã„ã¾ã›ã‚“');
      return getDefaultCounts();
    }
    
    const ss = SpreadsheetApp.openById(destinationId);
    const formSheet = ss.getSheetByName('ãƒ•ã‚©ãƒ¼ãƒ ã®å›ç­” 1');
    
    if (!formSheet) {
      Logger.log('è­¦å‘Š:ã€Œãƒ•ã‚©ãƒ¼ãƒ ã®å›ç­” 1ã€ã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      return getDefaultCounts();
    }
    
    const data = formSheet.getDataRange().getValues();
    
    if (data.length < 2) {
      Logger.log('å›ç­”ãŒã¾ã ã‚ã‚Šã¾ã›ã‚“');
      return getDefaultCounts();
    }
    
    const headers = data[0];
    
    // ç«¶æŠ€é¸æŠåˆ—ã‚’æ¢ã™
    let sportColumnIndex = -1;
    for (let i = 0; i < headers.length; i++) {
      if (headers[i].includes('ç«¶æŠ€')) {
        sportColumnIndex = i;
        break;
      }
    }
    
    if (sportColumnIndex === -1) {
      Logger.log('è­¦å‘Š: ç«¶æŠ€é¸æŠåˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      return getDefaultCounts();
    }
    
    const counts = getDefaultCounts();
    
    // ç«¶æŠ€åã¨ã‚­ãƒ¼ã®ãƒãƒƒãƒ”ãƒ³ã‚°
    const sportMap = {};
    SPORT_DATA.forEach(sport => {
      sportMap[sport.name] = sport.key;
    });
    // ç•¥ç§°ã‚‚è¿½åŠ 
    sportMap['ãƒã‚¹ã‚±'] = 'basketball';
    
    // å›ç­”ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
    for (let i = 1; i < data.length; i++) {
      const response = data[i][sportColumnIndex];
      if (response) {
        // è¤‡æ•°é¸æŠã‚„åŒºåˆ‡ã‚Šæ–‡å­—ã«å¯¾å¿œ
        const sports = response.split(/\n|ã€|,/).map(s => s.trim());
        sports.forEach(sport => {
          // è£…é£¾æ–‡å­—ã‚’é™¤å»ã—ã¦ç«¶æŠ€åã‚’æŠ½å‡º
          let cleanSport = sport.replace(/ï¼ˆ.*?ï¼‰/g, '').trim();
          cleanSport = cleanSport.replace(/âš½|ğŸ€|ğŸ¸|ğŸ“|ğŸ¥|ğŸ¾|ğŸ|ğŸ”´|ğŸ®/g, '').trim();
          
          if (sportMap[cleanSport]) {
            counts[sportMap[cleanSport]]++;
          }
        });
      }
    }
    
    Logger.log('ã‚«ã‚¦ãƒ³ãƒˆçµæœ: ' + JSON.stringify(counts));
    return counts;
    
  } catch(e) {
    Logger.log('ã‚¨ãƒ©ãƒ¼: ' + e.toString());
    return getDefaultCounts();
  }
}

// ===== ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚«ã‚¦ãƒ³ãƒˆ =====
function getDefaultCounts() {
  const counts = {};
  SPORT_DATA.forEach(sport => {
    counts[sport.key] = 0;
  });
  return counts;
}

// ===== ãƒ‡ãƒãƒƒã‚°ç”¨ï¼šç¾åœ¨ã®çŠ¶æ…‹ã‚’ç¢ºèª =====
function debugStatus() {
  const form = FormApp.getActiveForm();
  
  Logger.log('===== ãƒ‡ãƒãƒƒã‚°æƒ…å ± =====');
  Logger.log('ãƒ•ã‚©ãƒ¼ãƒ å: ' + form.getTitle());
  
  // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆæ¥ç¶šç¢ºèª
  const destinationId = form.getDestinationId();
  if (destinationId) {
    Logger.log('âœ“ ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆID: ' + destinationId);
    const ss = SpreadsheetApp.openById(destinationId);
    Logger.log('âœ“ ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆå: ' + ss.getName());
  } else {
    Logger.log('âœ— ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆ: æœªæ¥ç¶š');
  }
  
  // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ä¸€è¦§
  Logger.log('\n--- ã‚»ã‚¯ã‚·ãƒ§ãƒ³ä¸€è¦§ ---');
  const items = form.getItems();
  let sectionCount = 0;
  items.forEach((item, idx) => {
    if (item.getType() === FormApp.ItemType.PAGE_BREAK) {
      const pb = item.asPageBreakItem();
      const title = pb.getTitle();
      let type = '';
      if (title.includes(SECTION_KEYWORD.FULL)) type = ' [æº€å“¡ç”¨]';
      else if (title.includes(SECTION_KEYWORD.OPEN)) type = ' [é€šå¸¸ç”¨]';
      Logger.log('ã‚»ã‚¯ã‚·ãƒ§ãƒ³' + (++sectionCount) + type + ': ' + title);
    }
  });
  
  // ã‚»ã‚¯ã‚·ãƒ§ãƒ³å–å¾—ãƒ†ã‚¹ãƒˆ
  Logger.log('\n--- ã‚»ã‚¯ã‚·ãƒ§ãƒ³å–å¾—ãƒ†ã‚¹ãƒˆ ---');
  const sections = getAllSportSections(form);
  SPORT_DATA.forEach(sport => {
    const hasOpen = sections[sport.key + '_OPEN'] ? 'âœ“' : 'âœ—';
    const hasFull = sections[sport.key + '_FULL'] ? 'âœ“' : 'âœ—';
    Logger.log(sport.icon + sport.name + ': é€šå¸¸=' + hasOpen + ' æº€å“¡=' + hasFull);
  });
  
  // ç¾åœ¨ã®ãƒãƒ¼ãƒ æ•°
  Logger.log('\n--- ç¾åœ¨ã®ãƒãƒ¼ãƒ æ•° ---');
  const counts = getTeamCounts();
  SPORT_DATA.forEach(sport => {
    const count = counts[sport.key];
    const status = count >= sport.limit ? 'ã€æº€å“¡ã€‘' : '';
    Logger.log(sport.icon + sport.name + ': ' + count + '/' + sport.limit + ' ' + status);
  });
}

// ===== ãƒˆãƒªã‚¬ãƒ¼è¨­å®š =====
function createTrigger() {
  // æ—¢å­˜ã®ãƒˆãƒªã‚¬ãƒ¼ã‚’å‰Šé™¤
  const triggers = ScriptApp.getProjectTriggers();
  triggers.forEach(trigger => {
    if (trigger.getHandlerFunction() === 'onFormSubmit') {
      ScriptApp.deleteTrigger(trigger);
    }
  });
  
  // æ–°ã—ã„ãƒˆãƒªã‚¬ãƒ¼ã‚’ä½œæˆ
  ScriptApp.newTrigger('onFormSubmit')
    .forForm(FormApp.getActiveForm())
    .onFormSubmit()
    .create();
  
  Logger.log('âœ“ ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ãƒˆãƒªã‚¬ãƒ¼ã‚’ä½œæˆã—ã¾ã—ãŸ');
}

// ===== ã‚»ã‚¯ã‚·ãƒ§ãƒ³ä¸è¶³ãƒã‚§ãƒƒã‚¯ =====
function checkMissingSections() {
  const form = FormApp.getActiveForm();
  const sections = getAllSportSections(form);
  
  Logger.log('===== ã‚»ã‚¯ã‚·ãƒ§ãƒ³ä¸è¶³ãƒã‚§ãƒƒã‚¯ =====');
  
  const missing = [];
  SPORT_DATA.forEach(sport => {
    if (!sections[sport.key + '_OPEN']) {
      missing.push(sport.name + ' [é€šå¸¸ç”¨] - ã‚¿ã‚¤ãƒˆãƒ«ã«ã€Œ' + sport.name + 'ã€ã¨ã€Œ' + SECTION_KEYWORD.OPEN + 'ã€ã‚’å«ã‚€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒå¿…è¦');
    }
    if (!sections[sport.key + '_FULL']) {
      missing.push(sport.name + ' [æº€å“¡ç”¨] - ã‚¿ã‚¤ãƒˆãƒ«ã«ã€Œ' + sport.name + 'ã€ã¨ã€Œ' + SECTION_KEYWORD.FULL + 'ã€ã‚’å«ã‚€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒå¿…è¦');
    }
  });
  
  if (missing.length === 0) {
    Logger.log('âœ“ å…¨ã¦ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒæƒã£ã¦ã„ã¾ã™ï¼');
  } else {
    Logger.log('âœ— ä¸è¶³ã—ã¦ã„ã‚‹ã‚»ã‚¯ã‚·ãƒ§ãƒ³:');
    missing.forEach(m => Logger.log('  - ' + m));
  }
}