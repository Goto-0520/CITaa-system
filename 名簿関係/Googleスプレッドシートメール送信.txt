// ğŸ“Œ å›£ä½“åè¨­å®šï¼ˆã“ã“ã ã‘å¤‰æ›´ã™ã‚Œã°OKï¼‰
const CLUB_NAME = 'åˆæ°—é“éƒ¨';

// ğŸ“Œ æœ€çµ‚ç‰ˆï¼šOCRå¤±æ•—æ™‚ã‚‚ãƒ¡ãƒ¼ãƒ«é€ä¿¡ + é‡è¤‡è€…å°‚ç”¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ + å‡¦ç†æ¸ˆã¿ã‚¹ã‚­ãƒƒãƒ—
function onFormSubmit(e) {
  try {
    console.log('=== ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‡¦ç†é–‹å§‹ ===');
    
    const sheet = SpreadsheetApp.getActiveSheet();
    const lastRow = sheet.getLastRow();
    
    console.log('å‡¦ç†å¯¾è±¡è¡Œ:', lastRow);
    
    // ãƒ‡ãƒ¼ã‚¿å–å¾—
    const newRowData = sheet.getRange(lastRow, 1, 1, 11).getValues()[0];
    const newEmail = newRowData[1];        // Båˆ—: ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
    const newClub = CLUB_NAME;             // å›£ä½“åï¼ˆå®šæ•°ã‹ã‚‰å–å¾—ï¼‰
    const newStudentId = newRowData[4];    // Eåˆ—: å­¦ç”Ÿç•ªå·
    const newName = newRowData[5];         // Fåˆ—: æ°å
    const studentCardUrl = newRowData[9];  // Jåˆ—: å­¦ç”Ÿè¨¼ç”»åƒURL
    
    console.log('å–å¾—ãƒ‡ãƒ¼ã‚¿:', {
      email: newEmail,
      club: newClub,
      studentId: newStudentId,
      name: newName,
      imageUrl: studentCardUrl ? 'ç”»åƒã‚ã‚Š' : 'ç”»åƒãªã—'
    });
    
    let hasValidationError = false;
    let validationResults = [];
    let ocrFailed = false;
    
    // ğŸ” å­¦ç”Ÿè¨¼ã®Drive OCRå‡¦ç†
    let ocrStudentId = null;
    if (studentCardUrl && studentCardUrl.trim() !== '') {
      console.log('Drive OCRå‡¦ç†é–‹å§‹...');
      
      const fileReady = waitForFileReady(studentCardUrl, 3);
      if (!fileReady) {
        console.warn('âš ï¸ ãƒ•ã‚¡ã‚¤ãƒ«ã®æº–å‚™ãŒç¢ºèªã§ãã¾ã›ã‚“ã§ã—ãŸ');
      }
      
      ocrStudentId = processStudentCardWithRetry(studentCardUrl);
      
      if (ocrStudentId) {
        console.log('âœ… OCRæˆåŠŸ - å­¦ç”Ÿç•ªå·:', ocrStudentId);
        sheet.getRange(lastRow, 11).setValue(ocrStudentId);
        
        const consistencyResult = checkStudentIdConsistencyAlpha(newStudentId, ocrStudentId);
        if (!consistencyResult.isConsistent) {
          console.log('âš ï¸ å­¦ç”Ÿç•ªå·ä¸ä¸€è‡´ - Kåˆ—ã‚’èµ¤æ–‡å­—ã«ã—ã¦ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã—ã¾ã™');
          sheet.getRange(lastRow, 11).setFontColor('#FF0000');
          validationResults.push('å­¦ç”Ÿç•ªå·ä¸ä¸€è‡´ï¼ˆKåˆ—ã‚’èµ¤æ–‡å­—ã§è¨˜éŒ²ãƒ»ãƒ¡ãƒ¼ãƒ«é€ä¿¡ï¼‰');
        }
      } else {
        console.log('âŒ OCRå‡¦ç†å¤±æ•— - ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã¯å®Ÿè¡Œã—ã¾ã™');
        sheet.getRange(lastRow, 11)
          .setValue('OCRå‡¦ç†å¤±æ•—')
          .setFontColor('#FF0000');
        ocrFailed = true;
        validationResults.push('å­¦ç”Ÿç•ªå·OCRå‡¦ç†å¤±æ•—ï¼ˆãƒ¡ãƒ¼ãƒ«é€ä¿¡ã¯å®Ÿè¡Œï¼‰');
      }
    } else {
      console.log('â„¹ï¸ å­¦ç”Ÿè¨¼ç”»åƒãªã— - OCRå‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—');
      validationResults.push('å­¦ç”Ÿè¨¼ç”»åƒãŒæä¾›ã•ã‚Œã¦ã„ã¾ã›ã‚“');
    }
    
    // ğŸ“§ ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹æ¤œè¨¼
    const emailValidation = checkEmailContainsStudentIdImproved(newEmail, newStudentId);
    if (!emailValidation.isValid) {
      console.log('âš ï¸ ãƒ¡ãƒ¼ãƒ«æ¤œè¨¼ã‚¨ãƒ©ãƒ¼:', emailValidation.reason);
      sheet.getRange(lastRow, 1, 1, 11).setBackground('#ffff99');
      hasValidationError = true;
      validationResults.push('ãƒ¡ãƒ¼ãƒ«æ¤œè¨¼ã‚¨ãƒ©ãƒ¼: ' + emailValidation.reason);
    } else {
      console.log('âœ… ãƒ¡ãƒ¼ãƒ«æ¤œè¨¼OK:', emailValidation.reason);
    }
    
    // ğŸ” é‡è¤‡ãƒã‚§ãƒƒã‚¯
    const duplicateCheck = checkDuplicatesAndColor(sheet, newClub, newName, lastRow);
    
    // ğŸ“¤ ãƒ¡ãƒ¼ãƒ«é€ä¿¡åˆ¤å®š
    if (duplicateCheck.hasDuplicates) {
      // é‡è¤‡è€…ã«ã¯å°‚ç”¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
      console.log('âš ï¸ é‡è¤‡æ¤œå‡º - å°‚ç”¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡');
      const mailResult = sendDuplicateEmail(newClub, newEmail, newStudentId, newName);
      if (mailResult.success) {
        console.log('âœ… é‡è¤‡è€…ãƒ¡ãƒ¼ãƒ«é€ä¿¡æˆåŠŸ');
        sheet.getRange(lastRow, 1, 1, 11).setBackground('#FF0000');
      } else {
        console.log('âŒ é‡è¤‡è€…ãƒ¡ãƒ¼ãƒ«é€ä¿¡å¤±æ•—:', mailResult.error);
        sheet.getRange(lastRow, 1, 1, 11).setBackground('#DDA0DD');
      }
    } else if (!hasValidationError || ocrFailed) {
      // é€šå¸¸ãƒ¡ãƒ¼ãƒ«é€ä¿¡ï¼ˆOCRå¤±æ•—æ™‚ã‚‚é€ä¿¡ï¼‰
      console.log('âœ… ãƒ¡ãƒ¼ãƒ«é€ä¿¡é–‹å§‹ï¼ˆæ¤œè¨¼OK ã¾ãŸã¯ OCRå¤±æ•—ã®ã¿ï¼‰');
      const mailResult = sendPersonalEmail(newClub, newEmail, newStudentId, newName);
      if (mailResult.success) {
        console.log('âœ… ãƒ¡ãƒ¼ãƒ«é€ä¿¡æˆåŠŸ');
        sheet.getRange(lastRow, 1, 1, 11).setBackground('#90EE90');
      } else {
        console.log('âŒ ãƒ¡ãƒ¼ãƒ«é€ä¿¡å¤±æ•—:', mailResult.error);
        sheet.getRange(lastRow, 1, 1, 11).setBackground('#DDA0DD');
      }
    } else {
      console.log('âš ï¸ æ¤œè¨¼ã‚¨ãƒ©ãƒ¼ã‚ã‚Š - ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚’ã‚¹ã‚­ãƒƒãƒ—:', validationResults);
    }
    
    console.log('=== ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‡¦ç†å®Œäº† ===');
    
  } catch (error) {
    console.error('âŒ ãƒ¡ã‚¤ãƒ³å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ:', error);
    try {
      const sheet = SpreadsheetApp.getActiveSheet();
      const lastRow = sheet.getLastRow();
      sheet.getRange(lastRow, 1, 1, 11).setBackground('#FF6B6B');
    } catch (colorError) {
      console.error('âŒ ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºå‡¦ç†ã§ã‚‚å¤±æ•—:', colorError);
    }
  }
}

// ========================================
// æ‰‹å‹•æ“ä½œæ©Ÿèƒ½1: é¸æŠè¡Œã‚’å®Œå…¨å†å‡¦ç†ï¼ˆå‡¦ç†æ¸ˆã¿ã‚¹ã‚­ãƒƒãƒ—å¯¾å¿œï¼‰
// ========================================

function processSelectedRow() {
  try {
    const sheet = SpreadsheetApp.getActiveSheet();
    const activeRange = sheet.getActiveRange();
    const startRow = activeRange.getRow();
    const numRows = activeRange.getNumRows();
    
    if (startRow === 1) {
      Browser.msgBox('è­¦å‘Š', 'ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã¯é¸æŠã§ãã¾ã›ã‚“ã€‚', Browser.Buttons.OK);
      return;
    }
    
    // å‡¦ç†å¯¾è±¡è¡Œã®ãƒªã‚¹ãƒˆä½œæˆï¼ˆå‡¦ç†æ¸ˆã¿ã‚¹ã‚­ãƒƒãƒ—ï¼‰
    const targetRows = [];
    const skippedRows = [];
    
    for (let i = 0; i < numRows; i++) {
      const row = startRow + i;
      if (row > 1) {
        const bgColor = sheet.getRange(row, 1).getBackground();
        if (bgColor === '#90ee90') { // è–„ç·‘è‰²ã¯å‡¦ç†æ¸ˆã¿
          skippedRows.push(row);
          console.log(`è¡Œ${row}: å‡¦ç†æ¸ˆã¿ï¼ˆè–„ç·‘è‰²ï¼‰ã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—`);
        } else {
          targetRows.push(row);
        }
      }
    }
    
    if (targetRows.length === 0) {
      const message = skippedRows.length > 0 
        ? `ã™ã¹ã¦å‡¦ç†æ¸ˆã¿ã§ã™ã€‚\n\nã‚¹ã‚­ãƒƒãƒ—ã—ãŸè¡Œ: ${skippedRows.length}ä»¶`
        : 'å‡¦ç†å¯¾è±¡ã®è¡ŒãŒã‚ã‚Šã¾ã›ã‚“ã€‚';
      Browser.msgBox('æƒ…å ±', message, Browser.Buttons.OK);
      return;
    }
    
    console.log(`=== ${targetRows.length}è¡Œã®ä¸€æ‹¬å†å‡¦ç†é–‹å§‹ ===`);
    console.log('å‡¦ç†å¯¾è±¡è¡Œ:', targetRows);
    console.log('ã‚¹ã‚­ãƒƒãƒ—ã—ãŸè¡Œ:', skippedRows);
    
    let successCount = 0;
    let errorCount = 0;
    const results = [];
    
    // å„è¡Œã‚’å‡¦ç†
    for (let i = 0; i < targetRows.length; i++) {
      const row = targetRows[i];
      
      try {
        console.log(`\n--- è¡Œ${row}ã®å‡¦ç†é–‹å§‹ (${i + 1}/${targetRows.length}) ---`);
        
        const rowData = sheet.getRange(row, 1, 1, 11).getValues()[0];
        const email = rowData[1];
        const club = CLUB_NAME;
        const studentId = rowData[4];
        const name = rowData[5];
        const studentCardUrl = rowData[9];
        
        console.log(`æ°å: ${name}, å­¦ç±ç•ªå·: ${studentId}`);
        
        if (!email || !email.trim() || !studentId || !name) {
          console.log('âŒ å¿…é ˆæƒ…å ±ä¸è¶³ - ã‚¹ã‚­ãƒƒãƒ—');
          sheet.getRange(row, 1, 1, 11).setBackground('#FF6B6B');
          results.push(`è¡Œ${row}: ã‚¹ã‚­ãƒƒãƒ—ï¼ˆå¿…é ˆæƒ…å ±ä¸è¶³ï¼‰`);
          errorCount++;
          continue;
        }
        
        // å‡¦ç†ä¸­ã®è¡¨ç¤º
        sheet.getRange(row, 1, 1, 11).setBackground('#E0E0E0');
        SpreadsheetApp.flush();
        
        let hasValidationError = false;
        let validationResults = [];
        let ocrFailed = false;
        
        // ğŸ” OCRå‡¦ç†
        let ocrStudentId = null;
        if (studentCardUrl && studentCardUrl.trim() !== '') {
          console.log('OCRå‡¦ç†é–‹å§‹...');
          
          const fileReady = waitForFileReady(studentCardUrl, 3);
          if (!fileReady) {
            console.warn('âš ï¸ ãƒ•ã‚¡ã‚¤ãƒ«ã®æº–å‚™ãŒç¢ºèªã§ãã¾ã›ã‚“ã§ã—ãŸ');
          }
          
          ocrStudentId = processStudentCardWithRetry(studentCardUrl, 2);
          
          if (ocrStudentId) {
            console.log(`âœ… OCRæˆåŠŸ: ${ocrStudentId}`);
            sheet.getRange(row, 11).setValue(ocrStudentId);
            
            const consistencyResult = checkStudentIdConsistencyAlpha(studentId, ocrStudentId);
            if (!consistencyResult.isConsistent) {
              console.log('âš ï¸ å­¦ç”Ÿç•ªå·ä¸ä¸€è‡´ - Kåˆ—ã‚’èµ¤æ–‡å­—åŒ–');
              sheet.getRange(row, 11).setFontColor('#FF0000');
              validationResults.push('å­¦ç”Ÿç•ªå·ä¸ä¸€è‡´');
            }
          } else {
            console.log('âŒ OCRå‡¦ç†å¤±æ•— - ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã¯å®Ÿè¡Œ');
            sheet.getRange(row, 11)
              .setValue('OCRå‡¦ç†å¤±æ•—')
              .setFontColor('#FF0000');
            ocrFailed = true;
            validationResults.push('OCRå¤±æ•—');
          }
        }
        
        // ğŸ“§ ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹æ¤œè¨¼
        const emailValidation = checkEmailContainsStudentIdImproved(email, studentId);
        if (!emailValidation.isValid) {
          console.log('âš ï¸ ãƒ¡ãƒ¼ãƒ«æ¤œè¨¼ã‚¨ãƒ©ãƒ¼');
          sheet.getRange(row, 1, 1, 11).setBackground('#ffff99');
          hasValidationError = true;
          validationResults.push('ãƒ¡ãƒ¼ãƒ«æ¤œè¨¼ã‚¨ãƒ©ãƒ¼');
        }
        
        // ğŸ” é‡è¤‡ãƒã‚§ãƒƒã‚¯
        const duplicateCheck = checkDuplicatesAndColor(sheet, club, name, row);
        
        // ğŸ“¤ ãƒ¡ãƒ¼ãƒ«é€ä¿¡åˆ¤å®š
        if (duplicateCheck.hasDuplicates) {
          console.log('âš ï¸ é‡è¤‡æ¤œå‡º - å°‚ç”¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡');
          const mailResult = sendDuplicateEmail(club, email, studentId, name);
          
          if (mailResult.success) {
            console.log('âœ… é‡è¤‡è€…ãƒ¡ãƒ¼ãƒ«é€ä¿¡æˆåŠŸ');
            sheet.getRange(row, 1, 1, 11).setBackground('#FF0000');
            results.push(`è¡Œ${row}: é‡è¤‡è€…ãƒ¡ãƒ¼ãƒ«é€ä¿¡æˆåŠŸ (${name})`);
            successCount++;
          } else {
            console.log('âŒ é‡è¤‡è€…ãƒ¡ãƒ¼ãƒ«é€ä¿¡å¤±æ•—');
            sheet.getRange(row, 1, 1, 11).setBackground('#DDA0DD');
            results.push(`è¡Œ${row}: é‡è¤‡è€…ãƒ¡ãƒ¼ãƒ«é€ä¿¡å¤±æ•— (${name})`);
            errorCount++;
          }
        } else if (!hasValidationError || ocrFailed) {
          console.log('ãƒ¡ãƒ¼ãƒ«é€ä¿¡é–‹å§‹');
          const mailResult = sendPersonalEmail(club, email, studentId, name);
          
          if (mailResult.success) {
            console.log('âœ… ãƒ¡ãƒ¼ãƒ«é€ä¿¡æˆåŠŸ');
            sheet.getRange(row, 1, 1, 11).setBackground('#90EE90');
            results.push(`è¡Œ${row}: æˆåŠŸ (${name})`);
            successCount++;
          } else {
            console.log('âŒ ãƒ¡ãƒ¼ãƒ«é€ä¿¡å¤±æ•—');
            sheet.getRange(row, 1, 1, 11).setBackground('#DDA0DD');
            results.push(`è¡Œ${row}: ãƒ¡ãƒ¼ãƒ«é€ä¿¡å¤±æ•— (${name})`);
            errorCount++;
          }
        } else {
          console.log('âš ï¸ æ¤œè¨¼ã‚¨ãƒ©ãƒ¼ã‚ã‚Š - ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚¹ã‚­ãƒƒãƒ—');
          results.push(`è¡Œ${row}: æ¤œè¨¼ã‚¨ãƒ©ãƒ¼ (${name}) - ${validationResults.join(', ')}`);
          errorCount++;
        }
        
      } catch (rowError) {
        console.error(`âŒ è¡Œ${row}å‡¦ç†ã‚¨ãƒ©ãƒ¼:`, rowError);
        sheet.getRange(row, 1, 1, 11).setBackground('#FF6B6B');
        results.push(`è¡Œ${row}: ã‚¨ãƒ©ãƒ¼`);
        errorCount++;
      }
    }
    
    console.log(`\n=== ä¸€æ‹¬å‡¦ç†å®Œäº† ===`);
    console.log(`æˆåŠŸ: ${successCount}ä»¶, ã‚¨ãƒ©ãƒ¼: ${errorCount}ä»¶, ã‚¹ã‚­ãƒƒãƒ—: ${skippedRows.length}ä»¶`);
    
    // çµæœè¡¨ç¤º
    const resultMessage = `å‡¦ç†å®Œäº†\n\n` +
      `é¸æŠ: ${numRows}è¡Œ\n` +
      `å‡¦ç†æ¸ˆã¿ã‚¹ã‚­ãƒƒãƒ—: ${skippedRows.length}ä»¶\n` +
      `å‡¦ç†å¯¾è±¡: ${targetRows.length}è¡Œ\n` +
      `æˆåŠŸ: ${successCount}ä»¶\n` +
      `ã‚¨ãƒ©ãƒ¼: ${errorCount}ä»¶\n\n` +
      `è©³ç´°:\n${results.join('\n')}`;
    
    Browser.msgBox('å‡¦ç†å®Œäº†', resultMessage, Browser.Buttons.OK);
    
  } catch (error) {
    console.error('âŒ ã‚¨ãƒ©ãƒ¼:', error);
    Browser.msgBox('ã‚¨ãƒ©ãƒ¼', error.toString(), Browser.Buttons.OK);
  }
}

// ========================================
// æ‰‹å‹•æ“ä½œæ©Ÿèƒ½2: é¸æŠè¡Œã‚’ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã®ã¿ï¼ˆè¤‡æ•°è¡Œå¯¾å¿œãƒ»å‡¦ç†æ¸ˆã¿ã‚¹ã‚­ãƒƒãƒ—ï¼‰
// ========================================

function sendEmailForSelectedRow() {
  try {
    const sheet = SpreadsheetApp.getActiveSheet();
    const activeRange = sheet.getActiveRange();
    const startRow = activeRange.getRow();
    const numRows = activeRange.getNumRows();
    
    if (startRow === 1) {
      Browser.msgBox('è­¦å‘Š', 'ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã¯é¸æŠã§ãã¾ã›ã‚“ã€‚', Browser.Buttons.OK);
      return;
    }
    
    // å‡¦ç†å¯¾è±¡è¡Œã®ãƒªã‚¹ãƒˆä½œæˆï¼ˆå‡¦ç†æ¸ˆã¿ã‚¹ã‚­ãƒƒãƒ—ï¼‰
    const targetRows = [];
    const skippedRows = [];
    
    for (let i = 0; i < numRows; i++) {
      const row = startRow + i;
      if (row > 1) {
        const bgColor = sheet.getRange(row, 1).getBackground();
        if (bgColor === '#90ee90') {
          skippedRows.push(row);
          console.log(`è¡Œ${row}: å‡¦ç†æ¸ˆã¿ï¼ˆè–„ç·‘è‰²ï¼‰ã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—`);
        } else {
          targetRows.push(row);
        }
      }
    }
    
    if (targetRows.length === 0) {
      const message = skippedRows.length > 0 
        ? `ã™ã¹ã¦å‡¦ç†æ¸ˆã¿ã§ã™ã€‚\n\nã‚¹ã‚­ãƒƒãƒ—ã—ãŸè¡Œ: ${skippedRows.length}ä»¶`
        : 'å‡¦ç†å¯¾è±¡ã®è¡ŒãŒã‚ã‚Šã¾ã›ã‚“ã€‚';
      Browser.msgBox('æƒ…å ±', message, Browser.Buttons.OK);
      return;
    }
    
    console.log(`=== ${targetRows.length}è¡Œã¸ã®ãƒ¡ãƒ¼ãƒ«é€ä¿¡å‡¦ç† ===`);
    
    // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
    const ui = SpreadsheetApp.getUi();
    const response = ui.alert(
      'ãƒ¡ãƒ¼ãƒ«ä¸€æ‹¬é€ä¿¡ç¢ºèª',
      `ä»¥ä¸‹ã®å†…å®¹ã§ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã™ã‹ï¼Ÿ\n` +
      `ï¼ˆæ¤œè¨¼å‡¦ç†ã¯ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¾ã™ï¼‰\n\n` +
      `å‡¦ç†å¯¾è±¡: ${targetRows.length}è¡Œ\n` +
      `å‡¦ç†æ¸ˆã¿ã‚¹ã‚­ãƒƒãƒ—: ${skippedRows.length}è¡Œ`,
      ui.ButtonSet.YES_NO
    );
    
    if (response !== ui.Button.YES) {
      console.log('ãƒ¡ãƒ¼ãƒ«é€ä¿¡ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ');
      return;
    }
    
    let successCount = 0;
    let errorCount = 0;
    const results = [];
    
    // å„è¡Œã‚’å‡¦ç†
    for (let i = 0; i < targetRows.length; i++) {
      const row = targetRows[i];
      
      try {
        console.log(`\n--- è¡Œ${row}ã®ãƒ¡ãƒ¼ãƒ«é€ä¿¡ (${i + 1}/${targetRows.length}) ---`);
        
        const rowData = sheet.getRange(row, 1, 1, 11).getValues()[0];
        const club = CLUB_NAME;
        const email = rowData[1];
        const studentId = rowData[4];
        const name = rowData[5];
        
        console.log(`å®›å…ˆ: ${email}, æ°å: ${name}`);
        
        if (!email || !email.trim() || !studentId || !name) {
          console.log('âŒ å¿…é ˆæƒ…å ±ä¸è¶³ - ã‚¹ã‚­ãƒƒãƒ—');
          results.push(`è¡Œ${row}: ã‚¹ã‚­ãƒƒãƒ—ï¼ˆå¿…é ˆæƒ…å ±ä¸è¶³ï¼‰`);
          errorCount++;
          continue;
        }
        
        // é€ä¿¡ä¸­ã®è¡¨ç¤º
        sheet.getRange(row, 1, 1, 11).setBackground('#E0E0E0');
        SpreadsheetApp.flush();
        
        // é‡è¤‡ãƒã‚§ãƒƒã‚¯
        const duplicateCheck = checkDuplicatesAndColor(sheet, club, name, row);
        
        let mailResult;
        if (duplicateCheck.hasDuplicates) {
          console.log('âš ï¸ é‡è¤‡æ¤œå‡º - å°‚ç”¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡');
          mailResult = sendDuplicateEmail(club, email, studentId, name);
          
          if (mailResult.success) {
            sheet.getRange(row, 1, 1, 11).setBackground('#FF0000');
            results.push(`è¡Œ${row}: é‡è¤‡è€…ãƒ¡ãƒ¼ãƒ«é€ä¿¡æˆåŠŸ (${name})`);
            successCount++;
          } else {
            sheet.getRange(row, 1, 1, 11).setBackground('#DDA0DD');
            results.push(`è¡Œ${row}: é‡è¤‡è€…ãƒ¡ãƒ¼ãƒ«é€ä¿¡å¤±æ•— (${name})`);
            errorCount++;
          }
        } else {
          mailResult = sendPersonalEmail(club, email, studentId, name);
          
          if (mailResult.success) {
            console.log('âœ… ãƒ¡ãƒ¼ãƒ«é€ä¿¡æˆåŠŸ');
            sheet.getRange(row, 1, 1, 11).setBackground('#90EE90');
            results.push(`è¡Œ${row}: æˆåŠŸ (${name})`);
            successCount++;
          } else {
            console.log('âŒ ãƒ¡ãƒ¼ãƒ«é€ä¿¡å¤±æ•—');
            sheet.getRange(row, 1, 1, 11).setBackground('#DDA0DD');
            results.push(`è¡Œ${row}: å¤±æ•— (${name})`);
            errorCount++;
          }
        }
        
      } catch (rowError) {
        console.error(`âŒ è¡Œ${row}ã‚¨ãƒ©ãƒ¼:`, rowError);
        sheet.getRange(row, 1, 1, 11).setBackground('#FF6B6B');
        results.push(`è¡Œ${row}: ã‚¨ãƒ©ãƒ¼`);
        errorCount++;
      }
    }
    
    console.log(`\n=== ãƒ¡ãƒ¼ãƒ«é€ä¿¡å®Œäº† ===`);
    console.log(`æˆåŠŸ: ${successCount}ä»¶, ã‚¨ãƒ©ãƒ¼: ${errorCount}ä»¶, ã‚¹ã‚­ãƒƒãƒ—: ${skippedRows.length}ä»¶`);
    
    // çµæœè¡¨ç¤º
    const resultMessage = `ãƒ¡ãƒ¼ãƒ«é€ä¿¡å®Œäº†\n\n` +
      `é¸æŠ: ${numRows}è¡Œ\n` +
      `å‡¦ç†æ¸ˆã¿ã‚¹ã‚­ãƒƒãƒ—: ${skippedRows.length}ä»¶\n` +
      `é€ä¿¡å¯¾è±¡: ${targetRows.length}è¡Œ\n` +
      `æˆåŠŸ: ${successCount}ä»¶\n` +
      `ã‚¨ãƒ©ãƒ¼: ${errorCount}ä»¶\n\n` +
      `è©³ç´°:\n${results.join('\n')}`;
    
    Browser.msgBox('é€ä¿¡å®Œäº†', resultMessage, Browser.Buttons.OK);
    
  } catch (error) {
    console.error('âŒ ã‚¨ãƒ©ãƒ¼:', error);
    Browser.msgBox('ã‚¨ãƒ©ãƒ¼', error.toString(), Browser.Buttons.OK);
  }
}

// ========================================
// ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¨­å®š
// ========================================

function onOpen() {
  const ui = SpreadsheetApp.getUi();
  ui.createMenu('ğŸ“ å­¦ç”Ÿè¨¼å‡¦ç†')
    .addItem('ğŸ”„ é¸æŠè¡Œã‚’å†å‡¦ç†ï¼ˆå‡¦ç†æ¸ˆã¿ã‚¹ã‚­ãƒƒãƒ—ï¼‰', 'processSelectedRow')
    .addItem('ğŸ“§ é¸æŠè¡Œã‚’ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã®ã¿ï¼ˆå‡¦ç†æ¸ˆã¿ã‚¹ã‚­ãƒƒãƒ—ï¼‰', 'sendEmailForSelectedRow')
    .addSeparator()
    .addItem('ğŸ”§ ã‚·ã‚¹ãƒ†ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—', 'setupCompleteSystem')
    .addToUi();
  
  console.log('âœ… ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
}

// ========================================
// ã‚·ã‚¹ãƒ†ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
// ========================================

function setupCompleteSystem() {
  console.log('=== æœ€çµ‚ç‰ˆã‚·ã‚¹ãƒ†ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—é–‹å§‹ ===');
  
  try {
    DriveApp.getRootFolder().getName();
    console.log('âœ… DriveAppæ¨©é™ OK');
    
    const aboutInfo = Drive.About.get();
    console.log('âœ… Advanced Drive Service OK');
    
    const tempFolder = getOrCreateTempFolder();
    console.log('âœ… ä¸€æ™‚ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆ OK');
    
    createFormSubmitTrigger();
    console.log('âœ… ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ãƒˆãƒªã‚¬ãƒ¼è¨­å®š OK');
    
    createCleanupTrigger();
    console.log('âœ… ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ãƒˆãƒªã‚¬ãƒ¼è¨­å®š OK');
    
    console.log('');
    console.log('ğŸ‰ === ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº† === ğŸ‰');
    console.log(`âœ… ${CLUB_NAME}ç”¨ã‚·ã‚¹ãƒ†ãƒ ãŒæ­£å¸¸ã«è¨­å®šã•ã‚Œã¾ã—ãŸï¼`);
    console.log('');
    console.log('ğŸ“‹ æ©Ÿèƒ½ä¸€è¦§:');
    console.log('1. âœ… OCRå¤±æ•—æ™‚ã‚‚ãƒ¡ãƒ¼ãƒ«é€ä¿¡ï¼ˆKåˆ—ã«èµ¤æ–‡å­—ã§è¨˜éŒ²ï¼‰');
    console.log('2. âœ… é‡è¤‡è€…ã«ã¯å°‚ç”¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡');
    console.log('3. âœ… å‡¦ç†æ¸ˆã¿è¡Œï¼ˆè–„ç·‘è‰²ï¼‰ã¯è‡ªå‹•ã‚¹ã‚­ãƒƒãƒ—');
    console.log('4. âœ… è¤‡æ•°è¡Œã®ä¸€æ‹¬å‡¦ç†ã«å¯¾å¿œ');
    console.log(`5. âœ… å›£ä½“åã‚’ã€Œ${CLUB_NAME}ã€ã§çµ±ä¸€`);
    
    Browser.msgBox(
      'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†',
      `âœ… ${CLUB_NAME}ç”¨ã‚·ã‚¹ãƒ†ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸï¼\n\n` +
      'æ©Ÿèƒ½ä¸€è¦§:\n' +
      'â€¢ OCRå¤±æ•—æ™‚ã‚‚ãƒ¡ãƒ¼ãƒ«é€ä¿¡\n' +
      'â€¢ é‡è¤‡è€…ã«ã¯å°‚ç”¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸\n' +
      'â€¢ å‡¦ç†æ¸ˆã¿è¡Œã¯è‡ªå‹•ã‚¹ã‚­ãƒƒãƒ—\n' +
      'â€¢ è¤‡æ•°è¡Œã®ä¸€æ‹¬å‡¦ç†å¯¾å¿œ\n' +
      `â€¢ å›£ä½“åã€Œ${CLUB_NAME}ã€ã§çµ±ä¸€`,
      Browser.Buttons.OK
    );
    
    return true;
    
  } catch (error) {
    console.error('âŒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼:', error.toString());
    
    if (error.toString().includes('Drive')) {
      console.error('ğŸ”§ å¯¾å‡¦æ³•:');
      console.error('1. Apps Scriptã‚¨ãƒ‡ã‚£ã‚¿ã®å·¦ã‚µã‚¤ãƒ‰ãƒãƒ¼ã€Œã‚µãƒ¼ãƒ“ã‚¹ã€ã‚’ã‚¯ãƒªãƒƒã‚¯');
      console.error('2. ã€Œ+ã€ãƒœã‚¿ãƒ³ã§ã€ŒDrive APIã€ã‚’è¿½åŠ ');
      console.error('3. è­˜åˆ¥å­ã¯ã€ŒDriveã€ã®ã¾ã¾ä¿å­˜');
      
      Browser.msgBox(
        'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼',
        'âŒ Drive APIã®è¨­å®šãŒå¿…è¦ã§ã™ã€‚\n\n' +
        'å¯¾å‡¦æ³•:\n' +
        '1. å·¦ã‚µã‚¤ãƒ‰ãƒãƒ¼ã€Œã‚µãƒ¼ãƒ“ã‚¹ã€ã‚’ã‚¯ãƒªãƒƒã‚¯\n' +
        '2. ã€Œ+ã€ãƒœã‚¿ãƒ³ã§ã€ŒDrive APIã€ã‚’è¿½åŠ \n' +
        '3. è­˜åˆ¥å­ã¯ã€ŒDriveã€ã®ã¾ã¾ä¿å­˜\n' +
        '4. å†åº¦ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’å®Ÿè¡Œ',
        Browser.Buttons.OK
      );
    }
    
    return false;
  }
}

function createFormSubmitTrigger() {
  try {
    const triggers = ScriptApp.getProjectTriggers();
    triggers.forEach(trigger => {
      if (trigger.getHandlerFunction() === 'onFormSubmit') {
        ScriptApp.deleteTrigger(trigger);
      }
    });
    
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    ScriptApp.newTrigger('onFormSubmit')
      .forSpreadsheet(ss)
      .onFormSubmit()
      .create();
    
    console.log('âœ… ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ãƒˆãƒªã‚¬ãƒ¼ã‚’ä½œæˆã—ã¾ã—ãŸ');
    return true;
    
  } catch (error) {
    console.error('âŒ ãƒˆãƒªã‚¬ãƒ¼ä½œæˆã‚¨ãƒ©ãƒ¼:', error);
    return false;
  }
}

function createCleanupTrigger() {
  try {
    const triggers = ScriptApp.getProjectTriggers();
    triggers.forEach(trigger => {
      if (trigger.getHandlerFunction() === 'cleanupTempFolder') {
        ScriptApp.deleteTrigger(trigger);
      }
    });
    
    ScriptApp.newTrigger('cleanupTempFolder')
      .timeBased()
      .everyDays(1)
      .atHour(2)
      .create();
    
    console.log('âœ… å®šæœŸã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ãƒˆãƒªã‚¬ãƒ¼ã‚’ä½œæˆã—ã¾ã—ãŸï¼ˆæ¯æ—¥åˆå‰2æ™‚ï¼‰');
    return true;
    
  } catch (error) {
    console.error('âŒ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ãƒˆãƒªã‚¬ãƒ¼ä½œæˆã‚¨ãƒ©ãƒ¼:', error);
    return false;
  }
}

function cleanupTempFolder() {
  try {
    console.log('=== ä¸€æ™‚ãƒ•ã‚©ãƒ«ãƒ€ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—é–‹å§‹ ===');
    
    const folderName = 'OCR_Temp_' + new Date().getFullYear();
    const folders = DriveApp.getFoldersByName(folderName);
    
    if (!folders.hasNext()) {
      console.log('â„¹ï¸ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å¯¾è±¡ãƒ•ã‚©ãƒ«ãƒ€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      return;
    }
    
    const folder = folders.next();
    const files = folder.getFiles();
    let deletedCount = 0;
    
    const oneHourAgo = new Date(Date.now() - 60 * 60 * 1000);
    
    while (files.hasNext()) {
      const file = files.next();
      const fileDate = file.getDateCreated();
      
      if (fileDate < oneHourAgo) {
        try {
          file.setTrashed(true);
          deletedCount++;
          console.log('å‰Šé™¤:', file.getName());
        } catch (deleteError) {
          console.warn('å‰Šé™¤å¤±æ•—:', file.getName());
        }
      }
    }
    
    console.log(`âœ… ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†: ${deletedCount}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤`);
    
  } catch (error) {
    console.error('âŒ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼:', error);
  }
}

// ========================================
// ãƒ•ã‚¡ã‚¤ãƒ«å¾…æ©Ÿå‡¦ç†
// ========================================

function waitForFileReady(imageUrl, maxRetries = 3) {
  const fileId = extractFileIdFromUrl(imageUrl);
  if (!fileId) {
    console.error('âŒ ãƒ•ã‚¡ã‚¤ãƒ«IDæŠ½å‡ºå¤±æ•—');
    return false;
  }
  
  for (let attempt = 1; attempt <= maxRetries; attempt++) {
    try {
      console.log(`ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ã‚¯ã‚»ã‚¹è©¦è¡Œ ${attempt}/${maxRetries}...`);
      
      const file = DriveApp.getFileById(fileId);
      const fileName = file.getName();
      const fileSize = file.getSize();
      
      console.log(`âœ… ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ã‚¯ã‚»ã‚¹æˆåŠŸ: ${fileName} (${fileSize} bytes)`);
      
      if (fileSize > 0) {
        return true;
      } else {
        console.warn(`âš ï¸ ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒ0 - å†è©¦è¡Œã—ã¾ã™ (${attempt}/${maxRetries})`);
      }
      
    } catch (error) {
      console.warn(`âš ï¸ ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ã‚¯ã‚»ã‚¹å¤±æ•— (è©¦è¡Œ ${attempt}/${maxRetries}):`, error.toString());
      
      if (attempt < maxRetries) {
        const waitTime = attempt * 2000;
        console.log(`â³ ${waitTime/1000}ç§’å¾…æ©Ÿã—ã¦ã‹ã‚‰å†è©¦è¡Œ...`);
        Utilities.sleep(waitTime);
      }
    }
  }
  
  console.error('âŒ ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ã‚¯ã‚»ã‚¹æœ€çµ‚å¤±æ•—');
  return false;
}

function processStudentCardWithRetry(imageUrl, maxRetries = 2) {
  for (let attempt = 1; attempt <= maxRetries; attempt++) {
    try {
      console.log(`OCRå‡¦ç†è©¦è¡Œ ${attempt}/${maxRetries}...`);
      
      const result = processStudentCardDriveOCR_StudentIdOnly(imageUrl);
      
      if (result) {
        console.log(`âœ… OCRæˆåŠŸ (è©¦è¡Œ ${attempt}/${maxRetries}):`, result);
        return result;
      } else {
        console.warn(`âš ï¸ OCRçµæœãªã— (è©¦è¡Œ ${attempt}/${maxRetries})`);
        
        if (attempt < maxRetries) {
          const waitTime = 3000;
          console.log(`â³ ${waitTime/1000}ç§’å¾…æ©Ÿã—ã¦ã‹ã‚‰å†è©¦è¡Œ...`);
          Utilities.sleep(waitTime);
        }
      }
      
    } catch (error) {
      console.error(`âŒ OCRå‡¦ç†ã‚¨ãƒ©ãƒ¼ (è©¦è¡Œ ${attempt}/${maxRetries}):`, error);
      
      if (attempt < maxRetries) {
        const waitTime = 3000;
        console.log(`â³ ${waitTime/1000}ç§’å¾…æ©Ÿã—ã¦ã‹ã‚‰å†è©¦è¡Œ...`);
        Utilities.sleep(waitTime);
      }
    }
  }
  
  console.error('âŒ OCRå‡¦ç†æœ€çµ‚å¤±æ•—ï¼ˆå…¨ãƒªãƒˆãƒ©ã‚¤çµ‚äº†ï¼‰');
  return null;
}

// ========================================
// ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹æ¤œè¨¼ï¼ˆå¤§æ–‡å­—å°æ–‡å­—ç„¡è¦–ï¼‰
// ========================================

function checkEmailContainsStudentIdImproved(email, studentId) {
  try {
    if (!email || !studentId) {
      return {
        isValid: false,
        reason: 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¾ãŸã¯å­¦ç±ç•ªå·ãŒç©ºã§ã™'
      };
    }
    
    const emailLower = email.toString().toLowerCase().trim();
    const studentIdLower = studentId.toString().toLowerCase().trim();
    
    console.log('ãƒ¡ãƒ¼ãƒ«æ¤œè¨¼:', {
      email: emailLower,
      studentId: studentIdLower
    });
    
    // ãƒ‘ã‚¿ãƒ¼ãƒ³1: å®Œå…¨ä¸€è‡´ãƒã‚§ãƒƒã‚¯ï¼ˆå¤§æ–‡å­—å°æ–‡å­—ç„¡è¦–ï¼‰
    if (emailLower.includes(studentIdLower)) {
      return {
        isValid: true,
        reason: `å­¦ç±ç•ªå·ãŒå®Œå…¨ä¸€è‡´: ${studentIdLower}`
      };
    }
    
    // ãƒ‘ã‚¿ãƒ¼ãƒ³2: ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆæ··åœ¨å½¢å¼ã®å ´åˆã€æ•°å­—éƒ¨åˆ†ã§ã‚‚ãƒã‚§ãƒƒã‚¯
    if (/[a-z]/i.test(studentIdLower)) {
      const numericPart = studentIdLower.replace(/[^0-9]/g, '');
      
      if (numericPart.length >= 4 && emailLower.includes(numericPart)) {
        return {
          isValid: true,
          reason: `æ•°å­—éƒ¨åˆ†ãŒä¸€è‡´: ${numericPart} (å…ƒ: ${studentIdLower})`
        };
      }
      
      const emailNumericPart = emailLower.replace(/[^0-9]/g, '');
      if (emailNumericPart.includes(numericPart) && numericPart.length >= 4) {
        return {
          isValid: true,
          reason: `æ•°å­—éƒ¨åˆ†ãŒé–“æ¥ä¸€è‡´: ${numericPart} (ãƒ¡ãƒ¼ãƒ«æ•°å­—éƒ¨åˆ†: ${emailNumericPart})`
        };
      }
    }
    
    // ãƒ‘ã‚¿ãƒ¼ãƒ³3: å­¦ç±ç•ªå·ã®ä¸€éƒ¨ï¼ˆå‰6æ¡ãªã©ï¼‰ãŒãƒ¡ãƒ¼ãƒ«ã«å«ã¾ã‚Œã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    if (studentIdLower.length >= 6) {
      const prefix6 = studentIdLower.substring(0, 6);
      const prefix5 = studentIdLower.substring(0, 5);
      
      if (emailLower.includes(prefix6)) {
        return {
          isValid: true,
          reason: `å­¦ç±ç•ªå·å‰6æ¡ãŒä¸€è‡´: ${prefix6}`
        };
      }
      
      if (emailLower.includes(prefix5)) {
        return {
          isValid: true,
          reason: `å­¦ç±ç•ªå·å‰5æ¡ãŒä¸€è‡´: ${prefix5}`
        };
      }
    }
    
    return {
      isValid: false,
      reason: `å­¦ç±ç•ªå· ${studentIdLower} ãŒãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ ${emailLower} ã«å«ã¾ã‚Œã¦ã„ã¾ã›ã‚“`
    };
    
  } catch (error) {
    console.error('âŒ ãƒ¡ãƒ¼ãƒ«æ¤œè¨¼ã‚¨ãƒ©ãƒ¼:', error);
    return {
      isValid: false,
      reason: 'ãƒ¡ãƒ¼ãƒ«æ¤œè¨¼å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.toString()
    };
  }
}

// ========================================
// OCRå‡¦ç†ï¼ˆHEICå¯¾å¿œå¼·åŒ–ç‰ˆï¼‰
// ========================================

function processStudentCardDriveOCR_StudentIdOnly(imageUrl) {
  try {
    console.log('Drive OCRå‡¦ç†é–‹å§‹ - URL:', imageUrl);
    
    const fileId = extractFileIdFromUrl(imageUrl);
    if (!fileId) {
      console.error('âŒ ãƒ•ã‚¡ã‚¤ãƒ«IDæŠ½å‡ºå¤±æ•—:', imageUrl);
      return null;
    }
    
    console.log('ãƒ•ã‚¡ã‚¤ãƒ«ID:', fileId);
    
    let file;
    try {
      file = DriveApp.getFileById(fileId);
      console.log('âœ… ãƒ•ã‚¡ã‚¤ãƒ«å–å¾—æˆåŠŸ:', file.getName());
    } catch (permissionError) {
      console.error('âŒ ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ã‚¯ã‚»ã‚¹ã‚¨ãƒ©ãƒ¼:', permissionError);
      return null;
    }
    
    let blob = file.getBlob();
    const contentType = blob.getContentType();
    const fileName = file.getName().toLowerCase();
    console.log('âœ… ãƒ•ã‚¡ã‚¤ãƒ«å–å¾—æˆåŠŸ, ã‚¿ã‚¤ãƒ—:', contentType, 'ãƒ•ã‚¡ã‚¤ãƒ«å:', fileName);
    
    // HEICå½¢å¼ã®æ¤œå‡ºã¨å¤‰æ›å‡¦ç†
    const isHeic = contentType === 'image/heic' || 
                   contentType === 'image/heif' || 
                   fileName.endsWith('.heic') || 
                   fileName.endsWith('.heif');
    
    if (isHeic) {
      console.log('âš ï¸ HEICå½¢å¼ã‚’æ¤œå‡º - å¤‰æ›å‡¦ç†ã‚’å®Ÿè¡Œã—ã¾ã™...');
      const convertedBlob = convertHeicForOCR(file, blob);
      if (convertedBlob) {
        console.log('âœ… HEICå¤‰æ›æˆåŠŸ');
        blob = convertedBlob;
      } else {
        console.error('âŒ HEICå¤‰æ›å¤±æ•— - å…ƒã®å½¢å¼ã§å‡¦ç†ã‚’ç¶™ç¶šã—ã¾ã™ï¼ˆå¤±æ•—ã™ã‚‹å¯èƒ½æ€§ãŒé«˜ã„ï¼‰');
      }
    }
    
    const ocrText = performDriveOCR(blob, file.getName());
    
    if (ocrText && ocrText.trim() !== '') {
      console.log('âœ… Drive OCRæ¤œå‡ºãƒ†ã‚­ã‚¹ãƒˆé•·:', ocrText.length);
      console.log('OCRæŠ½å‡ºãƒ†ã‚­ã‚¹ãƒˆ:', ocrText.substring(0, 200));
      return extractStudentIdOnlyAlpha(ocrText);
    } else {
      console.log('âŒ Drive OCRã§ãƒ†ã‚­ã‚¹ãƒˆãŒæ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ');
      return null;
    }
    
  } catch (error) {
    console.error('âŒ Drive OCRå‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
    return null;
  }
}

// ========================================
// HEICå¤‰æ›å‡¦ç†
// ========================================

function convertHeicForOCR(file, heicBlob) {
  try {
    console.log('ğŸ”„ HEICå¤‰æ›å‡¦ç†é–‹å§‹...');
    
    const tempFolder = getOrCreateTempFolder();
    const timestamp = new Date().getTime();
    
    console.log('ğŸ“¤ å¤‰æ›ç”¨ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆä¸­...');
    
    try {
      console.log('ğŸ”§ Drive APIã§ã®ç›´æ¥å¤‰æ›ã‚’è©¦è¡Œ...');
      
      const resource = {
        title: `HEIC_CONVERT_${timestamp}`,
        parents: [{id: tempFolder.getId()}],
        mimeType: 'image/jpeg'
      };
      
      const convertedFile = Drive.Files.insert(
        resource,
        heicBlob,
        {
          convert: true,
          ocr: false
        }
      );
      
      if (convertedFile && convertedFile.id) {
        console.log('âœ… Drive APIã§ã®å¤‰æ›æˆåŠŸ:', convertedFile.id);
        const convertedBlob = DriveApp.getFileById(convertedFile.id).getBlob();
        
        try {
          DriveApp.getFileById(convertedFile.id).setTrashed(true);
        } catch (e) {
          console.warn('âš ï¸ å¤‰æ›ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å¤±æ•—');
        }
        
        return convertedBlob;
      }
      
    } catch (conversionError) {
      console.warn('âš ï¸ Drive APIå¤‰æ›å¤±æ•—:', conversionError.toString());
    }
    
    console.log('âš ï¸ HEICè‡ªå‹•å¤‰æ›ã«å¤±æ•—ã—ã¾ã—ãŸ');
    console.log('ğŸ’¡ æ¨å¥¨: ãƒ¦ãƒ¼ã‚¶ãƒ¼å´ã§JPEG/PNGã«å¤‰æ›ã—ã¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ã‚‚ã‚‰ã†');
    
    return null;
    
  } catch (error) {
    console.error('âŒ HEICå¤‰æ›ã‚¨ãƒ©ãƒ¼:', error);
    return null;
  }
}

function performDriveOCR(blob, originalFileName) {
  let tempDocId = null;
  
  try {
    const tempFolder = getOrCreateTempFolder();
    const timestamp = new Date().getTime();
    const tempFileName = `OCR_${originalFileName}_${timestamp}`;
    
    console.log('Drive OCRå®Ÿè¡Œé–‹å§‹ - ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«å:', tempFileName);
    
    const resource = {
      title: tempFileName,
      parents: [{ id: tempFolder.getId() }],
    };
    
    const options = {
      ocr: true,
      ocrLanguage: 'ja',
      uploadType: 'multipart'
    };
    
    console.log('â³ OCRå‡¦ç†ä¸­...');
    const doc = Drive.Files.insert(resource, blob, options);
    
    if (!doc || !doc.id) {
      console.error('âŒ Drive OCRå®Ÿè¡Œå¤±æ•—');
      return null;
    }
    
    tempDocId = doc.id;
    console.log('âœ… OCRãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä½œæˆæˆåŠŸ:', tempDocId);
    
    Utilities.sleep(5000);
    
    try {
      const ocrDoc = DocumentApp.openById(tempDocId);
      const ocrText = ocrDoc.getBody().getText();
      console.log('âœ… OCRçµæœãƒ†ã‚­ã‚¹ãƒˆå–å¾—æˆåŠŸ - æ–‡å­—æ•°:', ocrText.length);
      return ocrText;
    } catch (docError) {
      console.warn('âš ï¸ DocumentAppã§ã®å–å¾—å¤±æ•— - Drive API ã‚’è©¦è¡Œ');
      const exportedContent = Drive.Files.export(tempDocId, 'text/plain');
      return exportedContent.getContentText();
    }
    
  } catch (error) {
    console.error('âŒ Drive OCRå®Ÿè¡Œã‚¨ãƒ©ãƒ¼:', error);
    return null;
  } finally {
    if (tempDocId) {
      try {
        DriveApp.getFileById(tempDocId).setTrashed(true);
        console.log('âœ… ä¸€æ™‚OCRãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤å®Œäº†');
      } catch (deleteError) {
        console.warn('âš ï¸ ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤ã«å¤±æ•—:', deleteError);
      }
    }
  }
}

function extractStudentIdOnlyAlpha(text) {
  try {
    console.log('å­¦ç”Ÿç•ªå·æŠ½å‡ºé–‹å§‹ - ãƒ†ã‚­ã‚¹ãƒˆé•·:', text.length);
    
    let normalizedText = text
      .replace(/[ï¼-ï¼™]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0))
      .replace(/[ã€€\s]+/g, ' ')
      .replace(/\r\n/g, '\n')
      .trim();
    
    normalizedText = preprocessTextForDriveOCRAlpha(normalizedText);
    
    const studentId = extractStudentIdWithPatternsAlpha(normalizedText);
    
    if (studentId) {
      console.log('âœ… å­¦ç”Ÿç•ªå·æŠ½å‡ºæˆåŠŸ:', studentId);
      return studentId;
    }
    
    console.log('âŒ å­¦ç”Ÿç•ªå·æŠ½å‡ºå¤±æ•—');
    return null;
    
  } catch (error) {
    console.error('âŒ å­¦ç”Ÿç•ªå·æŠ½å‡ºã‚¨ãƒ©ãƒ¼:', error);
    return null;
  }
}

function preprocessTextForDriveOCRAlpha(text) {
  return text
    .replace(/(\d)\s+(\d)/g, '$1$2')
    .replace(/([A-Za-z])\s+(\d)/g, '$1$2')
    .replace(/(\d)\s+([A-Za-z])/g, '$1$2')
    .replace(/å­¦\s*ç”Ÿ\s*ç•ª\s*å·/g, 'å­¦ç”Ÿç•ªå·');
}

function extractStudentIdWithPatternsAlpha(text) {
  const explicitPatterns = [
    /å­¦ç”Ÿç•ªå·[\sï¼š:]*([A-Za-z0-9]{6,8})/i,
    /å­¦ç±ç•ªå·[\sï¼š:]*([A-Za-z0-9]{6,8})/i,
    /ç•ªå·[\sï¼š:]*([A-Za-z0-9]{6,8})/i
  ];
  
  for (const pattern of explicitPatterns) {
    const match = text.match(pattern);
    if (match && match[1] && isValidStudentIdAlpha(match[1])) {
      return match[1].toUpperCase();
    }
  }
  
  const citPatterns = [
    /\b(\d{2}[A-Za-z]\d{4})\b/g,
    /\b(\d{7})\b/g,
    /\b([A-Za-z]\d{6})\b/g
  ];
  
  for (const pattern of citPatterns) {
    const matches = [...text.matchAll(pattern)];
    for (const match of matches) {
      if (isValidStudentIdAlpha(match[1])) {
        return match[1].toUpperCase();
      }
    }
  }
  
  return null;
}

function isValidStudentIdAlpha(idStr) {
  if (!idStr || idStr.length < 6 || idStr.length > 8) return false;
  if (/^(.)\1+$/.test(idStr)) return false;
  
  const patterns = [
    {
      regex: /^(\d{2})([A-Za-z])(\d{4})$/,
      check: (match) => {
        const year = parseInt(match[1]);
        const currentYear = new Date().getFullYear() % 100;
        return year >= (currentYear - 20) && year <= (currentYear + 2);
      }
    },
    {
      regex: /^(\d{7})$/,
      check: (match) => {
        const year = parseInt(match[1].substring(0, 2));
        const currentYear = new Date().getFullYear() % 100;
        return year >= (currentYear - 20) && year <= (currentYear + 2);
      }
    }
  ];
  
  for (const pattern of patterns) {
    const match = idStr.match(pattern.regex);
    if (match && pattern.check(match)) {
      return true;
    }
  }
  
  return false;
}

function checkStudentIdConsistencyAlpha(inputStudentId, ocrStudentId) {
  try {
    const inputIdClean = inputStudentId.toString().trim().toUpperCase();
    const ocrIdClean = ocrStudentId.toString().trim().toUpperCase();
    
    const isConsistent = inputIdClean === ocrIdClean;
    
    if (!isConsistent) {
      const similarity = calculateSimilarity(inputIdClean, ocrIdClean);
      if (similarity >= 0.8) {
        return {
          isConsistent: true,
          details: `é¡ä¼¼ä¸€è‡´ï¼ˆé¡ä¼¼åº¦:${(similarity * 100).toFixed(1)}%ï¼‰`
        };
      }
      return {
        isConsistent: false,
        details: `ä¸ä¸€è‡´ï¼ˆå…¥åŠ›:${inputIdClean} vs OCR:${ocrIdClean}ï¼‰`
      };
    }
    
    return { isConsistent: true, details: 'å®Œå…¨ä¸€è‡´' };
    
  } catch (error) {
    console.error('âŒ æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', error);
    return { isConsistent: false, details: 'ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ' };
  }
}

function calculateSimilarity(str1, str2) {
  const len1 = str1.length;
  const len2 = str2.length;
  const matrix = [];

  if (len1 === 0) return len2 === 0 ? 1 : 0;
  if (len2 === 0) return 0;

  for (let i = 0; i <= len2; i++) matrix[i] = [i];
  for (let j = 0; j <= len1; j++) matrix[0][j] = j;

  for (let i = 1; i <= len2; i++) {
    for (let j = 1; j <= len1; j++) {
      if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
        matrix[i][j] = matrix[i - 1][j - 1];
      } else {
        matrix[i][j] = Math.min(
          matrix[i - 1][j - 1] + 1,
          matrix[i][j - 1] + 1,
          matrix[i - 1][j] + 1
        );
      }
    }
  }

  const distance = matrix[len2][len1];
  const maxLen = Math.max(len1, len2);
  return (maxLen - distance) / maxLen;
}

function checkDuplicatesAndColor(sheet, targetClub, targetName, currentRow) {
  try {
    const dataRange = sheet.getRange(2, 1, sheet.getLastRow() - 1, 11);
    const data = dataRange.getValues();
    const duplicateRows = [];
    
    for (let i = 0; i < data.length; i++) {
      const rowName = data[i][5]; // Fåˆ—: æ°å
      if (rowName === targetName) {
        duplicateRows.push(i + 2);
      }
    }
    
    if (duplicateRows.length > 1) {
      duplicateRows.forEach(rowNum => {
        sheet.getRange(rowNum, 1, 1, 11).setBackground('#FF0000');
      });
    }
    
    return {
      hasDuplicates: duplicateRows.length > 1,
      duplicateRows: duplicateRows
    };
    
  } catch (error) {
    console.error('âŒ é‡è¤‡ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', error);
    return { hasDuplicates: false, duplicateRows: [] };
  }
}

// ========================================
// ãƒ¡ãƒ¼ãƒ«é€ä¿¡ï¼ˆ2ç¨®é¡ï¼‰
// ========================================

function sendPersonalEmail(club, studentEmail, studentId, name) {
  try {
    if (!studentEmail) {
      return { success: false, error: 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãªã—' };
    }
    
    const subject = `ã€ä½“è‚²ä¼šæœ¬éƒ¨ã€‘å…¥éƒ¨å®Œäº†ã®ãŠçŸ¥ã‚‰ã› - ${club}`;
    const body = `${name} æ§˜

ãŠç–²ã‚Œæ§˜ã§ã™ã€‚
ä½“è‚²ä¼šæœ¬éƒ¨ç·¨é›†éƒ¨é•·ã§ã™ã€‚

ã“ã®åº¦ã¯ãƒ•ã‚©ãƒ¼ãƒ ã®ã”å›ç­”ã®ã»ã©ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚
ä»¥ä¸‹ã®å†…å®¹ã§å…¥éƒ¨å®Œäº†ã„ãŸã—ã¾ã™ã€‚

ã€ãƒ•ã‚©ãƒ¼ãƒ å›ç­”å†…å®¹ã€‘
å…¥éƒ¨å¸Œæœ›å›£ä½“ï¼š${club}
å­¦ç”Ÿç•ªå·ã€€ã€€ï¼š${studentId}
æ°åã€€ã€€ã€€ã€€ï¼š${name}

ä½•ã‹ã”ä¸æ˜ç‚¹ç­‰ã”ã–ã„ã¾ã—ãŸã‚‰ã”é€£çµ¡ãã ã•ã„ã€‚

ä»¥ä¸Šã€å¤±ç¤¼ã„ãŸã—ã¾ã™ã€‚

*********************************************
åƒè‘‰å·¥æ¥­å¤§å­¦ã€€ä½“è‚²ä¼šæœ¬éƒ¨
TELï¼š047-478-0251
e-mailï¼šcit.taiiku@gmail.com
HPï¼šhttps://sites.google.com/view/cittaiiku2021hp
*********************************************`;
    
    GmailApp.sendEmail(studentEmail, subject, body);
    console.log('âœ… ãƒ¡ãƒ¼ãƒ«é€ä¿¡æˆåŠŸ:', studentEmail);
    
    // é€ä¿¡æ¸ˆã¿ãƒ¡ãƒ¼ãƒ«ã‚’ã‚´ãƒŸç®±ã«ç§»å‹•ï¼ˆå®¹é‡ç¯€ç´„ï¼‰
    moveSentEmailToTrash(subject);
    
    return { success: true, error: null };
    
  } catch (error) {
    console.error('âŒ ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
    return { success: false, error: error.toString() };
  }
}

function sendDuplicateEmail(club, studentEmail, studentId, name) {
  try {
    if (!studentEmail) {
      return { success: false, error: 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãªã—' };
    }
    
    const subject = `ã€ä½“è‚²ä¼šæœ¬éƒ¨ã€‘å…¥éƒ¨å®Œäº†ã®ãŠçŸ¥ã‚‰ã›ï¼ˆå†é€ï¼‰ - ${club}`;
    const body = `${name} æ§˜

ãŠç–²ã‚Œæ§˜ã§ã™ã€‚
ä½“è‚²ä¼šæœ¬éƒ¨ç·¨é›†éƒ¨é•·ã§ã™ã€‚

è¡¨é¡Œã®ä»¶ã«ã¤ãã¾ã—ã¦ã€ä»¥ä¸‹ã®å†…å®¹ã§å…¥éƒ¨å®Œäº†ã„ãŸã—ã¦ãŠã‚Šã¾ã™ã€‚
ã“ã®ãƒ¡ãƒ¼ãƒ«ä»¥é™ã€ãƒ•ã‚©ãƒ¼ãƒ å›ç­”ã¯ãŠæ§ãˆãã ã•ã„ã€‚

ã€ãƒ•ã‚©ãƒ¼ãƒ å›ç­”å†…å®¹ã€‘
å…¥éƒ¨å¸Œæœ›å›£ä½“ï¼š${club}
å­¦ç”Ÿç•ªå·ã€€ã€€ï¼š${studentId}
æ°åã€€ã€€ã€€ã€€ï¼š${name}

ä½•ã‹ã”ä¸æ˜ç‚¹ç­‰ã”ã–ã„ã¾ã—ãŸã‚‰ã”é€£çµ¡ãã ã•ã„ã€‚

ä»¥ä¸Šã€å¤±ç¤¼ã„ãŸã—ã¾ã™ã€‚

*********************************************
åƒè‘‰å·¥æ¥­å¤§å­¦ã€€ä½“è‚²ä¼šæœ¬éƒ¨
TELï¼š047-478-0251
e-mailï¼šcit.taiiku@gmail.com
HPï¼šhttps://sites.google.com/view/cittaiiku2021hp
*********************************************`;
    
    GmailApp.sendEmail(studentEmail, subject, body);
    console.log('âœ… é‡è¤‡è€…ãƒ¡ãƒ¼ãƒ«é€ä¿¡æˆåŠŸ:', studentEmail);
    
    // é€ä¿¡æ¸ˆã¿ãƒ¡ãƒ¼ãƒ«ã‚’ã‚´ãƒŸç®±ã«ç§»å‹•ï¼ˆå®¹é‡ç¯€ç´„ï¼‰
    moveSentEmailToTrash(subject);
    
    return { success: true, error: null };
    
  } catch (error) {
    console.error('âŒ é‡è¤‡è€…ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
    return { success: false, error: error.toString() };
  }
}

// ========================================
// é€ä¿¡æ¸ˆã¿ãƒ¡ãƒ¼ãƒ«ã‚’ã‚´ãƒŸç®±ã«ç§»å‹•ï¼ˆå®¹é‡ç¯€ç´„ï¼‰
// ========================================

function moveSentEmailToTrash(subject) {
  try {
    // é€ä¿¡ã‹ã‚‰æ•°ç§’å¾…ã£ã¦ã‹ã‚‰ã‚´ãƒŸç®±ç§»å‹•ï¼ˆé€ä¿¡å®Œäº†ã‚’ç¢ºå®Ÿã«ã™ã‚‹ãŸã‚ï¼‰
    Utilities.sleep(2000);
    
    // é€ä¿¡æ¸ˆã¿ãƒ•ã‚©ãƒ«ãƒ€ã‹ã‚‰è©²å½“ãƒ¡ãƒ¼ãƒ«ã‚’æ¤œç´¢
    const sentThreads = GmailApp.search('in:sent subject:"' + subject + '"', 0, 1);
    
    if (sentThreads.length > 0) {
      const thread = sentThreads[0];
      thread.moveToTrash();
      console.log('âœ… é€ä¿¡æ¸ˆã¿ãƒ¡ãƒ¼ãƒ«ã‚’ã‚´ãƒŸç®±ã«ç§»å‹•:', subject);
    } else {
      console.warn('âš ï¸ é€ä¿¡æ¸ˆã¿ãƒ¡ãƒ¼ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆæ—¢ã«ç§»å‹•æ¸ˆã¿ã®å¯èƒ½æ€§ï¼‰');
    }
    
  } catch (error) {
    console.error('âŒ ã‚´ãƒŸç®±ç§»å‹•ã‚¨ãƒ©ãƒ¼ï¼ˆãƒ¡ãƒ¼ãƒ«é€ä¿¡è‡ªä½“ã¯æˆåŠŸï¼‰:', error);
    // ã‚¨ãƒ©ãƒ¼ã§ã‚‚å‡¦ç†ã¯ç¶™ç¶šï¼ˆãƒ¡ãƒ¼ãƒ«é€ä¿¡ãŒæˆåŠŸã—ã¦ã„ã‚Œã°å•é¡Œãªã—ï¼‰
  }
}

// ========================================
// ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
// ========================================

function extractFileIdFromUrl(url) {
  if (!url) return null;
  
  const patterns = [
    /\/file\/d\/([a-zA-Z0-9-_]+)/,
    /id=([a-zA-Z0-9-_]+)/,
    /\/d\/([a-zA-Z0-9-_]+)/,
    /open\?id=([a-zA-Z0-9-_]+)/
  ];
  
  for (const pattern of patterns) {
    const match = url.match(pattern);
    if (match) return match[1];
  }
  
  return null;
}

function getOrCreateTempFolder() {
  const folderName = 'OCR_Temp_' + new Date().getFullYear();
  
  try {
    const folders = DriveApp.getFoldersByName(folderName);
    if (folders.hasNext()) {
      return folders.next();
    }
    return DriveApp.createFolder(folderName);
  } catch (error) {
    console.error('âŒ ä¸€æ™‚ãƒ•ã‚©ãƒ«ãƒ€æ“ä½œã‚¨ãƒ©ãƒ¼:', error);
    return DriveApp.getRootFolder();
  }
}