/**
 * ============================================
 * ä½“è‚²ä¼šæœ¬éƒ¨ çµ±åˆå…¥éƒ¨ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 
 * ============================================
 * 
 * ã€æ©Ÿèƒ½æ¦‚è¦ã€‘
 * - å…¥éƒ¨å±Šãƒ»å¹¹éƒ¨å¤‰æ›´å±Šãƒ»é€€éƒ¨å±Šã®ä¸€å…ƒç®¡ç†
 * - å›£ä½“åˆ¥ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¸ã®è‡ªå‹•æŒ¯ã‚Šåˆ†ã‘
 * - å›£ä½“ã®åŠ ç›Ÿãƒ»è„±é€€ç®¡ç†
 * - æœˆæ¬¡ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è‡ªå‹•å¤‰æ›´
 * 
 * ã€ã‚·ãƒ¼ãƒˆæ§‹æˆã€‘
 * - è¨­å®šã‚·ãƒ¼ãƒˆ: å›£ä½“ä¸€è¦§ã€ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã€SS IDç®¡ç†
 * - å„å›£ä½“åˆ¥SS: å…¥éƒ¨è€…/å¹¹éƒ¨å¤‰æ›´/é€€éƒ¨è€…ï¼ˆ3ã¤ãšã¤ï¼‰
 */

// ============================================
// ğŸ“Œ è¨­å®š
// ============================================

const CONFIG = {
  // ç®¡ç†è€…ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
  ADMIN_EMAIL: 'cit.taiiku@gmail.com',
  
  // ãƒ•ã‚©ãƒ¼ãƒ IDï¼ˆã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å¾Œã«è‡ªå‹•è¨­å®šã•ã‚Œã‚‹ï¼‰
  ENTRY_FORM_ID: '',      // å…¥éƒ¨å±Šãƒ•ã‚©ãƒ¼ãƒ 
  STAFF_FORM_ID: '',      // å¹¹éƒ¨å¤‰æ›´å±Šãƒ•ã‚©ãƒ¼ãƒ 
  EXIT_FORM_ID: '',       // é€€éƒ¨å±Šãƒ•ã‚©ãƒ¼ãƒ 
  
  // ã‚·ãƒ¼ãƒˆå
  SETTINGS_SHEET: 'è¨­å®š',
  
  // è¨­å®šã‚·ãƒ¼ãƒˆã®åˆ—
  COL_CLUB_NAME: 1,       // Aåˆ—: å›£ä½“å
  COL_CLUB_EMAIL: 2,      // Båˆ—: ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
  COL_SS_ID: 3,           // Cåˆ—: ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆID
  COL_STATUS: 4,          // Dåˆ—: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆæœ‰åŠ¹/è„±é€€ï¼‰
  
  // ãƒ•ã‚©ãƒ¼ãƒ ã®å›£ä½“é¸æŠåˆ—ï¼ˆ0å§‹ã¾ã‚Šï¼‰
  FORM_CLUB_COLUMN: 2,    // Cåˆ—: å›£ä½“å
  FORM_EMAIL_COLUMN: 1,   // Båˆ—: ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
};

// ============================================
// ğŸ“‹ ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒ‹ãƒ¥ãƒ¼
// ============================================

function onOpen() {
  const ui = SpreadsheetApp.getUi();
  ui.createMenu('ğŸ¢ å›£ä½“ç®¡ç†')
    .addItem('â• å›£ä½“ã‚’è¿½åŠ ', 'addNewClub')
    .addItem('â– å›£ä½“ã‚’å‰Šé™¤ï¼ˆã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ï¼‰', 'removeClub')
    .addSeparator()
    .addItem('ğŸ“‹ å›£ä½“ä¸€è¦§ã‚’è¡¨ç¤º', 'showClubList')
    .addItem('ğŸ”„ å›£ä½“æƒ…å ±ã‚’æ›´æ–°', 'updateClubInfo')
    .addToUi();
  
  ui.createMenu('âš™ï¸ ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†')
    .addItem('ğŸš€ åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—', 'setupSystem')
    .addItem('ğŸ“ ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆ', 'createAllForms')
    .addItem('ğŸ“Š å…¨å›£ä½“SSã‚’ä¸€æ‹¬ä½œæˆ', 'createAllClubSpreadsheets')
    .addItem('â° ãƒˆãƒªã‚¬ãƒ¼è¨­å®š', 'setupTriggers')
    .addSeparator()
    .addItem('ğŸ”‘ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ï¼ˆæ‰‹å‹•ï¼‰', 'changePasswordManually')
    .addItem('ğŸ§¹ ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤', 'cleanupTempFolder')
    .addToUi();
  
  ui.createMenu('ğŸ“§ æ‰‹å‹•å‡¦ç†')
    .addItem('ğŸ”„ é¸æŠè¡Œã‚’å†å‡¦ç†', 'processSelectedRow')
    .addItem('ğŸ“§ é¸æŠè¡Œã«ãƒ¡ãƒ¼ãƒ«é€ä¿¡', 'sendEmailForSelectedRow')
    .addToUi();
}

// ============================================
// ğŸš€ åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
// ============================================

function setupSystem() {
  const ui = SpreadsheetApp.getUi();
  
  ui.alert(
    'ğŸš€ åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—',
    'ã‚·ã‚¹ãƒ†ãƒ ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’é–‹å§‹ã—ã¾ã™ã€‚\n\n' +
    'ä»¥ä¸‹ã®é †åºã§é€²ã‚ã¾ã™ï¼š\n' +
    '1. è¨­å®šã‚·ãƒ¼ãƒˆã®ç¢ºèªãƒ»ä½œæˆ\n' +
    '2. ãƒ•ã‚©ãƒ¼ãƒ 3ç¨®ã®ä½œæˆ\n' +
    '3. å›£ä½“åˆ¥ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ä½œæˆ\n' +
    '4. ãƒˆãƒªã‚¬ãƒ¼ã®è¨­å®š\n\n' +
    'ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ',
    ui.ButtonSet.OK_CANCEL
  );
  
  try {
    // Step 1: è¨­å®šã‚·ãƒ¼ãƒˆç¢ºèª
    ui.alert('ã‚¹ãƒ†ãƒƒãƒ— 1/4', 'è¨­å®šã‚·ãƒ¼ãƒˆã‚’ç¢ºèªãƒ»ä½œæˆã—ã¾ã™...', ui.ButtonSet.OK);
    setupSettingsSheet();
    console.log('âœ… Step 1: è¨­å®šã‚·ãƒ¼ãƒˆç¢ºèªå®Œäº†');
    
    // Step 2: å›£ä½“ä¸€è¦§å…¥åŠ›ç¢ºèª
    const hasClubs = checkClubsExist();
    if (!hasClubs) {
      ui.alert(
        'å›£ä½“ç™»éŒ²ãŒå¿…è¦',
        'è¨­å®šã‚·ãƒ¼ãƒˆã«å›£ä½“ä¸€è¦§ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚\n\n' +
        'Aåˆ—: å›£ä½“å\n' +
        'Båˆ—: ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹\n\n' +
        'å…¥åŠ›å¾Œã€å†åº¦ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚',
        ui.ButtonSet.OK
      );
      return;
    }
    
    // Step 3: ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆ
    const createForms = ui.alert(
      'ã‚¹ãƒ†ãƒƒãƒ— 2/4',
      'ãƒ•ã‚©ãƒ¼ãƒ ã‚’è‡ªå‹•ä½œæˆã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆæ—¢å­˜ãƒ•ã‚©ãƒ¼ãƒ ãŒã‚ã‚‹å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—å¯èƒ½ï¼‰',
      ui.ButtonSet.YES_NO
    );
    if (createForms === ui.Button.YES) {
      createAllForms();
      console.log('âœ… Step 2: ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆå®Œäº†');
    }
    
    // Step 4: å›£ä½“åˆ¥SSä½œæˆ
    const createSS = ui.alert(
      'ã‚¹ãƒ†ãƒƒãƒ— 3/4',
      'å›£ä½“åˆ¥ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’ä¸€æ‹¬ä½œæˆã—ã¾ã™ã‹ï¼Ÿ\n' +
      'ï¼ˆå„å›£ä½“ã«3ã¤ãšã¤ä½œæˆã•ã‚Œã¾ã™ï¼‰',
      ui.ButtonSet.YES_NO
    );
    if (createSS === ui.Button.YES) {
      createAllClubSpreadsheets();
      console.log('âœ… Step 3: ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆä½œæˆå®Œäº†');
    }
    
    // Step 5: ãƒˆãƒªã‚¬ãƒ¼è¨­å®š
    const setupTrig = ui.alert(
      'ã‚¹ãƒ†ãƒƒãƒ— 4/4',
      'ãƒˆãƒªã‚¬ãƒ¼ã‚’è¨­å®šã—ã¾ã™ã‹ï¼Ÿ\n' +
      'ãƒ»ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ãƒˆãƒªã‚¬ãƒ¼\n' +
      'ãƒ»æœˆæ¬¡ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ãƒˆãƒªã‚¬ãƒ¼\n' +
      'ãƒ»å®šæœŸã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ãƒˆãƒªã‚¬ãƒ¼',
      ui.ButtonSet.YES_NO
    );
    if (setupTrig === ui.Button.YES) {
      setupTriggers();
      console.log('âœ… Step 4: ãƒˆãƒªã‚¬ãƒ¼è¨­å®šå®Œäº†');
    }
    
    ui.alert(
      'ğŸ‰ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†',
      'ã‚·ã‚¹ãƒ†ãƒ ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸï¼\n\n' +
      'æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼š\n' +
      '1. å„ãƒ•ã‚©ãƒ¼ãƒ ã®URLã‚’ç¢ºèª\n' +
      '2. å›£ä½“ã¸ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¨ãƒªãƒ³ã‚¯ã‚’é€šçŸ¥\n' +
      '3. å‹•ä½œãƒ†ã‚¹ãƒˆ',
      ui.ButtonSet.OK
    );
    
  } catch (error) {
    console.error('âŒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼:', error);
    ui.alert('ã‚¨ãƒ©ãƒ¼', 'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:\n' + error.toString(), ui.ButtonSet.OK);
  }
}

// ============================================
// ğŸ“Š è¨­å®šã‚·ãƒ¼ãƒˆç®¡ç†
// ============================================

function setupSettingsSheet() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let settingsSheet = ss.getSheetByName(CONFIG.SETTINGS_SHEET);
  
  if (!settingsSheet) {
    settingsSheet = ss.insertSheet(CONFIG.SETTINGS_SHEET);
    
    // ãƒ˜ãƒƒãƒ€ãƒ¼è¨­å®š
    const headers = ['å›£ä½“å', 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹', 'ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆID', 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹'];
    settingsSheet.getRange(1, 1, 1, headers.length).setValues([headers]);
    settingsSheet.getRange(1, 1, 1, headers.length)
      .setBackground('#4285F4')
      .setFontColor('#FFFFFF')
      .setFontWeight('bold');
    
    // åˆ—å¹…èª¿æ•´
    settingsSheet.setColumnWidth(1, 200);
    settingsSheet.setColumnWidth(2, 250);
    settingsSheet.setColumnWidth(3, 350);
    settingsSheet.setColumnWidth(4, 100);
    
    console.log('âœ… è¨­å®šã‚·ãƒ¼ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸ');
  }
  
  return settingsSheet;
}

function checkClubsExist() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const settingsSheet = ss.getSheetByName(CONFIG.SETTINGS_SHEET);
  
  if (!settingsSheet) return false;
  
  const lastRow = settingsSheet.getLastRow();
  return lastRow > 1; // ãƒ˜ãƒƒãƒ€ãƒ¼ä»¥å¤–ã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹
}

function getClubSettings() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const settingsSheet = ss.getSheetByName(CONFIG.SETTINGS_SHEET);
  
  if (!settingsSheet) return [];
  
  const lastRow = settingsSheet.getLastRow();
  if (lastRow < 2) return [];
  
  const data = settingsSheet.getRange(2, 1, lastRow - 1, 4).getValues();
  
  return data
    .filter(row => row[0] && row[3] !== 'è„±é€€')
    .map(row => ({
      name: row[0],
      email: row[1],
      ssId: row[2],
      status: row[3] || 'æœ‰åŠ¹'
    }));
}

function getActiveClubs() {
  return getClubSettings().map(club => club.name);
}

function saveClubSpreadsheetId(clubName, ssId) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const settingsSheet = ss.getSheetByName(CONFIG.SETTINGS_SHEET);
  
  const lastRow = settingsSheet.getLastRow();
  const data = settingsSheet.getRange(2, 1, lastRow - 1, 1).getValues();
  
  for (let i = 0; i < data.length; i++) {
    if (data[i][0] === clubName) {
      const rowNum = i + 2;
      settingsSheet.getRange(rowNum, CONFIG.COL_SS_ID).setValue(ssId);
      settingsSheet.getRange(rowNum, CONFIG.COL_STATUS).setValue('æœ‰åŠ¹');
      return;
    }
  }
}

// ============================================
// ğŸ¢ å›£ä½“ç®¡ç†æ©Ÿèƒ½
// ============================================

function addNewClub() {
  const ui = SpreadsheetApp.getUi();
  
  // å›£ä½“åå…¥åŠ›
  const nameResponse = ui.prompt(
    'â• å›£ä½“è¿½åŠ ',
    'è¿½åŠ ã™ã‚‹å›£ä½“åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š',
    ui.ButtonSet.OK_CANCEL
  );
  if (nameResponse.getSelectedButton() !== ui.Button.OK) return;
  const clubName = nameResponse.getResponseText().trim();
  
  if (!clubName) {
    ui.alert('ã‚¨ãƒ©ãƒ¼', 'å›£ä½“åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', ui.ButtonSet.OK);
    return;
  }
  
  // é‡è¤‡ãƒã‚§ãƒƒã‚¯
  const existingClubs = getActiveClubs();
  if (existingClubs.includes(clubName)) {
    ui.alert('ã‚¨ãƒ©ãƒ¼', `ã€Œ${clubName}ã€ã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚`, ui.ButtonSet.OK);
    return;
  }
  
  // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å…¥åŠ›
  const emailResponse = ui.prompt(
    'â• å›£ä½“è¿½åŠ ',
    `ã€Œ${clubName}ã€ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š`,
    ui.ButtonSet.OK_CANCEL
  );
  if (emailResponse.getSelectedButton() !== ui.Button.OK) return;
  const clubEmail = emailResponse.getResponseText().trim();
  
  if (!clubEmail || !clubEmail.includes('@')) {
    ui.alert('ã‚¨ãƒ©ãƒ¼', 'æœ‰åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', ui.ButtonSet.OK);
    return;
  }
  
  // ç¢ºèª
  const confirm = ui.alert(
    'ç¢ºèª',
    `ä»¥ä¸‹ã®å†…å®¹ã§å›£ä½“ã‚’è¿½åŠ ã—ã¾ã™ï¼š\n\n` +
    `å›£ä½“åï¼š${clubName}\n` +
    `ãƒ¡ãƒ¼ãƒ«ï¼š${clubEmail}\n\n` +
    `ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ`,
    ui.ButtonSet.YES_NO
  );
  if (confirm !== ui.Button.YES) return;
  
  try {
    // 1. è¨­å®šã‚·ãƒ¼ãƒˆã«è¿½åŠ 
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const settingsSheet = ss.getSheetByName(CONFIG.SETTINGS_SHEET);
    settingsSheet.appendRow([clubName, clubEmail, '', 'æœ‰åŠ¹']);
    
    // 2. ãƒ•ã‚©ãƒ¼ãƒ ã«é¸æŠè‚¢è¿½åŠ 
    addClubToForms(clubName);
    
    // 3. ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆä½œæˆï¼†æ¨©é™ä»˜ä¸
    const ssId = createClubSpreadsheet(clubName, clubEmail);
    
    // 4. SS IDã‚’ä¿å­˜
    saveClubSpreadsheetId(clubName, ssId);
    
    ui.alert(
      'âœ… è¿½åŠ å®Œäº†',
      `ã€Œ${clubName}ã€ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼\n\n` +
      `ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆï¼š\nhttps://docs.google.com/spreadsheets/d/${ssId}`,
      ui.ButtonSet.OK
    );
    
  } catch (error) {
    console.error('âŒ å›£ä½“è¿½åŠ ã‚¨ãƒ©ãƒ¼:', error);
    ui.alert('ã‚¨ãƒ©ãƒ¼', 'å›£ä½“è¿½åŠ ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:\n' + error.toString(), ui.ButtonSet.OK);
  }
}

function removeClub() {
  const ui = SpreadsheetApp.getUi();
  const clubs = getActiveClubs();
  
  if (clubs.length === 0) {
    ui.alert('æƒ…å ±', 'ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹å›£ä½“ãŒã‚ã‚Šã¾ã›ã‚“ã€‚', ui.ButtonSet.OK);
    return;
  }
  
  const response = ui.prompt(
    'â– å›£ä½“å‰Šé™¤',
    `å‰Šé™¤ã™ã‚‹å›£ä½“åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š\n\n` +
    `ã€ç¾åœ¨ã®å›£ä½“ä¸€è¦§ã€‘\n${clubs.join('\n')}`,
    ui.ButtonSet.OK_CANCEL
  );
  if (response.getSelectedButton() !== ui.Button.OK) return;
  const clubName = response.getResponseText().trim();
  
  if (!clubs.includes(clubName)) {
    ui.alert('ã‚¨ãƒ©ãƒ¼', `ã€Œ${clubName}ã€ã¯ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚`, ui.ButtonSet.OK);
    return;
  }
  
  const confirm = ui.alert(
    'âš ï¸ ç¢ºèª',
    `ã€Œ${clubName}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\n` +
    `â€»ãƒ‡ãƒ¼ã‚¿ã¯ä¿æŒã•ã‚Œã€å¾Œã‹ã‚‰å¾©å…ƒå¯èƒ½ã§ã™ã€‚`,
    ui.ButtonSet.YES_NO
  );
  if (confirm !== ui.Button.YES) return;
  
  try {
    // 1. ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰é¸æŠè‚¢å‰Šé™¤
    removeClubFromForms(clubName);
    
    // 2. è¨­å®šã‚·ãƒ¼ãƒˆã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ã€Œè„±é€€ã€ã«å¤‰æ›´
    updateClubStatus(clubName, 'è„±é€€');
    
    ui.alert('âœ… å‰Šé™¤å®Œäº†', `ã€Œ${clubName}ã€ã‚’ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã—ã¾ã—ãŸã€‚`, ui.ButtonSet.OK);
    
  } catch (error) {
    console.error('âŒ å›£ä½“å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
    ui.alert('ã‚¨ãƒ©ãƒ¼', 'å›£ä½“å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:\n' + error.toString(), ui.ButtonSet.OK);
  }
}

function updateClubStatus(clubName, status) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const settingsSheet = ss.getSheetByName(CONFIG.SETTINGS_SHEET);
  
  const lastRow = settingsSheet.getLastRow();
  const data = settingsSheet.getRange(2, 1, lastRow - 1, 1).getValues();
  
  for (let i = 0; i < data.length; i++) {
    if (data[i][0] === clubName) {
      settingsSheet.getRange(i + 2, CONFIG.COL_STATUS).setValue(status);
      return;
    }
  }
}

function showClubList() {
  const clubs = getClubSettings();
  const ui = SpreadsheetApp.getUi();
  
  if (clubs.length === 0) {
    ui.alert('å›£ä½“ä¸€è¦§', 'ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹å›£ä½“ãŒã‚ã‚Šã¾ã›ã‚“ã€‚', ui.ButtonSet.OK);
    return;
  }
  
  const list = clubs.map((club, index) => 
    `${index + 1}. ${club.name}\n   ğŸ“§ ${club.email}\n   ğŸ“Š SS: ${club.ssId ? 'è¨­å®šæ¸ˆã¿' : 'æœªè¨­å®š'}`
  ).join('\n\n');
  
  ui.alert('ğŸ“‹ å›£ä½“ä¸€è¦§', `ç™»éŒ²å›£ä½“æ•°: ${clubs.length}\n\n${list}`, ui.ButtonSet.OK);
}

// ============================================
// ğŸ“ ãƒ•ã‚©ãƒ¼ãƒ æ“ä½œ
// ============================================

function createAllForms() {
  const ui = SpreadsheetApp.getUi();
  const clubs = getActiveClubs();
  
  if (clubs.length === 0) {
    ui.alert('ã‚¨ãƒ©ãƒ¼', 'å…ˆã«è¨­å®šã‚·ãƒ¼ãƒˆã«å›£ä½“ä¸€è¦§ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', ui.ButtonSet.OK);
    return;
  }
  
  try {
    // ãƒã‚¹ã‚¿ãƒ¼ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®è¦ªãƒ•ã‚©ãƒ«ãƒ€ã‚’å–å¾—
    const masterSSId = SpreadsheetApp.getActiveSpreadsheet().getId();
    const masterFile = DriveApp.getFileById(masterSSId);
    const parentFolders = masterFile.getParents();
    const targetFolder = parentFolders.hasNext() ? parentFolders.next() : DriveApp.getRootFolder();
    
    // å…¥éƒ¨å±Šãƒ•ã‚©ãƒ¼ãƒ 
    const entryForm = createEntryForm(clubs);
    moveFormToFolder(entryForm, targetFolder);
    console.log('âœ… å…¥éƒ¨å±Šãƒ•ã‚©ãƒ¼ãƒ ä½œæˆ:', entryForm.getId());
    
    // å¹¹éƒ¨å¤‰æ›´å±Šãƒ•ã‚©ãƒ¼ãƒ 
    const staffForm = createStaffForm(clubs);
    moveFormToFolder(staffForm, targetFolder);
    console.log('âœ… å¹¹éƒ¨å¤‰æ›´å±Šãƒ•ã‚©ãƒ¼ãƒ ä½œæˆ:', staffForm.getId());
    
    // é€€éƒ¨å±Šãƒ•ã‚©ãƒ¼ãƒ 
    const exitForm = createExitForm(clubs);
    moveFormToFolder(exitForm, targetFolder);
    console.log('âœ… é€€éƒ¨å±Šãƒ•ã‚©ãƒ¼ãƒ ä½œæˆ:', exitForm.getId());
    
    // ãƒ•ã‚©ãƒ¼ãƒ IDã‚’ä¿å­˜
    const scriptProperties = PropertiesService.getScriptProperties();
    scriptProperties.setProperty('ENTRY_FORM_ID', entryForm.getId());
    scriptProperties.setProperty('STAFF_FORM_ID', staffForm.getId());
    scriptProperties.setProperty('EXIT_FORM_ID', exitForm.getId());
    
    ui.alert(
      'âœ… ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆå®Œäº†',
      `3ã¤ã®ãƒ•ã‚©ãƒ¼ãƒ ã‚’ä½œæˆã—ã¾ã—ãŸï¼š\n\n` +
      `ã€å…¥éƒ¨å±Šã€‘\n${entryForm.getPublishedUrl()}\n\n` +
      `ã€å¹¹éƒ¨å¤‰æ›´å±Šã€‘\n${staffForm.getPublishedUrl()}\n\n` +
      `ã€é€€éƒ¨å±Šã€‘\n${exitForm.getPublishedUrl()}\n\n` +
      `âš ï¸ å…¥éƒ¨å±Šãƒ•ã‚©ãƒ¼ãƒ ã®ã€Œå­¦ç”Ÿè¨¼ç”»åƒã€é …ç›®ã‚’\n` +
      `æ‰‹å‹•ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚`,
      ui.ButtonSet.OK
    );
    
  } catch (error) {
    console.error('âŒ ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆã‚¨ãƒ©ãƒ¼:', error);
    ui.alert('ã‚¨ãƒ©ãƒ¼', 'ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:\n' + error.toString(), ui.ButtonSet.OK);
  }
}

function moveFormToFolder(form, folder) {
  const formFile = DriveApp.getFileById(form.getId());
  folder.addFile(formFile);
  DriveApp.getRootFolder().removeFile(formFile);
}

function createEntryForm(clubs) {
  const form = FormApp.create('ã€ä½“è‚²ä¼šæœ¬éƒ¨ã€‘å…¥éƒ¨å±Š');
  
  form.setDescription(
    'å…¥éƒ¨å±Šãƒ•ã‚©ãƒ¼ãƒ ã§ã™ã€‚\n' +
    'â€»å›ç­”å†…å®¹ã‚’ç¢ºèªã—ã¦ã‹ã‚‰é€ä¿¡ã—ã¦ãã ã•ã„ã€‚\n' +
    'â€»é–“é•ãˆãŸå ´åˆã¯å†åº¦é€ä¿¡ã—ã¦ãã ã•ã„ï¼ˆä¸Šæ›¸ãã•ã‚Œã¾ã™ï¼‰ã€‚'
  );
  
  // ============================
  // ã‚»ã‚¯ã‚·ãƒ§ãƒ³1: ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›
  // ============================
  const passwordItem = form.addTextItem();
  passwordItem.setTitle('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰')
    .setRequired(true)
    .setHelpText('å›£ä½“ã‹ã‚‰é€šçŸ¥ã•ã‚ŒãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
  
  // ãƒšãƒ¼ã‚¸åŒºåˆ‡ã‚Š â†’ ã‚»ã‚¯ã‚·ãƒ§ãƒ³2ã¸
  const page2 = form.addPageBreakItem();
  page2.setTitle('å›£ä½“é¸æŠ');
  
  // ============================
  // ã‚»ã‚¯ã‚·ãƒ§ãƒ³2: å›£ä½“é¸æŠ
  // ============================
  const sortedClubs = [...clubs].sort((a, b) => a.localeCompare(b, 'ja'));
  const clubItem = form.addListItem();
  clubItem.setTitle('å…¥éƒ¨å¸Œæœ›å›£ä½“')
    .setRequired(true)
    .setHelpText('æ‰€å±ã™ã‚‹å›£ä½“ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚\nâ€»äº”åéŸ³é †ã«ä¸¦ã‚“ã§ã„ã¾ã™ã€‚')
    .setChoiceValues(sortedClubs);
  
  // ãƒšãƒ¼ã‚¸åŒºåˆ‡ã‚Š â†’ ã‚»ã‚¯ã‚·ãƒ§ãƒ³3ã¸
  const page3 = form.addPageBreakItem();
  page3.setTitle('ç¢ºèª');
  
  // ============================
  // ã‚»ã‚¯ã‚·ãƒ§ãƒ³3: ç¢ºèª
  // ============================
  const confirmItem = form.addMultipleChoiceItem();
  confirmItem.setTitle('é¸æŠã—ãŸå›£ä½“ã§é–“é•ã„ã‚ã‚Šã¾ã›ã‚“ã‹ï¼Ÿ')
    .setRequired(true)
    .setHelpText('é–“é•ã„ãŒã‚ã‚‹å ´åˆã¯ã€Œæˆ»ã‚‹ã€ãƒœã‚¿ãƒ³ã§å‰ã®ãƒšãƒ¼ã‚¸ã«æˆ»ã£ã¦ãã ã•ã„ã€‚')
    .setChoices([
      confirmItem.createChoice('ã¯ã„ã€é–“é•ã„ã‚ã‚Šã¾ã›ã‚“')
    ]);
  
  // ãƒšãƒ¼ã‚¸åŒºåˆ‡ã‚Š â†’ ã‚»ã‚¯ã‚·ãƒ§ãƒ³4ã¸
  const page4 = form.addPageBreakItem();
  page4.setTitle('å€‹äººæƒ…å ±å…¥åŠ›');
  
  // ============================
  // ã‚»ã‚¯ã‚·ãƒ§ãƒ³4: å€‹äººæƒ…å ±å…¥åŠ›
  // ============================
  form.addTextItem()
    .setTitle('å­¦ç”Ÿç•ªå·')
    .setRequired(true)
    .setHelpText('ä¾‹: 24A2095');
  
  form.addTextItem()
    .setTitle('æ°å')
    .setRequired(true)
    .setHelpText('ä¾‹: å±±ç”°å¤ªéƒ');
  
  form.addTextItem()
    .setTitle('æºå¸¯é›»è©±ç•ªå·')
    .setRequired(true)
    .setHelpText('ä¾‹: 090-1234-5678');
  
  // ãƒšãƒ¼ã‚¸åŒºåˆ‡ã‚Š â†’ ã‚»ã‚¯ã‚·ãƒ§ãƒ³5ã¸
  const page5 = form.addPageBreakItem();
  page5.setTitle('ä¿è­·è€…æƒ…å ±ãƒ»å­¦ç”Ÿè¨¼');
  
  // ============================
  // ã‚»ã‚¯ã‚·ãƒ§ãƒ³5: ä¿è­·è€…æƒ…å ±ãƒ»å­¦ç”Ÿè¨¼
  // ============================
  form.addTextItem()
    .setTitle('ä¿è­·è€… - å­¦ç”Ÿç•ªå·')
    .setRequired(true);
  
  form.addTextItem()
    .setTitle('ä¿è­·è€… - æ°å')
    .setRequired(true);
  
  // â€»ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã¯GASã‹ã‚‰è¿½åŠ ã§ããªã„ãŸã‚ã€ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’è¨­ç½®
  form.addTextItem()
    .setTitle('ã€è¦æ‰‹å‹•è¨­å®šã€‘å­¦ç”Ÿè¨¼ç”»åƒ')
    .setRequired(false)
    .setHelpText('âš ï¸ ã“ã®é …ç›®ã¯å¾Œã§æ‰‹å‹•ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤‰æ›´ã—ã¦ãã ã•ã„');
  
  // è¨­å®š
  form.setCollectEmail(true);
  form.setLimitOneResponsePerUser(false);
  form.setAllowResponseEdits(false);
  form.setShowLinkToRespondAgain(true);
  form.setProgressBar(true); // é€²è¡ŒçŠ¶æ³ãƒãƒ¼è¡¨ç¤º
  
  return form;
}

function createStaffForm(clubs) {
  const form = FormApp.create('ã€ä½“è‚²ä¼šæœ¬éƒ¨ã€‘å¹¹éƒ¨å¤‰æ›´å±Š');
  
  form.setDescription(
    'å¹¹éƒ¨å¤‰æ›´å±Šãƒ•ã‚©ãƒ¼ãƒ ã§ã™ã€‚\n' +
    'â€»å›ç­”å†…å®¹ã‚’ç¢ºèªã—ã¦ã‹ã‚‰é€ä¿¡ã—ã¦ãã ã•ã„ã€‚'
  );
  
  // ============================
  // ã‚»ã‚¯ã‚·ãƒ§ãƒ³1: ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›
  // ============================
  form.addTextItem()
    .setTitle('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰')
    .setRequired(true)
    .setHelpText('å›£ä½“ã‹ã‚‰é€šçŸ¥ã•ã‚ŒãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
  
  // ãƒšãƒ¼ã‚¸åŒºåˆ‡ã‚Š
  const page2 = form.addPageBreakItem();
  page2.setTitle('å›£ä½“é¸æŠ');
  
  // ============================
  // ã‚»ã‚¯ã‚·ãƒ§ãƒ³2: å›£ä½“é¸æŠ
  // ============================
  const sortedClubs = [...clubs].sort((a, b) => a.localeCompare(b, 'ja'));
  form.addListItem()
    .setTitle('å›£ä½“å')
    .setRequired(true)
    .setHelpText('æ‰€å±ã™ã‚‹å›£ä½“ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚')
    .setChoiceValues(sortedClubs);
  
  // ãƒšãƒ¼ã‚¸åŒºåˆ‡ã‚Š
  const page3 = form.addPageBreakItem();
  page3.setTitle('ç¢ºèª');
  
  // ============================
  // ã‚»ã‚¯ã‚·ãƒ§ãƒ³3: ç¢ºèª
  // ============================
  const confirmItem = form.addMultipleChoiceItem();
  confirmItem.setTitle('é¸æŠã—ãŸå›£ä½“ã§é–“é•ã„ã‚ã‚Šã¾ã›ã‚“ã‹ï¼Ÿ')
    .setRequired(true)
    .setHelpText('é–“é•ã„ãŒã‚ã‚‹å ´åˆã¯ã€Œæˆ»ã‚‹ã€ãƒœã‚¿ãƒ³ã§å‰ã®ãƒšãƒ¼ã‚¸ã«æˆ»ã£ã¦ãã ã•ã„ã€‚')
    .setChoices([
      confirmItem.createChoice('ã¯ã„ã€é–“é•ã„ã‚ã‚Šã¾ã›ã‚“')
    ]);
  
  // ãƒšãƒ¼ã‚¸åŒºåˆ‡ã‚Š
  const page4 = form.addPageBreakItem();
  page4.setTitle('å¹¹éƒ¨æƒ…å ±å…¥åŠ›');
  
  // ============================
  // ã‚»ã‚¯ã‚·ãƒ§ãƒ³4: å¹¹éƒ¨æƒ…å ±å…¥åŠ›
  // ============================
  form.addTextItem()
    .setTitle('å½¹è·')
    .setRequired(true)
    .setHelpText('ä¾‹: ä¸»å°†ã€å‰¯ä¸»å°†ã€ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼');
  
  form.addTextItem()
    .setTitle('å­¦ç”Ÿç•ªå·')
    .setRequired(true)
    .setHelpText('ä¾‹: 24A2095');
  
  form.addTextItem()
    .setTitle('æ°å')
    .setRequired(true)
    .setHelpText('ä¾‹: å±±ç”°å¤ªéƒ');
  
  form.addTextItem()
    .setTitle('æºå¸¯é›»è©±ç•ªå·')
    .setRequired(true)
    .setHelpText('ä¾‹: 090-1234-5678');
  
  // è¨­å®š
  form.setCollectEmail(true);
  form.setLimitOneResponsePerUser(false);
  form.setAllowResponseEdits(false);
  form.setProgressBar(true);
  
  return form;
}

function createExitForm(clubs) {
  const form = FormApp.create('ã€ä½“è‚²ä¼šæœ¬éƒ¨ã€‘é€€éƒ¨å±Š');
  
  form.setDescription(
    'é€€éƒ¨å±Šãƒ•ã‚©ãƒ¼ãƒ ã§ã™ã€‚\n' +
    'â€»å›ç­”å†…å®¹ã‚’ç¢ºèªã—ã¦ã‹ã‚‰é€ä¿¡ã—ã¦ãã ã•ã„ã€‚'
  );
  
  // ============================
  // ã‚»ã‚¯ã‚·ãƒ§ãƒ³1: ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›
  // ============================
  form.addTextItem()
    .setTitle('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰')
    .setRequired(true)
    .setHelpText('å›£ä½“ã‹ã‚‰é€šçŸ¥ã•ã‚ŒãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
  
  // ãƒšãƒ¼ã‚¸åŒºåˆ‡ã‚Š
  const page2 = form.addPageBreakItem();
  page2.setTitle('å›£ä½“é¸æŠ');
  
  // ============================
  // ã‚»ã‚¯ã‚·ãƒ§ãƒ³2: å›£ä½“é¸æŠ
  // ============================
  const sortedClubs = [...clubs].sort((a, b) => a.localeCompare(b, 'ja'));
  form.addListItem()
    .setTitle('å›£ä½“å')
    .setRequired(true)
    .setHelpText('é€€éƒ¨ã™ã‚‹å›£ä½“ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚')
    .setChoiceValues(sortedClubs);
  
  // ãƒšãƒ¼ã‚¸åŒºåˆ‡ã‚Š
  const page3 = form.addPageBreakItem();
  page3.setTitle('ç¢ºèª');
  
  // ============================
  // ã‚»ã‚¯ã‚·ãƒ§ãƒ³3: ç¢ºèª
  // ============================
  const confirmItem = form.addMultipleChoiceItem();
  confirmItem.setTitle('é¸æŠã—ãŸå›£ä½“ã§é–“é•ã„ã‚ã‚Šã¾ã›ã‚“ã‹ï¼Ÿ')
    .setRequired(true)
    .setHelpText('é–“é•ã„ãŒã‚ã‚‹å ´åˆã¯ã€Œæˆ»ã‚‹ã€ãƒœã‚¿ãƒ³ã§å‰ã®ãƒšãƒ¼ã‚¸ã«æˆ»ã£ã¦ãã ã•ã„ã€‚')
    .setChoices([
      confirmItem.createChoice('ã¯ã„ã€é–“é•ã„ã‚ã‚Šã¾ã›ã‚“')
    ]);
  
  // ãƒšãƒ¼ã‚¸åŒºåˆ‡ã‚Š
  const page4 = form.addPageBreakItem();
  page4.setTitle('é€€éƒ¨è€…æƒ…å ±å…¥åŠ›');
  
  // ============================
  // ã‚»ã‚¯ã‚·ãƒ§ãƒ³4: é€€éƒ¨è€…æƒ…å ±å…¥åŠ›
  // ============================
  form.addTextItem()
    .setTitle('å­¦ç”Ÿç•ªå·')
    .setRequired(true)
    .setHelpText('ä¾‹: 24A2095');
  
  form.addTextItem()
    .setTitle('æ°å')
    .setRequired(true)
    .setHelpText('ä¾‹: å±±ç”°å¤ªéƒ');
  
  form.addParagraphTextItem()
    .setTitle('é€€éƒ¨ç†ç”±')
    .setRequired(false)
    .setHelpText('ä»»æ„ï¼šé€€éƒ¨ã®ç†ç”±ãŒã‚ã‚Œã°ã”è¨˜å…¥ãã ã•ã„ã€‚');
  
  // è¨­å®š
  form.setCollectEmail(true);
  form.setLimitOneResponsePerUser(false);
  form.setAllowResponseEdits(false);
  form.setProgressBar(true);
  
  return form;
}

function addClubToForms(clubName) {
  const scriptProperties = PropertiesService.getScriptProperties();
  const formIds = [
    scriptProperties.getProperty('ENTRY_FORM_ID'),
    scriptProperties.getProperty('STAFF_FORM_ID'),
    scriptProperties.getProperty('EXIT_FORM_ID')
  ];
  
  formIds.forEach(formId => {
    if (!formId) return;
    
    try {
      const form = FormApp.openById(formId);
      const items = form.getItems(FormApp.ItemType.LIST);
      
      items.forEach(item => {
        if (item.getTitle().includes('å›£ä½“')) {
          const listItem = item.asListItem();
          const currentChoices = listItem.getChoices().map(c => c.getValue());
          
          if (!currentChoices.includes(clubName)) {
            currentChoices.push(clubName);
            currentChoices.sort((a, b) => a.localeCompare(b, 'ja'));
            listItem.setChoiceValues(currentChoices);
          }
        }
      });
    } catch (error) {
      console.warn('ãƒ•ã‚©ãƒ¼ãƒ æ›´æ–°ã‚¹ã‚­ãƒƒãƒ—:', formId, error);
    }
  });
}

function removeClubFromForms(clubName) {
  const scriptProperties = PropertiesService.getScriptProperties();
  const formIds = [
    scriptProperties.getProperty('ENTRY_FORM_ID'),
    scriptProperties.getProperty('STAFF_FORM_ID'),
    scriptProperties.getProperty('EXIT_FORM_ID')
  ];
  
  formIds.forEach(formId => {
    if (!formId) return;
    
    try {
      const form = FormApp.openById(formId);
      const items = form.getItems(FormApp.ItemType.LIST);
      
      items.forEach(item => {
        if (item.getTitle().includes('å›£ä½“')) {
          const listItem = item.asListItem();
          const currentChoices = listItem.getChoices()
            .map(c => c.getValue())
            .filter(c => c !== clubName);
          
          if (currentChoices.length > 0) {
            listItem.setChoiceValues(currentChoices);
          }
        }
      });
    } catch (error) {
      console.warn('ãƒ•ã‚©ãƒ¼ãƒ æ›´æ–°ã‚¹ã‚­ãƒƒãƒ—:', formId, error);
    }
  });
}

// ============================================
// ğŸ“Š ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆä½œæˆ
// ============================================

function createAllClubSpreadsheets() {
  const ui = SpreadsheetApp.getUi();
  const clubs = getClubSettings();
  
  if (clubs.length === 0) {
    ui.alert('ã‚¨ãƒ©ãƒ¼', 'å…ˆã«è¨­å®šã‚·ãƒ¼ãƒˆã«å›£ä½“ä¸€è¦§ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', ui.ButtonSet.OK);
    return;
  }
  
  const confirm = ui.alert(
    'ç¢ºèª',
    `${clubs.length}å›£ä½“åˆ†ã®ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚\n` +
    `ï¼ˆå„å›£ä½“1ãƒ•ã‚¡ã‚¤ãƒ« Ã— ${clubs.length}å›£ä½“ = ${clubs.length}ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰\n\n` +
    `ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ`,
    ui.ButtonSet.YES_NO
  );
  if (confirm !== ui.Button.YES) return;
  
  let successCount = 0;
  let errorCount = 0;
  
  clubs.forEach(club => {
    try {
      if (club.ssId) {
        console.log(`ã‚¹ã‚­ãƒƒãƒ—: ${club.name}ï¼ˆæ—¢ã«SSä½œæˆæ¸ˆã¿ï¼‰`);
        return;
      }
      
      const ssId = createClubSpreadsheet(club.name, club.email);
      saveClubSpreadsheetId(club.name, ssId);
      successCount++;
      console.log(`âœ… ${club.name}: SSä½œæˆå®Œäº†`);
      
    } catch (error) {
      console.error(`âŒ ${club.name}: SSä½œæˆã‚¨ãƒ©ãƒ¼`, error);
      errorCount++;
    }
  });
  
  ui.alert(
    'ä½œæˆå®Œäº†',
    `ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆä½œæˆãŒå®Œäº†ã—ã¾ã—ãŸã€‚\n\n` +
    `æˆåŠŸ: ${successCount}å›£ä½“\n` +
    `ã‚¨ãƒ©ãƒ¼: ${errorCount}å›£ä½“`,
    ui.ButtonSet.OK
  );
}

function createClubSpreadsheet(clubName, clubEmail) {
  // ãƒã‚¹ã‚¿ãƒ¼ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®è¦ªãƒ•ã‚©ãƒ«ãƒ€ã‚’å–å¾—
  const masterSSId = SpreadsheetApp.getActiveSpreadsheet().getId();
  const masterFile = DriveApp.getFileById(masterSSId);
  const parentFolders = masterFile.getParents();
  const targetFolder = parentFolders.hasNext() ? parentFolders.next() : DriveApp.getRootFolder();
  
  // 1ã¤ã®ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’ä½œæˆ
  const ss = SpreadsheetApp.create(clubName);
  const ssFile = DriveApp.getFileById(ss.getId());
  
  // ãƒ•ã‚©ãƒ«ãƒ€ã«ç§»å‹•
  targetFolder.addFile(ssFile);
  DriveApp.getRootFolder().removeFile(ssFile);
  
  // ã‚·ãƒ¼ãƒˆ1: å…¥éƒ¨è€…
  const entrySheet = ss.getSheetByName('ã‚·ãƒ¼ãƒˆ1') || ss.getSheets()[0];
  entrySheet.setName('å…¥éƒ¨è€…');
  setupEntrySheet(entrySheet);
  
  // ã‚·ãƒ¼ãƒˆ2: å¹¹éƒ¨å¤‰æ›´
  const staffSheet = ss.insertSheet('å¹¹éƒ¨å¤‰æ›´');
  setupStaffSheet(staffSheet);
  
  // ã‚·ãƒ¼ãƒˆ3: é€€éƒ¨è€…
  const exitSheet = ss.insertSheet('é€€éƒ¨è€…');
  setupExitSheet(exitSheet);
  
  // æ¨©é™ä»˜ä¸ï¼ˆç·¨é›†æ¨©é™ï¼‰
  ssFile.addEditor(clubEmail);
  
  // å…¥éƒ¨è€…ãƒ»å¹¹éƒ¨å¤‰æ›´ã‚·ãƒ¼ãƒˆã‚’ä¿è­·ï¼ˆè­¦å‘Šè¡¨ç¤ºã®ã¿ï¼‰
  protectSheet(entrySheet, clubEmail);
  protectSheet(staffSheet, clubEmail);
  
  return ss.getId();
}

function protectSheet(sheet, clubEmail) {
  const protection = sheet.protect();
  protection.setDescription('ç®¡ç†è€…ã®ã¿ç·¨é›†å¯èƒ½');
  protection.setWarningOnly(true); // è­¦å‘Šã®ã¿è¡¨ç¤ºï¼ˆç·¨é›†ã¯å¯èƒ½ã ãŒè­¦å‘ŠãŒå‡ºã‚‹ï¼‰
}

function setupEntrySheet(sheet) {
  // 1è¡Œç›®: ç©ºç™½ï¼ˆå½¹è·ç”¨ï¼‰
  sheet.getRange(1, 1).setValue('');
  
  // 2è¡Œç›®: ãƒ˜ãƒƒãƒ€ãƒ¼
  const headers = [
    'ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—', 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹', 'å›£ä½“å', 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰',
    'å­¦ç”Ÿç•ªå·', 'æ°å', 'æºå¸¯é›»è©±ç•ªå·',
    'ä¿è­·è€…-å­¦ç”Ÿç•ªå·', 'ä¿è­·è€…-æ°å', 'å­¦ç”Ÿè¨¼ç”»åƒ', 'OCRçµæœ'
  ];
  sheet.getRange(2, 1, 1, headers.length).setValues([headers]);
  sheet.getRange(2, 1, 1, headers.length)
    .setBackground('#4285F4')
    .setFontColor('#FFFFFF')
    .setFontWeight('bold');
  
  // åˆ—å¹…èª¿æ•´
  sheet.setColumnWidth(1, 150);
  sheet.setColumnWidth(2, 200);
  sheet.setColumnWidth(6, 100);
}

function setupStaffSheet(sheet) {
  // 1è¡Œç›®: ç©ºç™½ï¼ˆå½¹è·ç”¨ï¼‰
  sheet.getRange(1, 1).setValue('');
  
  // 2è¡Œç›®: ãƒ˜ãƒƒãƒ€ãƒ¼
  const headers = [
    'ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—', 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹', 'å›£ä½“å', 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰',
    'å½¹è·', 'å­¦ç”Ÿç•ªå·', 'æ°å', 'æºå¸¯é›»è©±ç•ªå·'
  ];
  sheet.getRange(2, 1, 1, headers.length).setValues([headers]);
  sheet.getRange(2, 1, 1, headers.length)
    .setBackground('#4285F4')
    .setFontColor('#FFFFFF')
    .setFontWeight('bold');
}

function setupExitSheet(sheet) {
  // 1è¡Œç›®: ç©ºç™½ï¼ˆå½¹è·ç”¨ï¼‰
  sheet.getRange(1, 1).setValue('');
  
  // 2è¡Œç›®: ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆAåˆ—ã«ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ç”¨ï¼‰
  const headers = [
    'âœ“', 'ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—', 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹', 'å›£ä½“å', 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰',
    'å­¦ç”Ÿç•ªå·', 'æ°å', 'é€€éƒ¨ç†ç”±'
  ];
  sheet.getRange(2, 1, 1, headers.length).setValues([headers]);
  sheet.getRange(2, 1, 1, headers.length)
    .setBackground('#4285F4')
    .setFontColor('#FFFFFF')
    .setFontWeight('bold');
  
  // Aåˆ—ã®å¹…ã‚’ç‹­ã
  sheet.setColumnWidth(1, 30);
}

// ============================================
// ğŸ“§ ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‡¦ç†
// ============================================

function onEntryFormSubmit(e) {
  processFormSubmit(e, 'entry');
}

function onStaffFormSubmit(e) {
  processFormSubmit(e, 'staff');
}

function onExitFormSubmit(e) {
  processFormSubmit(e, 'exit');
}

function processFormSubmit(e, formType) {
  try {
    console.log(`=== ${formType}ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‡¦ç†é–‹å§‹ ===`);
    
    const response = e.values;
    const email = response[CONFIG.FORM_EMAIL_COLUMN];
    const clubName = response[CONFIG.FORM_CLUB_COLUMN];
    
    console.log('ãƒ¡ãƒ¼ãƒ«:', email);
    console.log('å›£ä½“å:', clubName);
    
    // å›£ä½“ã®ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’å–å¾—
    const clubSettings = getClubSettings().find(c => c.name === clubName);
    if (!clubSettings) {
      console.error('âŒ å›£ä½“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', clubName);
      return;
    }
    
    if (!clubSettings.ssId) {
      console.error('âŒ ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆIDãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
      return;
    }
    
    const ss = SpreadsheetApp.openById(clubSettings.ssId);
    
    // ã‚·ãƒ¼ãƒˆåã‚’æ±ºå®š
    let sheetName;
    switch (formType) {
      case 'entry':
        sheetName = 'å…¥éƒ¨è€…';
        break;
      case 'staff':
        sheetName = 'å¹¹éƒ¨å¤‰æ›´';
        break;
      case 'exit':
        sheetName = 'é€€éƒ¨è€…';
        break;
    }
    
    const sheet = ss.getSheetByName(sheetName);
    if (!sheet) {
      console.error('âŒ ã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', sheetName);
      return;
    }
    
    // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’æ¤œç´¢
    const emailColumn = formType === 'exit' ? 3 : 2; // é€€éƒ¨è€…ã¯Aåˆ—ãŒãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹
    const existingRow = findRowByEmail(sheet, email, emailColumn);
    
    if (existingRow) {
      // ä¸Šæ›¸ãæ›´æ–°
      if (formType === 'exit') {
        // é€€éƒ¨è€…ï¼šãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã¯ç¶­æŒ
        sheet.getRange(existingRow, 2, 1, response.length).setValues([response]);
      } else {
        sheet.getRange(existingRow, 1, 1, response.length).setValues([response]);
      }
      console.log(`âœ… ä¸Šæ›¸ãæ›´æ–°: è¡Œ${existingRow}`);
    } else {
      // æ–°è¦è¿½åŠ ï¼ˆå…ˆé ­ã«æŒ¿å…¥ = é™é †ï¼‰
      sheet.insertRowAfter(2);
      
      if (formType === 'exit') {
        // é€€éƒ¨è€…ï¼šAåˆ—ã«ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹
        sheet.getRange(3, 1).insertCheckboxes();
        sheet.getRange(3, 2, 1, response.length).setValues([response]);
      } else {
        sheet.getRange(3, 1, 1, response.length).setValues([response]);
      }
      console.log('âœ… æ–°è¦è¿½åŠ : è¡Œ3');
    }
    
    // OCRå‡¦ç†ï¼ˆå…¥éƒ¨è€…ã®ã¿ï¼‰
    if (formType === 'entry') {
      processOCRForEntry(sheet, existingRow || 3, response);
    }
    
    console.log(`=== ${formType}ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‡¦ç†å®Œäº† ===`);
    
  } catch (error) {
    console.error('âŒ ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
  }
}

function findRowByEmail(sheet, email, emailColumn) {
  const lastRow = sheet.getLastRow();
  if (lastRow < 3) return null; // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã¾ã§
  
  const data = sheet.getRange(3, emailColumn, lastRow - 2, 1).getValues();
  
  for (let i = 0; i < data.length; i++) {
    if (data[i][0].toString().trim().toLowerCase() === email.toString().trim().toLowerCase()) {
      return i + 3;
    }
  }
  return null;
}

// ============================================
// ğŸ” OCRå‡¦ç†
// ============================================

function processOCRForEntry(sheet, rowNum, response) {
  try {
    const imageUrl = response[9]; // å­¦ç”Ÿè¨¼ç”»åƒURLï¼ˆèª¿æ•´å¿…è¦ï¼‰
    if (!imageUrl) {
      console.log('å­¦ç”Ÿè¨¼ç”»åƒãªã— - OCRã‚¹ã‚­ãƒƒãƒ—');
      return;
    }
    
    // OCRå‡¦ç†ï¼ˆæ—¢å­˜ã®é–¢æ•°ã‚’ä½¿ç”¨ï¼‰
    const ocrResult = processStudentCardWithRetry(imageUrl);
    
    if (ocrResult) {
      sheet.getRange(rowNum, 11).setValue(ocrResult); // Kåˆ—: OCRçµæœ
      
      // å…¥åŠ›ã¨ã®æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
      const inputStudentId = response[4]; // å­¦ç”Ÿç•ªå·
      if (inputStudentId.toString().toUpperCase() !== ocrResult.toString().toUpperCase()) {
        sheet.getRange(rowNum, 11).setFontColor('#FF0000');
        console.log('âš ï¸ å­¦ç”Ÿç•ªå·ä¸ä¸€è‡´');
      }
    } else {
      sheet.getRange(rowNum, 11).setValue('OCRå¤±æ•—').setFontColor('#FF0000');
    }
    
  } catch (error) {
    console.error('OCRå‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
    sheet.getRange(rowNum, 11).setValue('OCRã‚¨ãƒ©ãƒ¼').setFontColor('#FF0000');
  }
}

// ============================================
// ğŸ”‘ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç®¡ç†
// ============================================

function changePasswordAndSendEmails() {
  try {
    console.log('=== ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´å‡¦ç†é–‹å§‹ ===');
    
    const newPassword = generatePassword();
    console.log('æ–°ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰:', newPassword);
    
    // å…¨ãƒ•ã‚©ãƒ¼ãƒ ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’æ›´æ–°
    updateAllFormsPassword(newPassword);
    
    // å…¨å›£ä½“ã«ãƒ¡ãƒ¼ãƒ«é€ä¿¡
    const clubs = getClubSettings();
    let successCount = 0;
    
    clubs.forEach(club => {
      try {
        sendPasswordEmail(club, newPassword);
        successCount++;
        Utilities.sleep(1000);
      } catch (error) {
        console.error(`${club.name}ã¸ã®ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚¨ãƒ©ãƒ¼:`, error);
      }
    });
    
    // ç®¡ç†è€…ã«é€šçŸ¥
    sendAdminNotification(newPassword, { success: successCount, failure: clubs.length - successCount });
    
    console.log('=== ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´å‡¦ç†å®Œäº† ===');
    
  } catch (error) {
    console.error('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ã‚¨ãƒ©ãƒ¼:', error);
    sendErrorNotification(error);
  }
}

function generatePassword() {
  const chars = 'ABCDEFGHJKLMNOPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz0123456789';
  let password = '';
  for (let i = 0; i < 5; i++) {
    password += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return password;
}

function updateAllFormsPassword(newPassword) {
  const scriptProperties = PropertiesService.getScriptProperties();
  const formIds = [
    scriptProperties.getProperty('ENTRY_FORM_ID'),
    scriptProperties.getProperty('STAFF_FORM_ID'),
    scriptProperties.getProperty('EXIT_FORM_ID')
  ];
  
  formIds.forEach(formId => {
    if (!formId) return;
    updateFormPassword(formId, newPassword);
  });
}

function updateFormPassword(formId, newPassword) {
  try {
    const form = FormApp.openById(formId);
    const items = form.getItems(FormApp.ItemType.TEXT);
    
    for (const item of items) {
      if (item.getTitle().includes('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰')) {
        const textItem = item.asTextItem();
        const validation = FormApp.createTextValidation()
          .requireTextMatchesPattern(newPassword)
          .setHelpText('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™ã€‚æ­£ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚')
          .build();
        textItem.setValidation(validation);
        console.log('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ›´æ–°:', formId);
        return;
      }
    }
  } catch (error) {
    console.error('ãƒ•ã‚©ãƒ¼ãƒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
  }
}

function sendPasswordEmail(club, newPassword) {
  const scriptProperties = PropertiesService.getScriptProperties();
  const entryFormId = scriptProperties.getProperty('ENTRY_FORM_ID');
  const staffFormId = scriptProperties.getProperty('STAFF_FORM_ID');
  const exitFormId = scriptProperties.getProperty('EXIT_FORM_ID');
  
  const entryFormUrl = entryFormId ? FormApp.openById(entryFormId).getPublishedUrl() : 'æœªè¨­å®š';
  const staffFormUrl = staffFormId ? FormApp.openById(staffFormId).getPublishedUrl() : 'æœªè¨­å®š';
  const exitFormUrl = exitFormId ? FormApp.openById(exitFormId).getPublishedUrl() : 'æœªè¨­å®š';
  
  const subject = 'ã€ä½“è‚²ä¼šæœ¬éƒ¨ã€‘ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ã®ãŠçŸ¥ã‚‰ã›';
  const body = `${club.name}å¾¡ä¸­

ãŠç–²ã‚Œæ§˜ã§ã™ã€‚
åƒè‘‰å·¥æ¥­å¤§å­¦ä½“è‚²ä¼šæœ¬éƒ¨ç·¨é›†éƒ¨é•·ã§ã™ã€‚

è¡¨é¡Œã®ä»¶ã«ã¤ã„ã¦ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä»¥ä¸‹ã®ã¨ãŠã‚Š
å¤‰æ›´ã¨ãªã£ãŸã“ã¨ã”å ±å‘Šã„ãŸã—ã¾ã™ã€‚

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â–  æ–°ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼š${newPassword}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

â–  å„ç¨®ãƒ•ã‚©ãƒ¼ãƒ ãƒªãƒ³ã‚¯
ã€å…¥éƒ¨å±Šãƒ•ã‚©ãƒ¼ãƒ ã€‘
${entryFormUrl}

ã€å¹¹éƒ¨å¤‰æ›´å±Šãƒ•ã‚©ãƒ¼ãƒ ã€‘
${staffFormUrl}

ã€é€€éƒ¨å±Šãƒ•ã‚©ãƒ¼ãƒ ã€‘
${exitFormUrl}

â–  ç®¡ç†ç”¨ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆ
https://docs.google.com/spreadsheets/d/${club.ssId}
â€»ã€Œå…¥éƒ¨è€…ã€ã€Œå¹¹éƒ¨å¤‰æ›´ã€ã€Œé€€éƒ¨è€…ã€ã®3ã‚·ãƒ¼ãƒˆãŒã‚ã‚Šã¾ã™ã€‚
â€»ã€Œé€€éƒ¨è€…ã€ã‚·ãƒ¼ãƒˆã®ã¿ç·¨é›†å¯èƒ½ã§ã™ã€‚å‡¦ç†å®Œäº†æ™‚ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ãã ã•ã„ã€‚

ä½•ã‹ã”ä¸æ˜ç‚¹ç­‰ã”ã–ã„ã¾ã—ãŸã‚‰ã”é€£çµ¡ãã ã•ã„ã€‚

ä»¥ä¸Šã€ã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚

***********************************************
åƒè‘‰å·¥æ¥­å¤§å­¦ã€€ä½“è‚²ä¼šæœ¬éƒ¨
TELï¼š047-478-0251
e-mailï¼šcit.taiiku@gmail.com
HPï¼šhttps://sites.google.com/view/cittaiiku2021hp
***********************************************`;
  
  MailApp.sendEmail(club.email, subject, body);
  console.log('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ¡ãƒ¼ãƒ«é€ä¿¡:', club.name);
}

function sendAdminNotification(newPassword, result) {
  const subject = 'ã€è‡ªå‹•å®Ÿè¡Œå®Œäº†ã€‘ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´å‡¦ç†';
  const body = `ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸã€‚

å®Ÿè¡Œæ—¥æ™‚: ${new Date().toLocaleString('ja-JP')}
æ–°ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰: ${newPassword}

ãƒ¡ãƒ¼ãƒ«é€ä¿¡çµæœ:
- æˆåŠŸ: ${result.success}ä»¶
- å¤±æ•—: ${result.failure}ä»¶`;
  
  MailApp.sendEmail(CONFIG.ADMIN_EMAIL, subject, body);
}

function sendErrorNotification(error) {
  const subject = 'ã€ã‚¨ãƒ©ãƒ¼ã€‘ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´å‡¦ç†';
  const body = `ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚

å®Ÿè¡Œæ—¥æ™‚: ${new Date().toLocaleString('ja-JP')}
ã‚¨ãƒ©ãƒ¼å†…å®¹: ${error.toString()}`;
  
  MailApp.sendEmail(CONFIG.ADMIN_EMAIL, subject, body);
}

function changePasswordManually() {
  const ui = SpreadsheetApp.getUi();
  const confirm = ui.alert(
    'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´',
    'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã€å…¨å›£ä½“ã«ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã—ã¾ã™ã‹ï¼Ÿ',
    ui.ButtonSet.YES_NO
  );
  
  if (confirm === ui.Button.YES) {
    changePasswordAndSendEmails();
    ui.alert('å®Œäº†', 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ã¨ãƒ¡ãƒ¼ãƒ«é€ä¿¡ãŒå®Œäº†ã—ã¾ã—ãŸã€‚', ui.ButtonSet.OK);
  }
}

// ============================================
// â° ãƒˆãƒªã‚¬ãƒ¼è¨­å®š
// ============================================

function setupTriggers() {
  const ui = SpreadsheetApp.getUi();
  
  try {
    // æ—¢å­˜ãƒˆãƒªã‚¬ãƒ¼å‰Šé™¤
    ScriptApp.getProjectTriggers().forEach(trigger => {
      ScriptApp.deleteTrigger(trigger);
    });
    
    // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ãƒˆãƒªã‚¬ãƒ¼
    const scriptProperties = PropertiesService.getScriptProperties();
    const entryFormId = scriptProperties.getProperty('ENTRY_FORM_ID');
    const staffFormId = scriptProperties.getProperty('STAFF_FORM_ID');
    const exitFormId = scriptProperties.getProperty('EXIT_FORM_ID');
    
    if (entryFormId) {
      ScriptApp.newTrigger('onEntryFormSubmit')
        .forForm(entryFormId)
        .onFormSubmit()
        .create();
      console.log('âœ… å…¥éƒ¨å±Šãƒˆãƒªã‚¬ãƒ¼ä½œæˆ');
    }
    
    if (staffFormId) {
      ScriptApp.newTrigger('onStaffFormSubmit')
        .forForm(staffFormId)
        .onFormSubmit()
        .create();
      console.log('âœ… å¹¹éƒ¨å¤‰æ›´å±Šãƒˆãƒªã‚¬ãƒ¼ä½œæˆ');
    }
    
    if (exitFormId) {
      ScriptApp.newTrigger('onExitFormSubmit')
        .forForm(exitFormId)
        .onFormSubmit()
        .create();
      console.log('âœ… é€€éƒ¨å±Šãƒˆãƒªã‚¬ãƒ¼ä½œæˆ');
    }
    
    // æœˆæ¬¡ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ãƒˆãƒªã‚¬ãƒ¼
    ScriptApp.newTrigger('changePasswordAndSendEmails')
      .timeBased()
      .onMonthDay(1)
      .atHour(9)
      .create();
    console.log('âœ… æœˆæ¬¡ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ãƒˆãƒªã‚¬ãƒ¼ä½œæˆ');
    
    // å®šæœŸã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ãƒˆãƒªã‚¬ãƒ¼ï¼ˆå»ƒæ­¢ or ç¶­æŒï¼‰
    // â€»é€šçŸ¥å•é¡Œã‚’é¿ã‘ã‚‹ãŸã‚ã€å¿…è¦ã«å¿œã˜ã¦ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ
    /*
    ScriptApp.newTrigger('cleanupTempFolder')
      .timeBased()
      .everyDays(1)
      .atHour(2)
      .create();
    */
    
    ui.alert('âœ… ãƒˆãƒªã‚¬ãƒ¼è¨­å®šå®Œäº†', 'ãƒˆãƒªã‚¬ãƒ¼ã‚’è¨­å®šã—ã¾ã—ãŸã€‚', ui.ButtonSet.OK);
    
  } catch (error) {
    console.error('ãƒˆãƒªã‚¬ãƒ¼è¨­å®šã‚¨ãƒ©ãƒ¼:', error);
    ui.alert('ã‚¨ãƒ©ãƒ¼', 'ãƒˆãƒªã‚¬ãƒ¼è¨­å®šä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:\n' + error.toString(), ui.ButtonSet.OK);
  }
}

// ============================================
// ğŸ§¹ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
// ============================================

function cleanupTempFolder() {
  try {
    const folderName = 'OCR_Temp_' + new Date().getFullYear();
    const folders = DriveApp.getFoldersByName(folderName);
    
    if (!folders.hasNext()) {
      console.log('ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å¯¾è±¡ãªã—');
      return;
    }
    
    const folder = folders.next();
    const files = folder.getFiles();
    let deletedCount = 0;
    
    const oneHourAgo = new Date(Date.now() - 60 * 60 * 1000);
    
    while (files.hasNext()) {
      const file = files.next();
      if (file.getDateCreated() < oneHourAgo) {
        file.setTrashed(true);
        deletedCount++;
      }
    }
    
    console.log(`âœ… ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†: ${deletedCount}ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤`);
    
  } catch (error) {
    console.error('ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼:', error);
  }
}

// ============================================
// ğŸ” OCRé–¢é€£ï¼ˆæ—¢å­˜ã‚³ãƒ¼ãƒ‰ã‹ã‚‰ç§»æ¤ï¼‰
// ============================================

function processStudentCardWithRetry(imageUrl, maxRetries = 2) {
  for (let attempt = 1; attempt <= maxRetries; attempt++) {
    try {
      const result = processStudentCardDriveOCR(imageUrl);
      if (result) return result;
      Utilities.sleep(3000);
    } catch (error) {
      console.error(`OCRè©¦è¡Œ ${attempt}/${maxRetries} ã‚¨ãƒ©ãƒ¼:`, error);
      if (attempt < maxRetries) Utilities.sleep(3000);
    }
  }
  return null;
}

function processStudentCardDriveOCR(imageUrl) {
  try {
    const fileId = extractFileIdFromUrl(imageUrl);
    if (!fileId) return null;
    
    const file = DriveApp.getFileById(fileId);
    const blob = file.getBlob();
    
    const tempFolder = getOrCreateTempFolder();
    const resource = {
      title: `OCR_${Date.now()}`,
      parents: [{ id: tempFolder.getId() }],
    };
    
    const doc = Drive.Files.insert(resource, blob, { ocr: true, ocrLanguage: 'ja' });
    if (!doc || !doc.id) return null;
    
    Utilities.sleep(3000);
    
    const ocrDoc = DocumentApp.openById(doc.id);
    const ocrText = ocrDoc.getBody().getText();
    
    DriveApp.getFileById(doc.id).setTrashed(true);
    
    return extractStudentId(ocrText);
    
  } catch (error) {
    console.error('OCRã‚¨ãƒ©ãƒ¼:', error);
    return null;
  }
}

function extractStudentId(text) {
  // å­¦ç”Ÿç•ªå·ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆä¾‹: 24A2095ï¼‰
  const patterns = [
    /(\d{2}[A-Za-z]\d{4})/g,
    /(\d{7})/g
  ];
  
  for (const pattern of patterns) {
    const match = text.match(pattern);
    if (match) return match[0].toUpperCase();
  }
  return null;
}

function extractFileIdFromUrl(url) {
  if (!url) return null;
  const patterns = [
    /\/file\/d\/([a-zA-Z0-9-_]+)/,
    /id=([a-zA-Z0-9-_]+)/,
    /\/d\/([a-zA-Z0-9-_]+)/
  ];
  for (const pattern of patterns) {
    const match = url.match(pattern);
    if (match) return match[1];
  }
  return null;
}

function getOrCreateTempFolder() {
  const folderName = 'OCR_Temp_' + new Date().getFullYear();
  const folders = DriveApp.getFoldersByName(folderName);
  if (folders.hasNext()) return folders.next();
  return DriveApp.createFolder(folderName);
}

// ============================================
// ğŸ“§ æ‰‹å‹•å‡¦ç†
// ============================================

function processSelectedRow() {
  const ui = SpreadsheetApp.getUi();
  ui.alert('æƒ…å ±', 'ã“ã®æ©Ÿèƒ½ã¯å›£ä½“åˆ¥SSã§ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚', ui.ButtonSet.OK);
}

function sendEmailForSelectedRow() {
  const ui = SpreadsheetApp.getUi();
  ui.alert('æƒ…å ±', 'ãƒ¡ãƒ¼ãƒ«é€ä¿¡æ©Ÿèƒ½ã¯å»ƒæ­¢ã•ã‚Œã¾ã—ãŸã€‚', ui.ButtonSet.OK);
}

function updateClubInfo() {
  const ui = SpreadsheetApp.getUi();
  ui.alert('æƒ…å ±', 'è¨­å®šã‚·ãƒ¼ãƒˆã‚’ç›´æ¥ç·¨é›†ã—ã¦ãã ã•ã„ã€‚', ui.ButtonSet.OK);
}