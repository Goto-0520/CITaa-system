# =============================================================================
# ã‚»ãƒ«1: ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¨ãƒ•ã‚©ãƒ³ãƒˆè¨­å®šï¼ˆä¿®æ­£ç‰ˆï¼‰
# =============================================================================
print("å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­...")
!pip install openpyxl msoffcrypto-tool reportlab PyPDF2 pillow -q
print("âœ“ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Œäº†")

import os

print("\næ—¥æœ¬èªãƒ•ã‚©ãƒ³ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸­...")
FONT_PATH = None
FONT_NAME_DISPLAY = None

try:
    # æ–¹æ³•1: Noto Sans JPã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
    print("[è©¦è¡Œ1] Noto Sans JP ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸­...")
    !wget -q https://github.com/google/fonts/raw/main/ofl/notosansjp/NotoSansJP%5Bwght%5D.ttf -O NotoSansJP.ttf

    if os.path.exists('NotoSansJP.ttf') and os.path.getsize('NotoSansJP.ttf') > 100000:
        FONT_PATH = 'NotoSansJP.ttf'
        FONT_NAME_DISPLAY = "Noto Sans JP"
        print(f"âœ“ {FONT_NAME_DISPLAY} ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†")
    else:
        # æ–¹æ³•2: IPAãƒ•ã‚©ãƒ³ãƒˆï¼ˆåˆ¥URLï¼‰
        print("\n[è©¦è¡Œ2] IPAã‚´ã‚·ãƒƒã‚¯ ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸­...")
        !wget -q https://moji.or.jp/wp-content/ipafont/IPAfont/ipag.ttf -O ipag.ttf

        if os.path.exists('ipag.ttf') and os.path.getsize('ipag.ttf') > 100000:
            FONT_PATH = 'ipag.ttf'
            FONT_NAME_DISPLAY = "IPAã‚´ã‚·ãƒƒã‚¯"
            print(f"âœ“ {FONT_NAME_DISPLAY} ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†")
        else:
            # æ–¹æ³•3: Google Fonts APIçµŒç”±
            print("\n[è©¦è¡Œ3] Google Fonts ã‹ã‚‰ Noto Sans JP ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸­...")
            !wget -q "https://fonts.google.com/download?family=Noto%20Sans%20JP" -O notosans.zip
            !unzip -q -o notosans.zip -d notosans_fonts

            # TTFãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¢ã™
            import glob
            ttf_files = glob.glob('notosans_fonts/*.ttf')
            if ttf_files:
                FONT_PATH = ttf_files[0]
                FONT_NAME_DISPLAY = "Noto Sans JP (Google Fonts)"
                print(f"âœ“ {FONT_NAME_DISPLAY} ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†")
            else:
                print("\nâœ— ã™ã¹ã¦ã®ãƒ•ã‚©ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—")
                print("ã‚·ã‚¹ãƒ†ãƒ ãƒ•ã‚©ãƒ³ãƒˆã‚’æ¤œç´¢ã—ã¾ã™...")

                # ã‚·ã‚¹ãƒ†ãƒ ãƒ•ã‚©ãƒ³ãƒˆã‚’æ¢ã™
                system_fonts = [
                    '/usr/share/fonts/truetype/liberation/LiberationSans-Regular.ttf',
                    '/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf'
                ]
                for font_path in system_fonts:
                    if os.path.exists(font_path):
                        FONT_PATH = font_path
                        FONT_NAME_DISPLAY = os.path.basename(font_path)
                        print(f"âœ“ ã‚·ã‚¹ãƒ†ãƒ ãƒ•ã‚©ãƒ³ãƒˆ {FONT_NAME_DISPLAY} ã‚’ä½¿ç”¨")
                        break

                if not FONT_PATH:
                    print("ä»£æ›¿ãƒ•ã‚©ãƒ³ãƒˆ(Helvetica)ã‚’ä½¿ç”¨ã—ã¾ã™ - æ—¥æœ¬èªã¯æ­£ã—ãè¡¨ç¤ºã•ã‚Œã¾ã›ã‚“")
                    FONT_NAME_DISPLAY = "Helvetica (è‹±æ•°å­—ã®ã¿)"

except Exception as e:
    print(f"\nâœ— ãƒ•ã‚©ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼: {e}")
    print("ä»£æ›¿ãƒ•ã‚©ãƒ³ãƒˆ(Helvetica)ã‚’ä½¿ç”¨ã—ã¾ã™")
    FONT_PATH = None
    FONT_NAME_DISPLAY = "Helvetica (è‹±æ•°å­—ã®ã¿)"

print(f"\nä½¿ç”¨ãƒ•ã‚©ãƒ³ãƒˆ: {FONT_NAME_DISPLAY}")
print("-" * 60)

# =============================================================================
# ã‚»ãƒ«2: ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰è¨­å®šæƒ…å ±ã‚’èª­ã¿è¾¼ã¿ï¼ˆGoogle Sheets APIç‰ˆï¼‰
# =============================================================================

print("=" * 60)
print("Google Sheets APIã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—")
print("=" * 60)

# å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
print("ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­...")
!pip install gspread google-auth google-auth-oauthlib google-auth-httplib2 -q
print("âœ“ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Œäº†\n")

from google.colab import auth
import gspread
from google.auth import default
import pandas as pd

print("Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆèªè¨¼ã‚’é–‹å§‹ã—ã¾ã™...")
print("ãƒ–ãƒ©ã‚¦ã‚¶ã§ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒè¡¨ç¤ºã•ã‚ŒãŸã‚‰ã€è¨±å¯ã—ã¦ãã ã•ã„ã€‚")

# Google Colabèªè¨¼
auth.authenticate_user()

# èªè¨¼æƒ…å ±ã‚’å–å¾—
creds, _ = default()

# gspreadã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ä½œæˆ
gc = gspread.authorize(creds)
print("âœ“ èªè¨¼å®Œäº†\n")

print("=" * 60)
print("è¨­å®šæƒ…å ±ã®èª­ã¿è¾¼ã¿")
print("=" * 60)

# ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆID
SPREADSHEET_ID = "1dYTBTmpI6xY8HH5uaxmDClgMCwkJD6F_5knav75n8Ks"

try:
    print("\nè¨­å®šæƒ…å ±ã‚’èª­ã¿è¾¼ã¿ä¸­...")

    # ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’é–‹ã
    spreadsheet = gc.open_by_key(SPREADSHEET_ID)
    print(f"âœ“ ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆæ¥ç¶šæˆåŠŸ: {spreadsheet.title}")

    # ã‚·ãƒ¼ãƒˆå
    sheet_names = {
        'required': 'å¿…è¦é …ç›®ä¸€è¦§',
        'password': 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ä¸€è¦§',
        'advisor': 'é¡§å•ä¸€è¦§'
    }

    # å¿…è¦é …ç›®ã‚·ãƒ¼ãƒˆ
    print(f"\n  - {sheet_names['required']}ã‚’èª­ã¿è¾¼ã¿ä¸­...")
    worksheet_required = spreadsheet.worksheet(sheet_names['required'])
    data_required = worksheet_required.get_all_values()
    df_required = pd.DataFrame(data_required[1:], columns=data_required[0])
    print(f"    âœ“ {len(df_required)}è¡Œèª­ã¿è¾¼ã¿å®Œäº†")
    print(f"    åˆ—å: {list(df_required.columns)}")

    REQUIRED_COLUMNS = {}
    for _, row in df_required.iterrows():
        club_name = str(row['å›£ä½“å']).strip()
        if pd.isna(club_name) or club_name == '' or club_name == 'nan':
            continue

        cols = []
        # ãƒã‚§ãƒƒã‚¯ãƒãƒ¼ã‚¯ã®åˆ¤å®šï¼ˆâœ“ã€TRUEã€â—‹ã€1ãªã©ï¼‰
        if str(row.get('å­¦ç”Ÿæºå¸¯ç•ªå·', '')).strip() in ['âœ“', 'TRUE', 'â—‹', 'True', 'true', '1', 'TRUE()']:
            cols.append('å­¦ç”Ÿæºå¸¯ç•ªå·')
        if str(row.get('ä¿è¨¼äººæºå¸¯ç•ªå·', '')).strip() in ['âœ“', 'TRUE', 'â—‹', 'True', 'true', '1', 'TRUE()']:
            cols.append('ä¿è¨¼äººæºå¸¯')
        if str(row.get('ä½æ‰€', '')).strip() in ['âœ“', 'TRUE', 'â—‹', 'True', 'true', '1', 'TRUE()']:
            cols.append('ä½æ‰€')

        REQUIRED_COLUMNS[club_name] = cols

    # ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ä¸€è¦§ã‚·ãƒ¼ãƒˆ
    print(f"\n  - {sheet_names['password']}ã‚’èª­ã¿è¾¼ã¿ä¸­...")
    worksheet_password = spreadsheet.worksheet(sheet_names['password'])
    data_password = worksheet_password.get_all_values()
    df_password = pd.DataFrame(data_password[1:], columns=data_password[0])
    print(f"    âœ“ {len(df_password)}è¡Œèª­ã¿è¾¼ã¿å®Œäº†")
    print(f"    åˆ—å: {list(df_password.columns)}")

    PDF_PASSWORDS = {}
    for _, row in df_password.iterrows():
        club_name = str(row['å›£ä½“å']).strip()
        password = str(row['ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰']).strip()
        if pd.notna(club_name) and pd.notna(password) and club_name != '' and club_name != 'nan' and password != 'nan':
            PDF_PASSWORDS[club_name] = password

    # é¡§å•ä¸€è¦§ã‚·ãƒ¼ãƒˆï¼ˆä¿®æ­£ç‰ˆï¼šé¡§å•å„ªå…ˆã€ãªã‘ã‚Œã°éƒ¨é•·ï¼‰
    print(f"\n  - {sheet_names['advisor']}ã‚’èª­ã¿è¾¼ã¿ä¸­...")
    worksheet_advisor = spreadsheet.worksheet(sheet_names['advisor'])
    data_advisor = worksheet_advisor.get_all_values()
    df_advisor = pd.DataFrame(data_advisor[1:], columns=data_advisor[0])
    print(f"    âœ“ {len(df_advisor)}è¡Œèª­ã¿è¾¼ã¿å®Œäº†")
    print(f"    åˆ—å: {list(df_advisor.columns)}")

    ADVISORS = {}
    for _, row in df_advisor.iterrows():
        club_name = str(row['å›£ä½“å']).strip()
        if pd.isna(club_name) or club_name == '' or club_name == 'nan':
            continue

        # é¡§å•å„ªå…ˆã€ãªã‘ã‚Œã°éƒ¨é•·
        advisor_name = None
        if pd.notna(row.get('é¡§å•', '')) and str(row['é¡§å•']).strip() and str(row['é¡§å•']).strip() != 'nan':
            advisor_name = f"é¡§å•:{str(row['é¡§å•']).strip()}"
        elif pd.notna(row.get('éƒ¨é•·', '')) and str(row['éƒ¨é•·']).strip() and str(row['éƒ¨é•·']).strip() != 'nan':
            advisor_name = f"éƒ¨é•·:{str(row['éƒ¨é•·']).strip()}"

        if advisor_name:
            ADVISORS[club_name] = advisor_name

    print(f"\nâœ“ è¨­å®šæƒ…å ±èª­ã¿è¾¼ã¿å®Œäº†")
    print(f"  - å›£ä½“æ•°: {len(REQUIRED_COLUMNS)}å€‹")
    print(f"  - ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®šæ•°: {len(PDF_PASSWORDS)}å€‹")
    print(f"  - é¡§å•æƒ…å ±æ•°: {len(ADVISORS)}å€‹")

    # ã‚µãƒ³ãƒ—ãƒ«è¡¨ç¤ºï¼ˆæœ€åˆã®3å›£ä½“ï¼‰
    print(f"\nã€ã‚µãƒ³ãƒ—ãƒ«ç¢ºèªã€‘æœ€åˆã®3å›£ä½“:")
    for i, (club, cols) in enumerate(list(REQUIRED_COLUMNS.items())[:3]):
        print(f"  {i+1}. {club}")
        print(f"     è¿½åŠ é …ç›®: {', '.join(cols) if cols else 'ãªã—'}")
        print(f"     ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰: {'è¨­å®šæ¸ˆã¿' if club in PDF_PASSWORDS else 'æœªè¨­å®š'}")
        advisor_text = ADVISORS.get(club, 'æœªè¨­å®š')
        print(f"     é¡§å•: {advisor_text}")

except gspread.exceptions.WorksheetNotFound as e:
    print(f"\nâœ— ã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: {e}")
    print("\nã€ç¢ºèªäº‹é …ã€‘")
    print("ã‚·ãƒ¼ãƒˆåãŒä»¥ä¸‹ã¨å®Œå…¨ä¸€è‡´ã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„:")
    print("  - å¿…è¦é …ç›®ä¸€è¦§")
    print("  - ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ä¸€è¦§")
    print("  - é¡§å•ä¸€è¦§")
    REQUIRED_COLUMNS = {}
    PDF_PASSWORDS = {}
    ADVISORS = {}

except gspread.exceptions.SpreadsheetNotFound as e:
    print(f"\nâœ— ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: {e}")
    print("\nã€ç¢ºèªäº‹é …ã€‘")
    print("1. ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆIDãŒæ­£ã—ã„ã‹ç¢ºèªã—ã¦ãã ã•ã„")
    print("2. ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®å…±æœ‰è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„")
    print("   - ã€Œãƒªãƒ³ã‚¯ã‚’çŸ¥ã£ã¦ã„ã‚‹å…¨å“¡ãŒé–²è¦§å¯ã€ã«ãªã£ã¦ã„ã‚‹ã‹")
    REQUIRED_COLUMNS = {}
    PDF_PASSWORDS = {}
    ADVISORS = {}

except Exception as e:
    print(f"\nâœ— è¨­å®šæƒ…å ±èª­ã¿è¾¼ã¿å¤±æ•—: {e}")
    print("\nã€ã‚¨ãƒ©ãƒ¼è©³ç´°ã€‘")
    import traceback
    traceback.print_exc()

    print("\nã€ç¢ºèªäº‹é …ã€‘")
    print("1. èªè¨¼ãŒæ­£å¸¸ã«å®Œäº†ã—ãŸã‹")
    print("2. ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆIDãŒæ­£ã—ã„ã‹")
    print("3. ã‚·ãƒ¼ãƒˆåãŒæ­£ã—ã„ã‹")
    print("4. åˆ—åãŒä»¥ä¸‹ã¨å®Œå…¨ä¸€è‡´ã—ã¦ã„ã‚‹ã‹:")
    print("   - å¿…è¦é …ç›®ä¸€è¦§: å›£ä½“å, å­¦ç”Ÿæºå¸¯ç•ªå·, ä¿è¨¼äººæºå¸¯ç•ªå·, ä½æ‰€")
    print("   - ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ä¸€è¦§: å›£ä½“å, ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰")
    print("   - é¡§å•ä¸€è¦§: å›£ä½“å, éƒ¨é•·, é¡§å•, ç›£ç£, ã‚³ãƒ¼ãƒ")

    REQUIRED_COLUMNS = {}
    PDF_PASSWORDS = {}
    ADVISORS = {}

# =============================================================================
# ã‚»ãƒ«3: ãƒ¡ã‚¤ãƒ³å‡¦ç† - PDFç”Ÿæˆï¼ˆä¿®æ­£ç‰ˆv4.6 - PDFè¡¨ç¤ºåå¤‰æ›å¯¾å¿œï¼‰
# =============================================================================
import io
import os
import zipfile
import re
import unicodedata
import base64
from datetime import datetime
from xml.sax.saxutils import escape as xml_escape
from google.colab import files as colab_files
from google.colab import output
from openpyxl import load_workbook
import msoffcrypto
from reportlab.lib import colors
from reportlab.lib.pagesizes import A4, landscape, portrait
from reportlab.lib.units import mm
from reportlab.pdfbase import pdfmetrics
from reportlab.pdfbase.ttfonts import TTFont
from reportlab.pdfbase.pdfmetrics import stringWidth
from reportlab.platypus import SimpleDocTemplate, Table, TableStyle, Spacer, Paragraph, Flowable
from reportlab.lib.styles import getSampleStyleSheet, ParagraphStyle
from PyPDF2 import PdfReader, PdfWriter
from IPython.display import display, HTML
import json

# ãƒ•ã‚©ãƒ³ãƒˆç™»éŒ²ï¼ˆä¿®æ­£ç‰ˆï¼‰
FONT_NAME = 'Helvetica'
if FONT_PATH and os.path.exists(FONT_PATH):
    try:
        pdfmetrics.registerFont(TTFont('JapaneseFont', FONT_PATH))
        FONT_NAME = 'JapaneseFont'
        print(f"âœ“ {FONT_NAME_DISPLAY} ãƒ•ã‚©ãƒ³ãƒˆç™»éŒ²æˆåŠŸ")
    except Exception as e:
        print(f"âš  ãƒ•ã‚©ãƒ³ãƒˆç™»éŒ²ã‚¨ãƒ©ãƒ¼: {e}")
        print("Helveticaã‚’ä½¿ç”¨ã—ã¾ã™ï¼ˆæ—¥æœ¬èªè¡¨ç¤ºã«å•é¡ŒãŒã‚ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ï¼‰")

# ä½™ç™½è¨­å®š(mm) - ç¸®å°
MARGIN = {'left': 8, 'right': 8, 'top': 10, 'bottom': 10}

# ---------------------------------------------------------------------------
# PDFè¡¨ç¤ºåã®å¤‰æ›è¾æ›¸ï¼ˆã‚·ãƒ¼ãƒˆåã®æ­£è¦åŒ–å¾Œ â†’ PDFè¡¨ç¤ºåï¼‰
# ã“ã“ã«ç™»éŒ²ã—ãŸå›£ä½“ã¯ã€PDFå‡ºåŠ›æ™‚ã«ã‚¿ã‚¤ãƒˆãƒ«ã¨ãƒ•ã‚¡ã‚¤ãƒ«åãŒå¤‰æ›ã•ã‚Œã‚‹
# ---------------------------------------------------------------------------
PDF_DISPLAY_NAMES = {
    'é‡çƒ': 'ç¡¬å¼é‡çƒéƒ¨',
}

# ---------------------------------------------------------------------------
# 1è¡Œå¼·åˆ¶æç”»ç”¨ã‚«ã‚¹ã‚¿ãƒ Flowable
# ---------------------------------------------------------------------------
class SingleLineText(Flowable):
    """ãƒ†ã‚­ã‚¹ãƒˆã‚’å¿…ãš1è¡Œã§æç”»ã™ã‚‹Flowableï¼ˆåˆ—å¹…ã«åˆã‚ã›ã¦ãƒ•ã‚©ãƒ³ãƒˆç¸®å°ï¼‰"""

    def __init__(self, text, font_name, max_fs=7, min_fs=2.0, padding=2):
        super().__init__()
        self.text = text
        self.font_name = font_name
        self.max_fs = max_fs
        self.min_fs = min_fs
        self.padding = padding
        self._fs = max_fs

    def wrap(self, availWidth, availHeight):
        usable = availWidth - self.padding * 2
        tw = stringWidth(self.text, self.font_name, self.max_fs)

        if tw <= usable:
            self._fs = self.max_fs
        else:
            self._fs = max(self.min_fs, self.max_fs * usable / tw)

        self.width = availWidth
        self.height = self._fs + 2
        return (self.width, self.height)

    def draw(self):
        self.canv.setFont(self.font_name, self._fs)
        self.canv.drawString(self.padding, 1, self.text)


def get_pdf_display_name(sheet_name):
    """ã‚·ãƒ¼ãƒˆåã‹ã‚‰PDFè¡¨ç¤ºç”¨ã®å›£ä½“åã‚’å–å¾—"""
    normalized = normalize_club_name(sheet_name)
    if normalized in PDF_DISPLAY_NAMES:
        return PDF_DISPLAY_NAMES[normalized]
    # å¤‰æ›ä¸è¦ãªã‚‰ã‚·ãƒ¼ãƒˆåãã®ã¾ã¾
    return sheet_name

def normalize_club_name(name):
    """å›£ä½“åã‚’æ­£è¦åŒ–ï¼ˆéƒ¨ãƒ»åŒå¥½ä¼šãƒ»æ„›å¥½ä¼šã‚’é™¤å»ï¼‰"""
    suffixes = ['éƒ¨', 'åŒå¥½ä¼š', 'æ„›å¥½ä¼š', 'ã‚µãƒ¼ã‚¯ãƒ«']
    normalized = name.strip()
    for suffix in suffixes:
        if normalized.endswith(suffix):
            normalized = normalized[:-len(suffix)]
    return normalized

# å›£ä½“åã®ã‚¨ã‚¤ãƒªã‚¢ã‚¹ï¼ˆã‚·ãƒ¼ãƒˆå â†’ è¨­å®šåï¼‰
CLUB_NAME_ALIASES = {
    'é‡çƒ': 'ç¡¬å¼é‡çƒ',
}

def find_matching_club_name(sheet_name, config_dict):
    """ã‚·ãƒ¼ãƒˆåã«å¯¾å¿œã™ã‚‹è¨­å®šåã‚’æ¤œç´¢"""
    if sheet_name in config_dict:
        return sheet_name

    normalized_sheet = normalize_club_name(sheet_name)
    for config_name in config_dict.keys():
        normalized_config = normalize_club_name(config_name)
        if normalized_sheet == normalized_config:
            return config_name

    # ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã§æ¤œç´¢
    alias = CLUB_NAME_ALIASES.get(normalized_sheet)
    if alias:
        for config_name in config_dict.keys():
            if normalize_club_name(config_name) == alias:
                return config_name

    return None

def find_header_row(ws):
    """ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’è‡ªå‹•æ¤œå‡º"""
    for row_idx in range(1, min(11, ws.max_row + 1)):
        row = list(ws[row_idx])
        row_values = [str(cell.value).strip() if cell.value else '' for cell in row]

        header_keywords = ['å½¹è·', 'å­¦ç±', 'æ°å', 'ã‚«ãƒŠ']
        if any(any(keyword in val for keyword in header_keywords) for val in row_values):
            return row_idx

    return 2

def decrypt_excel(encrypted_file_path, password):
    """ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ä»˜ãExcelãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¾©å·åŒ–"""
    decrypted = io.BytesIO()
    with open(encrypted_file_path, 'rb') as f:
        office_file = msoffcrypto.OfficeFile(f)
        office_file.load_key(password=password)
        office_file.decrypt(decrypted)
    decrypted.seek(0)
    return decrypted

def decrypt_excel_from_bytes(file_bytes, password):
    """ãƒã‚¤ãƒˆãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ä»˜ãExcelãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¾©å·åŒ–"""
    decrypted = io.BytesIO()
    encrypted_stream = io.BytesIO(file_bytes)
    office_file = msoffcrypto.OfficeFile(encrypted_stream)
    office_file.load_key(password=password)
    office_file.decrypt(decrypted)
    decrypted.seek(0)
    return decrypted

def should_include_column(club_name, column_name):
    """å›£ä½“ã«å¿œã˜ã¦åˆ—ã‚’å«ã‚ã‚‹ã‹åˆ¤å®š"""
    matched_name = find_matching_club_name(club_name, REQUIRED_COLUMNS)
    required = REQUIRED_COLUMNS.get(matched_name, []) if matched_name else []

    col_str = str(column_name).strip()

    base_keywords = ['å­¦ç±', 'å­¦å¹´', 'æ°å', 'ã‚«ãƒŠ', 'æ€§åˆ¥', 'ç”Ÿå¹´æœˆæ—¥']
    if any(keyword in col_str for keyword in base_keywords):
        return True

    if 'æºå¸¯' in col_str or 'é›»è©±' in col_str:
        if 'ä¿è¨¼äºº' not in col_str and 'å­¦ç”Ÿæºå¸¯ç•ªå·' in required:
            return True
        if 'ä¿è¨¼äºº' in col_str and 'ä¿è¨¼äººæºå¸¯' in required:
            return True

    if 'éƒµä¾¿' in col_str and 'ä½æ‰€' in required:
        return True

    if 'ä½æ‰€' in col_str and 'ä½æ‰€' in required:
        return True

    return False

def convert_to_halfwidth(text):
    """å…¨è§’è‹±æ•°å­—ãƒ»ã‚«ãƒŠã‚’åŠè§’ã«å¤‰æ›"""
    if text is None or text == '':
        return ''
    return unicodedata.normalize('NFKC', str(text))

def format_phone_number(phone):
    """é›»è©±ç•ªå·ã‹ã‚‰ãƒã‚¤ãƒ•ãƒ³ã‚’å‰Šé™¤ã—ã€åŠè§’ã«å¤‰æ›"""
    if phone is None or phone == '':
        return ''
    phone_str = convert_to_halfwidth(str(phone))
    return phone_str.replace('-', '').replace('ãƒ¼', '')

def format_postal_code(postal):
    """éƒµä¾¿ç•ªå·ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆåŠè§’å¤‰æ›ã€ãƒã‚¤ãƒ•ãƒ³çµ±ä¸€ï¼‰"""
    if postal is None or postal == '':
        return ''
    postal_str = convert_to_halfwidth(str(postal)).strip()
    digits = re.sub(r'[^0-9]', '', postal_str)
    if len(digits) == 7:
        return f"{digits[:3]}-{digits[3:]}"
    return postal_str

def format_birthdate(date_value):
    """ç”Ÿå¹´æœˆæ—¥ã‚’ YYYY/MM/DD å½¢å¼ã«å¤‰æ›ï¼ˆåŠè§’ï¼‰"""
    if date_value is None or date_value == '':
        return ''

    date_str = str(date_value)

    if hasattr(date_value, 'strftime'):
        return date_value.strftime('%Y/%m/%d')

    match = re.match(r'(\d{4})-(\d{2})-(\d{2})', date_str)
    if match:
        return f"{match.group(1)}/{match.group(2)}/{match.group(3)}"

    if re.match(r'\d{4}/\d{2}/\d{2}', date_str):
        return date_str.split()[0]

    return convert_to_halfwidth(date_str)

def check_required_roles(ws, header_row_idx, role_col_idx, club_name):
    """å½¹è·åç§°ã«ã€Œä¸»å°†ã€ã¾ãŸã¯ã€Œä¼šè¨ˆã€ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯"""
    if role_col_idx is None:
        return {'has_captain': False, 'has_accountant': False, 'roles': []}

    has_captain = False
    has_accountant = False
    all_roles = []

    for row in ws.iter_rows(min_row=header_row_idx + 1, values_only=True):
        if not row or not any(row):
            break

        if role_col_idx < len(row) and row[role_col_idx]:
            role_value = str(row[role_col_idx]).strip()

            if role_value and role_value != 'éƒ¨å“¡':
                all_roles.append(role_value)

                if 'ä¸»å°†' in role_value:
                    has_captain = True
                if 'ä¼šè¨ˆ' in role_value:
                    has_accountant = True

    return {
        'has_captain': has_captain,
        'has_accountant': has_accountant,
        'roles': all_roles
    }

def create_fitted_cell(text_str, col_width, font_name, max_fs=7, min_fs=2.0):
    """ãƒ†ã‚­ã‚¹ãƒˆã‚’å¿…ãš1è¡Œã«åã‚ã‚‹SingleLineTextã‚’è¿”ã™"""
    if not text_str or str(text_str).strip() == '':
        return ''
    return SingleLineText(str(text_str), font_name, max_fs=max_fs, min_fs=min_fs)

def calculate_column_widths(headers, data_raw, page_width):
    """å„åˆ—ã®å†…å®¹ã«åŸºã¥ã„ã¦æœ€é©ãªåˆ—å¹…ã‚’è¨ˆç®—"""
    def char_width(text):
        text_str = str(text)
        width = 0
        for char in text_str:
            if ord(char) > 0x7F:
                width += 2
            else:
                width += 1
        return width

    max_widths = []
    for col_idx in range(len(headers)):
        max_width = char_width(headers[col_idx])
        for row in data_raw[1:]:
            if col_idx < len(row):
                max_width = max(max_width, char_width(row[col_idx]))
        max_widths.append(max_width)

    col_widths = []

    for i, (header, max_width) in enumerate(zip(headers, max_widths)):
        if header == '':
            if i == 0:
                width = 18
            else:
                width = 15
        elif 'å½¹è·' in header:
            width = max(40, min(60, max_width * 4))
        elif 'å­¦ç±' in header:
            width = 42
        elif 'å­¦å¹´' in header:
            width = 25
        elif 'æ°å' in header and 'ã‚«ãƒŠ' not in header:
            width = max(50, min(70, max_width * 4))
        elif 'ã‚«ãƒŠ' in header:
            width = max(60, min(80, max_width * 3.5))
        elif 'æ€§åˆ¥' in header:
            width = 25
        elif 'ç”Ÿå¹´æœˆæ—¥' in header:
            width = 50
        elif 'éƒµä¾¿' in header:
            width = 45
        elif 'æºå¸¯' in header or 'é›»è©±' in header:
            width = 60
        elif 'ä½æ‰€' in header:
            width = max(120, min(180, max_width * 3.5))
        else:
            width = max(40, min(90, max_width * 4))

        col_widths.append(width)

    total_width = sum(col_widths)
    if total_width > page_width:
        scale = page_width / total_width
        for i, header in enumerate(headers):
            if 'æºå¸¯' in header or 'é›»è©±' in header:
                col_widths[i] = max(55, col_widths[i] * scale)
            elif 'å­¦ç±' in header:
                col_widths[i] = max(38, col_widths[i] * scale)
            elif 'éƒµä¾¿' in header:
                col_widths[i] = max(38, col_widths[i] * scale)
            else:
                col_widths[i] = col_widths[i] * scale

        excess = sum(col_widths) - page_width
        if excess > 0:
            for i, header in enumerate(headers):
                if 'ä½æ‰€' in header:
                    col_widths[i] = max(80, col_widths[i] - excess)
                    break

    return col_widths

def create_pdf_from_sheet(ws, club_name, output_path):
    """ã‚·ãƒ¼ãƒˆã‹ã‚‰PDFã‚’ç”Ÿæˆï¼ˆç”¨ç´™ã®å‘ãã¯é …ç›®æ•°ã§åˆ¤æ–­ï¼‰"""
    # PDFè¡¨ç¤ºåã‚’å–å¾—ï¼ˆã‚·ãƒ¼ãƒˆåã¨ç•°ãªã‚‹å ´åˆãŒã‚ã‚‹ï¼‰
    display_name = get_pdf_display_name(club_name)
    if display_name != club_name:
        print(f"    è¡¨ç¤ºåå¤‰æ›: {club_name} â†’ {display_name}")

    header_row_idx = find_header_row(ws)
    print(f"    ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ: {header_row_idx}è¡Œç›®")

    original_headers = []
    header_indices = []
    role_col_idx = None
    gakuseki_col_idx = None
    address_col_idx = None
    address_merge_cols = []
    address_display_name = None
    postal_col_idx = None

    for idx, cell in enumerate(ws[header_row_idx]):
        if cell.value:
            col_name = str(cell.value).strip()
            original_headers.append(col_name)
            header_indices.append(idx)

            if 'å½¹è·' in col_name:
                role_col_idx = idx
            if 'å­¦ç±' in col_name:
                gakuseki_col_idx = idx
            if 'ä½æ‰€' in col_name and address_col_idx is None:
                address_col_idx = idx
            if 'éƒµä¾¿' in col_name:
                postal_col_idx = idx

    if role_col_idx is None and gakuseki_col_idx is not None and gakuseki_col_idx > 0:
        role_col_idx = gakuseki_col_idx - 1
        print(f"    å½¹è·åˆ—ã‚’è‡ªå‹•æ¤œå‡º: {role_col_idx}åˆ—ç›®ï¼ˆå­¦ç±ç•ªå·ã®å·¦éš£ï¼‰")

    role_check = check_required_roles(ws, header_row_idx, role_col_idx, club_name)
    is_honbu = 'ä½“è‚²ä¼šæœ¬éƒ¨' in club_name

    if not is_honbu and (not role_check['has_captain'] or not role_check['has_accountant']):
        error_msg = f"    âš  å½¹è·ã‚¨ãƒ©ãƒ¼æ¤œå‡º:"
        if not role_check['has_captain']:
            error_msg += " ã€ä¸»å°†ã€‘ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        if not role_check['has_accountant']:
            error_msg += " ã€ä¼šè¨ˆã€‘ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        print(error_msg)
        print(f"       å›£ä½“å: {club_name}")
        print(f"       æ¤œå‡ºã•ã‚ŒãŸå½¹è·: {', '.join(role_check['roles'][:10])}")
        return {'error': error_msg, 'club_name': club_name, 'roles': role_check['roles']}

    # ä½æ‰€åˆ—ã®çµåˆå‡¦ç†
    if address_col_idx is not None:
        address_merge_cols = [address_col_idx]
        base_address_name = str(ws[header_row_idx][address_col_idx].value).strip()

        match = re.match(r'^(.+?)(\d+)$', base_address_name)
        if match:
            base_name = match.group(1)
            for offset in [1, 2]:
                next_idx = address_col_idx + offset
                if next_idx < len(ws[header_row_idx]):
                    next_cell = ws[header_row_idx][next_idx]
                    if next_cell.value:
                        next_name = str(next_cell.value).strip()
                        if next_name.startswith(base_name) and re.match(r'^.+?\d+$', next_name):
                            address_merge_cols.append(next_idx)

            if len(address_merge_cols) > 1:
                print(f"    ä½æ‰€åˆ—ã‚’çµåˆï¼ˆé€£ç•ªãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰: {len(address_merge_cols)}åˆ— - {base_name}1,2,3 â†’ {base_name}")
                address_display_name = base_name
        else:
            for offset in [1, 2]:
                next_idx = address_col_idx + offset
                if next_idx < len(ws[header_row_idx]):
                    next_cell = ws[header_row_idx][next_idx]
                    if not next_cell.value or str(next_cell.value).strip() == '':
                        address_merge_cols.append(next_idx)

            if len(address_merge_cols) > 1:
                print(f"    ä½æ‰€åˆ—ã‚’çµåˆï¼ˆç©ºç™½ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰: {len(address_merge_cols)}åˆ—ï¼ˆ{address_merge_cols}ï¼‰")

        if address_display_name is None:
            address_display_name = base_address_name

    # ä½æ‰€ãŒå¿…è¦ã‹ã©ã†ã‹ã‚’åˆ¤å®š
    matched_name = find_matching_club_name(club_name, REQUIRED_COLUMNS)
    required_cols = REQUIRED_COLUMNS.get(matched_name, []) if matched_name else []
    needs_address = 'ä½æ‰€' in required_cols

    # å‡ºåŠ›ç”¨ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’æ§‹ç¯‰
    output_headers = ['', '', 'å½¹è·åç§°']
    output_indices = [-1, -2, role_col_idx if role_col_idx is not None else -3]

    required_order = ['å­¦ç±', 'å­¦å¹´', 'æ°å', 'ã‚«ãƒŠ', 'æ€§åˆ¥', 'ç”Ÿå¹´æœˆæ—¥']

    for required_keyword in required_order:
        for idx, col_name in zip(header_indices, original_headers):
            if idx == role_col_idx:
                continue

            if required_keyword in col_name:
                if required_keyword == 'æ°å':
                    if 'ã‚«ãƒŠ' not in col_name and idx not in output_indices:
                        output_headers.append(col_name)
                        output_indices.append(idx)
                        break
                else:
                    if idx not in output_indices:
                        output_headers.append(col_name)
                        output_indices.append(idx)
                        break

    # éƒµä¾¿ç•ªå·åˆ—ã‚’è¿½åŠ ï¼ˆä½æ‰€ãŒå¿…è¦ãªå›£ä½“ã®ã¿ï¼‰
    if needs_address and postal_col_idx is not None:
        for idx, col_name in zip(header_indices, original_headers):
            if 'éƒµä¾¿' in col_name and idx not in output_indices:
                output_headers.append(col_name)
                output_indices.append(idx)
                print(f"    éƒµä¾¿ç•ªå·åˆ—ã‚’æ¤œå‡º: '{col_name}'")
                break

    # ä½æ‰€åˆ—ã‚’è¿½åŠ 
    if needs_address and address_col_idx is not None:
        if address_col_idx not in output_indices:
            if len(address_merge_cols) > 1:
                output_headers.append(address_display_name)
                output_indices.append(address_merge_cols)
            else:
                output_headers.append(address_display_name if address_display_name else str(ws[header_row_idx][address_col_idx].value).strip())
                output_indices.append(address_col_idx)

    # å­¦ç”Ÿã®æºå¸¯/é›»è©±åˆ—ã‚’è¿½åŠ 
    if 'å­¦ç”Ÿæºå¸¯ç•ªå·' in required_cols:
        for idx, col_name in zip(header_indices, original_headers):
            if idx in output_indices or idx == role_col_idx:
                continue
            if ('æºå¸¯' in col_name or 'é›»è©±' in col_name) and 'ä¿è¨¼äºº' not in col_name:
                output_headers.append(col_name)
                output_indices.append(idx)
                print(f"    å­¦ç”Ÿé›»è©±åˆ—ã‚’æ¤œå‡º: '{col_name}'")
                break

    # ãã®ä»–ã®å¿…è¦ãªåˆ—ã‚’è¿½åŠ ï¼ˆä¿è¨¼äººæºå¸¯/é›»è©±ãªã©ï¼‰
    for idx, col_name in zip(header_indices, original_headers):
        if idx in output_indices or idx == role_col_idx:
            continue

        if address_col_idx is not None and idx in address_merge_cols and idx != address_col_idx:
            continue

        if 'ä½æ‰€' in col_name:
            continue
        if 'éƒµä¾¿' in col_name:
            continue
        if ('æºå¸¯' in col_name or 'é›»è©±' in col_name) and 'ä¿è¨¼äºº' not in col_name:
            continue

        if should_include_column(club_name, col_name):
            output_headers.append(col_name)
            output_indices.append(idx)

    if len(output_headers) <= 3:
        raise ValueError(f"{club_name}: å‡ºåŠ›ã™ã‚‹åˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")

    has_address = any('ä½æ‰€' in h for h in output_headers)

    if has_address:
        page_size = landscape(A4)
        print(f"    ç”¨ç´™: A4æ¨ªå‘ãï¼ˆä½æ‰€åˆ—ã‚ã‚Šï¼‰")
    else:
        page_size = portrait(A4)
        print(f"    ç”¨ç´™: A4ç¸¦å‘ãï¼ˆä½æ‰€åˆ—ãªã—ï¼‰")

    page_settings = {
        'pagesize': page_size,
        'leftMargin': MARGIN['left']*mm,
        'rightMargin': MARGIN['right']*mm,
        'topMargin': MARGIN['top']*mm,
        'bottomMargin': MARGIN['bottom']*mm
    }

    doc = SimpleDocTemplate(output_path, **page_settings)

    print(f"    å‡ºåŠ›åˆ—æ•°: {len(output_headers)}åˆ—")
    print(f"    åˆ—æ§‹æˆ: {', '.join(output_headers[:12])}...")

    # ãƒ‡ãƒ¼ã‚¿å–å¾—
    data_raw = [output_headers]
    row_number = 1

    for row in ws.iter_rows(min_row=header_row_idx + 1, values_only=True):
        gakuseki_idx = None
        for i, h_idx in enumerate(output_indices):
            if isinstance(h_idx, int) and h_idx >= 0 and i < len(output_headers) and 'å­¦ç±' in output_headers[i]:
                gakuseki_idx = h_idx
                break

        if gakuseki_idx is not None and (not row[gakuseki_idx] or str(row[gakuseki_idx]).strip() == ''):
            break

        row_data = []
        for i, header_idx in enumerate(output_indices):
            if header_idx == -1:
                row_data.append(str(row_number))
            elif header_idx == -2:
                row_data.append('')
            elif header_idx == -3:
                row_data.append('éƒ¨å“¡')
            elif isinstance(header_idx, list):
                merged_values = []
                for col_idx in header_idx:
                    if col_idx < len(row) and row[col_idx]:
                        val = str(row[col_idx]).strip()
                        if val:
                            merged_values.append(val)
                merged_address = ' '.join(merged_values)
                row_data.append(convert_to_halfwidth(merged_address))
            else:
                cell_value = row[header_idx] if header_idx < len(row) else ''
                header_name = output_headers[i] if i < len(output_headers) else ''

                if 'å½¹è·' in header_name:
                    if not cell_value or str(cell_value).strip() == '':
                        row_data.append('éƒ¨å“¡')
                    else:
                        row_data.append(convert_to_halfwidth(str(cell_value)))
                elif 'æºå¸¯' in header_name or 'é›»è©±' in header_name:
                    row_data.append(format_phone_number(cell_value))
                elif 'éƒµä¾¿' in header_name:
                    row_data.append(format_postal_code(cell_value))
                elif 'ç”Ÿå¹´æœˆæ—¥' in header_name:
                    row_data.append(format_birthdate(cell_value))
                else:
                    formatted_value = convert_to_halfwidth(str(cell_value) if cell_value is not None else '')
                    row_data.append(formatted_value)

        data_raw.append(row_data)
        row_number += 1

    print(f"    ãƒ‡ãƒ¼ã‚¿è¡Œæ•°: {len(data_raw) - 1}è¡Œ")

    # åˆ—å¹…ã®è¨ˆç®—
    page_width = page_settings['pagesize'][0] - page_settings['leftMargin'] - page_settings['rightMargin']
    col_widths = calculate_column_widths(output_headers, data_raw, page_width)

    # ã¯ã¿å‡ºã—ã†ã‚‹åˆ—ã‚’SingleLineTextã«å¤‰æ›
    address_col_indices = [i for i, h in enumerate(output_headers) if 'ä½æ‰€' in h]
    name_col_indices = [i for i, h in enumerate(output_headers)
                        if ('æ°å' in h or 'ã‚«ãƒŠ' in h) and h != '']
    fit_col_indices = address_col_indices + name_col_indices

    data = []
    for row_idx, row in enumerate(data_raw):
        new_row = list(row)
        for col_idx in fit_col_indices:
            if col_idx < len(new_row):
                cell_text = str(new_row[col_idx])
                if cell_text.strip():
                    new_row[col_idx] = create_fitted_cell(
                        cell_text, col_widths[col_idx], FONT_NAME
                    )
        data.append(new_row)

    # ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¹ã‚¿ã‚¤ãƒ«
    style_commands = [
        ('FONT', (0, 0), (-1, -1), FONT_NAME, 7),
        ('GRID', (0, 0), (-1, -1), 0.5, colors.black),
        ('VALIGN', (0, 0), (-1, -1), 'MIDDLE'),
        ('ALIGN', (0, 0), (-1, -1), 'LEFT'),
        ('LEFTPADDING', (0, 0), (-1, -1), 2),
        ('RIGHTPADDING', (0, 0), (-1, -1), 2),
        ('TOPPADDING', (0, 0), (-1, -1), 2),
        ('BOTTOMPADDING', (0, 0), (-1, -1), 2),
    ]

    style = TableStyle(style_commands)

    table = Table(data, colWidths=col_widths, repeatRows=1)
    table.setStyle(style)

    # ã‚¿ã‚¤ãƒˆãƒ«æƒ…å ±ï¼ˆdisplay_nameã‚’ä½¿ç”¨ï¼‰
    update_date = datetime.now().strftime('%Yå¹´%mæœˆ%dæ—¥')
    matched_advisor_name = find_matching_club_name(club_name, ADVISORS)
    advisor_info = ADVISORS.get(matched_advisor_name, '') if matched_advisor_name else ''

    total_width = sum(col_widths)
    title_col_widths = [total_width * 0.7, total_width * 0.3]

    title_data = [
        [display_name, f"{update_date}æ›´æ–°"],
        [advisor_info, '']
    ]

    title_table = Table(title_data, colWidths=title_col_widths)
    title_table.setStyle(TableStyle([
        ('FONT', (0, 0), (-1, -1), FONT_NAME, 7),
        ('ALIGN', (0, 0), (0, -1), 'LEFT'),
        ('ALIGN', (1, 0), (1, 0), 'RIGHT'),
        ('VALIGN', (0, 0), (-1, -1), 'TOP'),
    ]))

    elements = [title_table, Spacer(1, 2*mm), table]
    doc.build(elements)

    return None

def add_password_to_pdf(input_pdf_path, output_pdf_path, password):
    """PDFã«ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®š"""
    reader = PdfReader(input_pdf_path)
    writer = PdfWriter()

    for page in reader.pages:
        writer.add_page(page)

    writer.encrypt(password)

    with open(output_pdf_path, 'wb') as output_file:
        writer.write(output_file)

def upload_file_with_drag_drop():
    """ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—å¯¾å¿œã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰UIï¼ˆeval_jsç‰ˆï¼‰"""

    upload_html = """
    <style>
        #drop-area {
            border: 3px dashed #4CAF50;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            background-color: #f9f9f9;
            margin: 20px 0;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        #drop-area:hover, #drop-area.highlight {
            background-color: #e8f5e9;
            border-color: #45a049;
        }
        #drop-area.highlight {
            background-color: #c8e6c9;
            border-style: solid;
        }
        .upload-icon {
            font-size: 60px;
            color: #4CAF50;
            margin-bottom: 20px;
        }
        .upload-title {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
        }
        .upload-instructions {
            font-size: 16px;
            color: #666;
            margin-bottom: 10px;
            line-height: 1.6;
        }
        .upload-note {
            font-size: 14px;
            color: #999;
            margin-top: 15px;
        }
        .highlight-text {
            color: #4CAF50;
            font-weight: bold;
        }
        #file-input {
            display: none;
        }
        #file-info {
            margin-top: 15px;
            padding: 10px;
            background-color: #e8f5e9;
            border-radius: 5px;
            display: none;
        }
        #file-info.show {
            display: block;
        }
        .success-icon {
            color: #4CAF50;
            font-size: 20px;
        }
    </style>

    <div id="drop-area">
        <div class="upload-icon">ğŸ“</div>
        <div class="upload-title">ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</div>
        <div class="upload-instructions">
            âœ… <span class="highlight-text">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã“ã“ã«ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—</span><br>
            ã¾ãŸã¯<br>
            âœ… <span class="highlight-text">ã“ã“ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</span>
        </div>
        <div class="upload-note">
            â€» Excelãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ.xlsxï¼‰ã‚’é¸æŠã—ã¦ãã ã•ã„<br>
            â€» ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ä¿è­·ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã«å¯¾å¿œã—ã¦ã„ã¾ã™
        </div>
        <input type="file" id="file-input" accept=".xlsx,.xls">
    </div>
    <div id="file-info">
        <span class="success-icon">âœ“</span> <span id="file-name"></span> ã‚’é¸æŠã—ã¾ã—ãŸ
    </div>
    """

    display(HTML(upload_html))

    js_code = """
    async function waitForFile() {
        return new Promise((resolve, reject) => {
            const dropArea = document.getElementById('drop-area');
            const fileInput = document.getElementById('file-input');
            const fileInfo = document.getElementById('file-info');
            const fileName = document.getElementById('file-name');

            function handleFile(file) {
                fileName.textContent = file.name;
                fileInfo.classList.add('show');

                const reader = new FileReader();
                reader.onload = function(e) {
                    const base64Data = e.target.result.split(',')[1];
                    resolve(JSON.stringify({name: file.name, data: base64Data}));
                };
                reader.onerror = function() {
                    reject('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼');
                };
                reader.readAsDataURL(file);
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                dropArea.addEventListener(eventName, (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    dropArea.classList.add('highlight');
                });
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    dropArea.classList.remove('highlight');
                });
            });

            dropArea.addEventListener('drop', (e) => {
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFile(files[0]);
                }
            });

            dropArea.addEventListener('click', () => {
                fileInput.click();
            });

            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFile(e.target.files[0]);
                }
            });
        });
    }
    waitForFile();
    """

    result = output.eval_js(js_code)

    if result:
        file_data = json.loads(result)
        file_bytes = base64.b64decode(file_data['data'])
        return file_data['name'], file_bytes
    else:
        return None, None


def main():
    print("=" * 60)
    print("å›£ä½“åˆ¥åç°¿PDFç”Ÿæˆï¼ˆä¿®æ­£ç‰ˆv4.6ï¼‰")
    print("=" * 60)

    print("\nã€ã‚¹ãƒ†ãƒƒãƒ—1ã€‘ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«(Excelãƒ•ã‚¡ã‚¤ãƒ«)ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„")

    excel_filename, file_bytes = upload_file_with_drag_drop()

    if not excel_filename or not file_bytes:
        print("âŒ ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ")
        return

    print(f"âœ“ {excel_filename} ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ")

    print("\nã€ã‚¹ãƒ†ãƒƒãƒ—2ã€‘ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...")
    wb = None
    excel_password = None
    try:
        wb = load_workbook(io.BytesIO(file_bytes))
        print("âœ“ ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿æˆåŠŸï¼ˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãªã—ï¼‰")
    except Exception:
        print("ğŸ”’ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ä¿è­·ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã§ã™")
        print("\nãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„")
        excel_password = input("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰: ")

        print("\nãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¾©å·åŒ–ã—ã¦ã„ã¾ã™...")
        try:
            decrypted_stream = decrypt_excel_from_bytes(file_bytes, excel_password)
            wb = load_workbook(decrypted_stream)
            print("âœ“ å¾©å·åŒ–æˆåŠŸ")
        except Exception as e:
            print(f"âœ— å¾©å·åŒ–å¤±æ•—: {e}")
            return

    if wb is None:
        print("âŒ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã‘ã¾ã›ã‚“ã§ã—ãŸ")
        return

    print(f"\nã€ã‚¹ãƒ†ãƒƒãƒ—3ã€‘æ¤œå‡ºã•ã‚ŒãŸã‚·ãƒ¼ãƒˆ: {len(wb.sheetnames)}å€‹")

    target_sheets = []
    match_details = []

    for sheet_name in wb.sheetnames:
        matched_required = find_matching_club_name(sheet_name, REQUIRED_COLUMNS)
        matched_password = find_matching_club_name(sheet_name, PDF_PASSWORDS)

        if matched_required and matched_password:
            target_sheets.append(sheet_name)
            match_details.append({
                'sheet': sheet_name,
                'matched_required': matched_required,
                'matched_password': matched_password
            })

    print(f"å‡¦ç†å¯¾è±¡: {len(target_sheets)}å€‹")

    if match_details:
        print("\nã€ãƒãƒƒãƒãƒ³ã‚°è©³ç´°ã€‘æœ€åˆã®5ä»¶:")
        for i, detail in enumerate(match_details[:5], 1):
            print(f"  {i}. ã‚·ãƒ¼ãƒˆ: {detail['sheet']}")
            print(f"     è¨­å®šå: {detail['matched_required']}")

    if not target_sheets:
        print("\nâš  å‡¦ç†ã™ã‚‹å›£ä½“ãŒã‚ã‚Šã¾ã›ã‚“")
        return

    print(f"\nã€ã‚¹ãƒ†ãƒƒãƒ—4ã€‘{len(target_sheets)}å€‹ã®å›£ä½“ã®PDFã‚’ç”Ÿæˆä¸­...")
    output_dir = "output_pdfs"
    os.makedirs(output_dir, exist_ok=True)

    generated_files = []
    failed_clubs = []
    role_error_clubs = []

    for i, sheet_name in enumerate(target_sheets, 1):
        print(f"\n  [{i}/{len(target_sheets)}] {sheet_name} ã‚’å‡¦ç†ä¸­...")
        try:
            ws = wb[sheet_name]

            temp_pdf = f"temp_{sheet_name.replace('/', '_')}.pdf"
            result = create_pdf_from_sheet(ws, sheet_name, temp_pdf)

            if result and isinstance(result, dict) and 'error' in result:
                role_error_clubs.append(result)
                print(f"  âš  å½¹è·ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚Šã¾ã™ãŒã€PDFç”Ÿæˆã‚’ç¶šè¡Œã—ã¾ã™")

            matched_password_name = find_matching_club_name(sheet_name, PDF_PASSWORDS)
            password = PDF_PASSWORDS[matched_password_name]

            # ãƒ•ã‚¡ã‚¤ãƒ«åã«ã‚‚PDFè¡¨ç¤ºåã‚’ä½¿ç”¨
            pdf_display_name = get_pdf_display_name(sheet_name)
            update_date = datetime.now().strftime('%Yå¹´%mæœˆ%dæ—¥')
            final_pdf = os.path.join(output_dir, f"{pdf_display_name.replace('/', '_')}_{update_date}.pdf")
            add_password_to_pdf(temp_pdf, final_pdf, password)

            generated_files.append(final_pdf)
            print(f"  âœ“ å®Œäº†")

            if os.path.exists(temp_pdf):
                os.remove(temp_pdf)

        except Exception as e:
            print(f"  âœ— ã‚¨ãƒ©ãƒ¼: {e}")
            import traceback
            traceback.print_exc()
            failed_clubs.append(sheet_name)

    print(f"\n{'=' * 60}")
    print(f"å‡¦ç†çµæœã‚µãƒãƒªãƒ¼")
    print(f"{'=' * 60}")
    print(f"æˆåŠŸ: {len(generated_files)}å€‹")
    print(f"å¤±æ•—: {len(failed_clubs)}å€‹")
    print(f"å½¹è·ã‚¨ãƒ©ãƒ¼: {len(role_error_clubs)}å€‹")

    if role_error_clubs:
        print(f"\n{'=' * 60}")
        print(f"âš  å½¹è·ã‚¨ãƒ©ãƒ¼è©³ç´°ï¼ˆä¸»å°†ã¾ãŸã¯ä¼šè¨ˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼‰")
        print(f"{'=' * 60}")
        for i, error_info in enumerate(role_error_clubs, 1):
            print(f"\n{i}. å›£ä½“å: {error_info['club_name']}")
            print(f"   ã‚¨ãƒ©ãƒ¼: {error_info['error']}")
            print(f"   æ¤œå‡ºã•ã‚ŒãŸå½¹è·: {', '.join(error_info['roles'][:10])}")

    if failed_clubs:
        print(f"\n{'=' * 60}")
        print(f"ã€å‡¦ç†å¤±æ•—ã—ãŸå›£ä½“ã€‘")
        print(f"{'=' * 60}")
        for club in failed_clubs:
            print(f"  - {club}")

    if generated_files:
        print(f"\nã€ã‚¹ãƒ†ãƒƒãƒ—5ã€‘{len(generated_files)}å€‹ã®PDFã‚’ZIPåœ§ç¸®ä¸­...")
        zip_filename = f"å›£ä½“åˆ¥åç°¿_{datetime.now().strftime('%Y%m%d')}.zip"

        with zipfile.ZipFile(zip_filename, 'w') as zipf:
            for pdf_file in generated_files:
                zipf.write(pdf_file, os.path.basename(pdf_file))

        print(f"âœ“ {zip_filename} ã‚’ä½œæˆã—ã¾ã—ãŸ")
        print("\nã€å®Œäº†ã€‘ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚’é–‹å§‹ã—ã¾ã™...")
        colab_files.download(zip_filename)

        print(f"\n{'=' * 60}")
        print(f"å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸ! {len(generated_files)}å€‹ã®PDFã‚’ç”Ÿæˆã—ã¾ã—ãŸ")
        if role_error_clubs:
            print(f"â€» {len(role_error_clubs)}å€‹ã®å›£ä½“ã§å½¹è·ã‚¨ãƒ©ãƒ¼ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸï¼ˆä¸Šè¨˜å‚ç…§ï¼‰")
        print(f"{'=' * 60}")
    else:
        print("\nâš  PDFãŒç”Ÿæˆã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ")

# å®Ÿè¡Œ
main()